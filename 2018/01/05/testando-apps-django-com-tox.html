<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>Testando apps Django com Tox | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="O Django 2.0 foi lançado, e com ele o suporte a Python 2.7 deixa de existir. Conheça o tox, uma poderosa ferramenta para executar testes em diferentes virtualenvs."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, testes, tdd, tox, django, python, virtualenv"><meta property=og:title content="Testando apps Django com Tox"><meta property=og:description content="O Django 2.0 foi lançado, e com ele o suporte a Python 2.7 deixa de existir. Conheça o tox, uma poderosa ferramenta para executar testes em diferentes virtualenvs."><meta property=og:url content=https://klauslaube.com.br/2018/01/05/testando-apps-django-com-tox.html><meta property=og:image content=https://klauslaube.com.br//images/blog/python-snakes.jpg><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2018/01/05/testando-apps-django-com-tox.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content=https://klauslaube.com.br//images/blog/python-snakes.jpg> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> Testando apps Django com Tox </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2018-01-05T17:05:00-02:00 itemprop=datePublished>05 Jan, 2018</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/django-logo.png alt="Logotipo do Django" class=representative-image width=180 height=180> <p>O <a href=https://docs.djangoproject.com/pt-br/2.0/releases/2.0/ title="Django 2.0 release notes"><em>Django 2.0</em></a> foi lançado, e com ele o suporte a <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre Python"><em>Python</em></a> <code>2.7</code> deixa de existir para as próximas versões do <em>framework</em>. Alegria para os usuários, preocupação para os desenvolvedores dos <a href=http://henriquebastos.net/desmistificando-o-conceito-de-django-apps/ title="Desmistificando O Conceito De Django Apps"><em>apps</em></a>. Afinal, a versão <code>1.11</code> é <em>LTS</em> (Long Term Support), logo, alguns <em>apps</em> (ainda) não podem abraçar incondicionalmente a versão <code>3.x</code> da linguagem.</p> <!-- PELICAN_END_SUMMARY --> <p>É nesse cenário que bibliotecas como o <a href=http://six.readthedocs.io/ title="Python 2 and 3 Compatibility Library"><em>six</em></a> e <a href=https://tox.readthedocs.io/en/latest/ title="Standardize testing in Python"><em>tox</em></a> mostram o seu valor. Nesse artigo, vamos falar um pouquinho mais sobre a última.</p> <h2>Antes de começar: Vida longa ao Python 3!</h2> <p>O <em>Python 2</em> estará aí por mais um tempo (até 2020). Portanto, qual a motivação para mudar para o <em>Python 3</em> agora?</p> <p>Na <a href=https://loadsmart.com/ title="Book a truck in seconds"><em>Loadsmart</em></a>, o nosso principal projeto é em <em>Python</em> <code>2.7</code>. Mas estamos experimentando <em>Python</em> <code>3.x</code> há um bom tempo em projetos paralelos. O fato é que a nova versão da linguagem está mais eficiente, possui suporte a assincronicidade, melhor controle de exceções e o fogo ardente do "unicode hell" foi controlado.</p> <p><img class=align-center-keep-size src=/images/blog/python-snakes.jpg width=640 height=400 title="Migrar para Python 3 pode parecer assustador. Mas é tranquilo, Indy..." alt="Migrar para Python 3 pode parecer assustador. Mas é tranquilo, Indy..."></p> <p>É verdade que há quebra de compatibilidade entre as versões, mas se considerarmos que a <code>2.7</code> só tem mais 2 anos de "vida", a urgência de migração fica mais latente.</p> <h2>tox é uma sacada das boas!</h2> <p>O site oficial da biblioteca a define como:</p> <blockquote> <p>(...) a generic virtualenv management and test command line tool (...)</p> </blockquote> <p>Com <em>tox</em> é possível:</p> <ul> <li>Validar o seu pacote contra diferentes versões do <em>Python</em>;</li> <li>Rodar os seus testes em diferentes <em>environments</em>.</li> </ul> <p>Não é só por usar <a href=https://klauslaube.com.br/tag/virtualenv.html title="Leia mais sobre Virtualenv"><em>ambientes virtuais</em></a> que o <em>tox</em> é uma boa ideia. Ele vem sendo uma mão na roda para os desenvolvedores de pacotes <em>Python</em> que precisam dar suporte às versões <code>2.x</code> e <code>3.x</code>, e que utilizam testes automatizados como <em>design</em> das soluções.</p> <p>Com o <em>Django</em> a "granularidade" pode ser ainda maior, rodando testes em ambientes que são combinações entre diferentes versões da linguagem e do <em>framework</em>.</p> <h2>Antes de continuar: Travis e Build Matrix</h2> <p>Se você estiver utilizando o <a href><em>Travis CI</em></a>, poderoso serviço de Continuous Integration, consegue reproduzir o comportamento que apresentaremos a seguir através do uso de <a href=https://docs.travis-ci.com/user/customizing-the-build/#Build-Matrix title="Customizing the build"><em>Build Matrix</em></a>.</p> <p>A diferença é que com o <em>tox</em>, podemos obter o mesmo comportamento em tempo de desenvolvimento. Agilizando um pouco mais o processo.</p> <p>Veja mais em <a href=https://vevurka.github.io/dsp17/git/quality/django/python/travis_ci_frisor/ title="Setting up Travis CI for github repo in Python">"Travis CI for Python project"</a>.</p> <h2>Na prática</h2> <p>Vou aproveitar o tema e usar o <em>tox</em> para me ajudar em um <em>refactoring</em> de um <em>app</em> de código aberto, que há muito não dou suporte: O <a href=https://github.com/kplaube/django-simple-contact title="Veja no Github">django-simple-contact</a>.</p> <p>Se você quiser acompanhar o passo-a-passo, clone o projeto e dê um <code>git checkout</code> da <em>revisão</em> <code>80145ae</code>:</p> <div class=highlight><pre><span></span>$ git clone git@github.com:kplaube/django-simple-contact.git
$ <span class=nb>cd</span> django-simple-contact/
$ git checkout 80145ae
</pre></div> <p>Na estrutura atual, é possível executar os testes através do <code>setup.py</code> ou <code>python runtests.py</code>:</p> <div class=highlight><pre><span></span>$ python setup.py <span class=nb>test</span>
<span class=o>(</span>...<span class=o>)</span>
-----------------------------------------------
Ran <span class=m>6</span> tests in <span class=m>0</span>.230s

OK
Destroying <span class=nb>test</span> database <span class=k>for</span> <span class=nb>alias</span> <span class=s1>&#39;default&#39;</span>...
</pre></div> <p>É possível fazer a troca da versão do <em>Python/Django</em> de forma manual (através do <a href=https://klauslaube.com.br/tag/pyenv.html title="Leia mais sobre pyenv"><em>pyenv</em></a>, por exemplo). Obviamente que o <em>tox</em> deixa tudo mais interessante (e automatizado).</p> <h3>Instalando o tox</h3> <p>Finalmente, vamos adicionar a ferramenta ao projeto:</p> <div class=highlight><pre><span></span>$ pip install tox
</pre></div> <p>Caso esteja usando <em>pyenv</em>, a instalação do <code>tox-pyenv</code> é sugerida. <a href=https://pypi.python.org/pypi/tox-pyenv title="tox plugin that makes tox use pyenv which to find python executables">Leia mais sobre a biblioteca</a>.</p> <p>Para deixar tudo mais organizado, vamos nos inspirar na estrutura do projeto <a href=https://github.com/vandersonmota/model_mommy title="Object factory for django"><em>modelmommy</em></a>. Criaremos um arquivo <code>requirements.txt</code> com o seguinte conteúdo:</p> <div class=highlight><pre><span></span><span class=o>#</span> <span class=n>requirements</span><span class=p>.</span><span class=n>txt</span>

<span class=n>bleach</span>
<span class=n>django</span><span class=o>&gt;=</span><span class=mi>1</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span>
</pre></div> <p>A versão <code>1.8.0</code> (até o momento) é a <em>LTS</em> mais antiga, portanto, garantiremos suporte dessa versão em diante. O <a href=https://pypi.python.org/pypi/bleach title="An easy safelist-based HTML-sanitizing tool"><em>bleach</em></a> é uma dependência do projeto, não relevante ao exemplo desse artigo.</p> <p>É interessante deixarmos explícito a instalação do <em>tox</em>... um <code>requirements-dev.txt</code> pode ser uma solução:</p> <div class=highlight><pre><span></span><span class=o>#</span> <span class=n>requirements</span><span class=o>-</span><span class=n>dev</span><span class=p>.</span><span class=n>txt</span>

<span class=n>tox</span>
</pre></div> <p>Agora, quando um <em>dev</em> juntar-se ao projeto, ele poderá executar o comando <code>pip install -r requirements-dev.txt</code>, e ter as dependências necessárias para contribuir com o <em>app</em>.</p> <h3>Configurando</h3> <p>Antes de executar a ferramenta é necessário criar um arquivo <code>tox.ini</code>, que será responsável por configurar os ambientes e disparar os testes:</p> <div class=highlight><pre><span></span><span class=c1># tox.ini</span>

<span class=k>[tox]</span>
<span class=na>envlist</span> <span class=o>=</span> <span class=s>py27-django{18,111}, py36-django{18,111,20}</span>

<span class=k>[testenv]</span>
<span class=na>commands</span> <span class=o>=</span> <span class=s>python runtests.py</span>
<span class=na>setenv</span> <span class=o>=</span><span class=s></span>
<span class=s>    DJANGO_SETTINGS_MODULE=simple_contact.tests.test_settings</span>
<span class=s>    PYTHONPATH={toxinidir}</span>
<span class=na>basepython</span> <span class=o>=</span><span class=s></span>
<span class=s>    py27: python2.7</span>
<span class=s>    py36: python3.6</span>
<span class=na>deps</span> <span class=o>=</span><span class=s></span>
<span class=s>    bleach</span>
<span class=s>    django18: Django==1.8</span>
<span class=s>    django111: Django==1.11</span>
<span class=s>    django20: Django==2.0</span>
</pre></div> <p>Por partes:</p> <ul> <li><code>[tox]</code>: Aqui colocamos as configurações globais. <code>envlist</code> conterá a lista de ambientes nos quais executaremos os testes.</li> <li><code>[testenv]</code>: Configurações por ambiente de teste. Poderíamos ter configurações específicas ao utilizar <code>[testenv:py36-django20]</code>, por exemplo.</li> <li><code>commands</code>: O comando a ser executado.</li> <li><code>setenv</code>: Variáveis de ambiente setadas para a execução dos testes.</li> <li><code>basepython</code>: Nome do interpretador <em>Python</em> utilizado para a criação do ambiente virtual. Repare no "match" com <code>py27-</code> e <code>py36-</code> do <code>envlist</code>.</li> <li><code>deps</code>: Dependências para determinado ambiente de teste. Repare no "match" com <code>django{18,111,20}</code>.</li> </ul> <p>Com o uso dos <em>brackets</em>, ao invés de criarmos um <code>testenv</code> para cada combinação (exemplo: <code>py27-django18</code>, <code>py27-django111</code>, <code>py36-django18</code>, etc), o <em>tox</em> fica responsável por fazer a "matriz de combinações".</p> <p>Agora sim, podemos executar a ferramenta de linha de comando:</p> <div class=highlight><pre><span></span>$ tox
<span class=o>(</span>...<span class=o>)</span>
ERROR:   py27-django18: commands failed
ERROR:   py27-django111: commands failed
ERROR:   py36-django18: commands failed
ERROR:   py36-django111: commands failed
py36-django20: commands succeeded
</pre></div> <p>No meu ambiente local, como esperado, apenas os testes do ambiente <code>py36-django20</code> passaram. Para ter acesso a versão corrigida, dê um <em>checkout</em> da revisão <code>a37ebd1608</code>:</p> <div class=highlight><pre><span></span>$ git checkout a37ebd1608
$ tox
<span class=o>(</span>...<span class=o>)</span>
py27-django18: commands succeeded
py27-django111: commands succeeded
py36-django18: commands succeeded
py36-django111: commands succeeded
py36-django20: commands succeeded
</pre></div> <p>Perfeito!</p> <p>Ainda é possível executar apenas os testes de um ambiente específico:</p> <div class=highlight><pre><span></span>$ tox -e py36-django20
<span class=o>(</span>...<span class=o>)</span>
-----------------------------------------------
Ran <span class=m>6</span> tests in <span class=m>0</span>.055s

OK
Destroying <span class=nb>test</span> database <span class=k>for</span> <span class=nb>alias</span> <span class=s1>&#39;default&#39;</span>...
</pre></div> <p>O resultado final está disponível na <em>tag</em> <code>0.3.0</code> do projeto.</p> <h2>Considerações finais</h2> <p>Que esse movimento da comunidade <em>Django</em> consiga influenciar ainda mais a adoção do <em>Python 3</em>. Admito que sem essa "motivação extra", dificilmente cogitaria o <em>upgrade</em> da linguagem em meus projetos nesse momento.</p> <p>O <em>tox</em> é sem dúvida uma ferramenta que pode auxiliar nessa fase de transição, portanto, não hesite em adicioná-la ao seu <em>toolbelt</em>.</p> <p>Para uma integração <em>seamless</em> com o <em>Travis CI</em>, o <a href=https://github.com/tox-dev/tox-travis title="Seamless integration of Tox into Travis CI"><em>tox-travis</em></a> é recomendado.</p> <p>Até a próxima!</p> <h2>Referências</h2> <ul> <li><a href=https://www.activestate.com/blog/2017/01/python-3-vs-python-2-its-different-time>ActiveState - Python 3 vs Python 2: It's different this time</a></li> <li><a href=http://henriquebastos.net/desmistificando-o-conceito-de-django-apps/ >Henrique Bastos - Desmistificando O Conceito De Django Apps</a></li> <li><a href=http://jsatt.com/blog/using-tox-with-travis-ci-to-test-django-apps/ >Jeremy Satterfield - Using Tox with Travis CI to Test Django Apps</a></li> <li><a href=https://vevurka.github.io/dsp17/git/quality/django/python/travis_ci_frisor/ >vevurka-dev - Travis CI for Python project</a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/testes.html title="Leia mais sobre" class=Article-tagLink>testes</a> <a href=https://klauslaube.com.br/tag/tdd.html title="Leia mais sobre" class=Article-tagLink>tdd</a> <a href=https://klauslaube.com.br/tag/tox.html title="Leia mais sobre" class=Article-tagLink>tox</a> <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre" class=Article-tagLink>django</a> <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre" class=Article-tagLink>python</a> <a href=https://klauslaube.com.br/tag/virtualenv.html title="Leia mais sobre" class=Article-tagLink>virtualenv</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2018/01/05/testando-apps-django-com-tox.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>