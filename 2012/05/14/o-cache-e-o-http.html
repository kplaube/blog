<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>O cache e o HTTP | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="Em tempos de alta demanda, o cache pode tornar-se o melhor amigo das aplicações Web. Qualquer milissegundo economizado é um ponto a mais com o seu usuário, com os mecanismos de busca e com o seu serviço de hospedagem."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, web, infraestrutura, cache, http"><meta property=og:title content="O cache e o HTTP"><meta property=og:description content="Em tempos de alta demanda, o cache pode tornar-se o melhor amigo das aplicações Web. Qualquer milissegundo economizado é um ponto a mais com o seu usuário, com os mecanismos de busca e com o seu serviço de hospedagem."><meta property=og:url content=https://klauslaube.com.br/2012/05/14/o-cache-e-o-http.html><meta property=og:image content><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2012/05/14/o-cache-e-o-http.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> O cache e o HTTP </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2012-05-14T23:14:46-03:00 itemprop=datePublished>14 Mai, 2012</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/performance.jpg alt="Cache e tempo de requisição" class=representative-image width=180 height=180> <p>Em tempos de alta demanda, o <strong><em>cache</em></strong> pode tornar-se o melhor amigo das aplicações <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre Web"><em>web</em></a>. Através dele temos uma opção prática, acessível e barata para melhorar performance, diminuir consumo de recursos e tempos de resposta. Qualquer milissegundo economizado é um ponto a mais com o seu usuário, com os mecanismos de busca e com o seu serviço de hospedagem.</p> <!-- PELICAN_END_SUMMARY --> <p>Antes de falarmos de <em>cache</em> em aplicações <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre o Django"><em>Django</em></a> ou <a href=https://klauslaube.com.br/tag/codeigniter.html title="Leia mais sobre Codeigniter"><em>Codeigniter</em></a>, acho interessante falarmos sobre o uso de <em>cache</em> com o protocolo <em>HTTP</em>. Afinal, é esta a primeira camada a “atacar” quando precisamos melhorar os tempos de resposta das nossas aplicações <em>web</em>.</p> <h2>O que é “caching”?</h2> <p>Segundo <a href=http://betterexplained.com/articles/how-to-optimize-your-site-with-http-caching/ title="How To Optimize Your Site With HTTP Caching"><em>Kalid Azad</em></a>:</p> <blockquote> <p>Caching is a great example of the ubiquitous time-space tradeoff in programming. You can save time by using space to store results.</p> </blockquote> <p>Basicamente, <strong><em>caching</em></strong> é o ato de “economizar processamento” armazenando os seus resultados. Um bom exemplo é o temporário do seu navegador, onde uma imagem que não teve alteração desde o momento do seu <em>download</em> é resgatada do seu disco e não da <em>internet</em>. Uma tarefa mais rápida e menos custosa.</p> <p>Logo, entendemos que o <strong><em>cache</em></strong> é um local em disco ou memória utilizado para armazenar estes resultados. Ele pode se aplicar ao <em>front-end</em> (como ilustrado no exemplo acima), ou ao <em>back-end</em>, através dos servidores <em>web</em>, como o <em>Apache</em> e o <a href=https://klauslaube.com.br/2011/12/19/nginx-poderoso-rapido-facil.html title="Leia mais sobre Nginx"><em>Nginx</em></a>, ou através de ferramentas mais específicas, como <em>Memcached</em> e <em>Redis</em>.</p> <p>Assim como a definição de <a href=https://klauslaube.com.br/2012/04/05/entendendo-os-cookies-e-sessoes.html title="Entendendo os Cookies e Sessões"><em>cookies</em> e sessões</a>, a utilização de <em>cache</em> nos navegadores <em>Web</em> é feita através de informações transmitidas pelo cabeçalho da requisição e resposta.</p> <p>Existem quatro tipos de cabeçalhos específicos para <em>cache</em> em <em>HTTP</em>. Mas todos partem da premissa que o arquivo em questão (pode ser um documento, imagem, <em>script</em>, etc) já está armazenado no disco do internauta, acessível ao navegador.</p> <h2>Last-Modified</h2> <p>Com o <code>Last-Modified</code>, o navegador informa ao servidor que irá baixar um arquivo desde que a sua data de modificação seja diferente da data do arquivo armazenado. Na requisição é passado o cabeçalho <code>If-Modified-Since</code>, e se a data do arquivo no servidor for mais recente, o navegador faz um novo <em>download</em>.</p> <p>Vamos fazer uma requisição tendo como resposta um cabeçalho <code>Last-Modified</code>:</p> <div class=highlight><pre><span></span>$ curl -i -I http://klauslaube.com.br/media/blog/security.jpg

HTTP/1.1 <span class=m>200</span> OK
...
Date: Tue, <span class=m>01</span> May <span class=m>2012</span> <span class=m>19</span>:20:27 GMT
Last-Modified: Sat, <span class=m>07</span> Apr <span class=m>2012</span> <span class=m>17</span>:51:10 GMT
...
</pre></div> <p>Uma vez que o arquivo esteja em disco, o navegador tem como informar a data da última alteração. Então, fazemos uma nova requisição ao arquivo <code>security.jpg</code>, passando esta data no cabeçalho <code>If-Modified-Since</code>:</p> <div class=highlight><pre><span></span>$ curl -i -H <span class=s2>&quot;If-Modified-Since: Sat, 07 Apr 2012 17:51:10 GMT&quot;</span> http://klauslaube.com.br/media/blog/security.jpg

HTTP/1.1 <span class=m>304</span> Not Modified
Date: Tue, <span class=m>01</span> May <span class=m>2012</span> <span class=m>19</span>:22:00 GMT
Last-Modified: Sat, <span class=m>07</span> Apr <span class=m>2012</span> <span class=m>17</span>:51:10 GMT
</pre></div> <p>A resposta <code>304 Not Modified</code> não traz o conteúdo do arquivo em seu corpo, e é através desta resposta que o navegador sabe que não precisa fazer o <em>download</em> do arquivo, utilizando assim a versão que está em seu <em>cache</em>.</p> <h2>ETag</h2> <p>O modo como a <code>ETag</code> funciona é bem parecido com o conceito do <code>Last-Modified</code>. A diferença está no método de comparação: ao invés de fazer comparações pela data, são realizadas comparações através de identificadores únicos, atribuídos aos arquivos envolvidos nas requisições.</p> <p>Quando trabalhamos com <code>ETag</code>, obtemos respostas com o seguinte cabeçalho:</p> <div class=highlight><pre><span></span>$ curl -i -I http://localhost/exemplo-cache.html

HTTP/1.1 <span class=m>200</span> OK
...
Date: Tue, <span class=m>01</span> May <span class=m>2012</span> <span class=m>19</span>:46:18 GMT
ETag: <span class=s2>&quot;2c6b0d8-13-4befe555d6f80&quot;</span>
...
</pre></div> <p>É através do valor <code>2c6b0d8-13-4befe555d6f80</code> que navegador e servidor saberão se aquele arquivo em questão já está armazenado em <em>cache</em>. Isso é possível através do cabeçalho <code>If-None-Match</code>, enviado pelo navegador na requisição:</p> <div class=highlight><pre><span></span>$ curl -i -I -H <span class=s2>&quot;If-None-Match: \&quot;2c6b0d8-13-4befe555d6f80\&quot;&quot;</span> http://localhost/exemplo-cache.html

HTTP/1.1 <span class=m>304</span> Not Modified
Date: Tue, <span class=m>01</span> May <span class=m>2012</span> <span class=m>19</span>:50:40 GMT
ETag: <span class=s2>&quot;2c6b0d8-13-4befe555d6f80&quot;</span>
</pre></div> <p>Uma vez que o valor bata com o identificador do arquivo, o servidor informa ao navegador que não houve alterações. Então, o navegador utiliza a versão do arquivo que está no temporário.</p> <h2>Expires</h2> <p>A grande desvantagem dos dois métodos acima é que necessitamos consultar o servidor para verificar a procedência do arquivo. Com o <code>Expires</code> e <code>max-age</code> a “data de validade” vem junto com a requisição, logo, o navegador já sabe quando o arquivo em seu <em>cache</em> irá expirar, e só voltará a consultar o servidor quando este tempo for alcançado.</p> <p>Com o <code>Expires</code>, o servidor retorna no cabeçalho da resposta uma data de validade para um determinado arquivo:</p> <div class=highlight><pre><span></span>$ curl -i -I http://klauslaube.com.br/media/blog/cookies.jpg

HTTP/1.1 <span class=m>200</span> OK
Date: Tue, <span class=m>08</span> May <span class=m>2012</span> <span class=m>01</span>:49:13 GMT
...
Expires: Thu, <span class=m>31</span> Dec <span class=m>2037</span> <span class=m>23</span>:55:55 GMT
...
</pre></div> <p>Solicitando uma nova requisição para este mesmo arquivo, o navegador analisará a data local e a data de expiração. Se a data atual for maior que <code>Expires</code>, aí sim o navegador se comunicará com o servidor <em>web</em>, e fará um novo <em>download</em> do arquivo.</p> <h2>max-age</h2> <p>Embora o <code>max-age</code> possa parecer um pouco enigmático, ele é (na minha opinião) uma solução mais elegante e fácil de implementar que o <code>Expires</code>.</p> <p>Com o <code>Expires</code>, temos que informar uma data “absoluta” no cabeçalho, ou seja, somos obrigados a dizer o dia da semana, mês, ano, hora, minuto e até mesmo segundo em que determinado arquivo irá expirar. Logo, temos o trabalho de interpretar a data da requisição (seja no servidor ou na aplicação) adicionando o tempo que desejamos de <em>cache</em> e imprimindo este valor por extenso.</p> <p>Com o <code>max-age</code> temos a opção de utilizar datas “relativas”, ou seja, podemos dizer ao navegador que o arquivo irá expirar em 1 dia (em segundos):</p> <div class=highlight><pre><span></span>$ curl -i http://localhost/exemplo-cache.html

HTTP/1.1 <span class=m>200</span> OK
Date: Mon, <span class=m>14</span> May <span class=m>2012</span> <span class=m>17</span>:04:29 GMT
...
Cache-Control: max-age<span class=o>=</span><span class=m>86400</span>, must-revalidate
...
</pre></div> <p>Como você já deve ter reparado, não existe um índice de cabeçalho específico chamado <code>max-age</code>. Ele é na verdade um valor do índice <code>Cache-Control</code>.</p> <p>O valor <code>must-revalidate</code> solicita aos mecanismos de <em>cache</em> (você pode estar “atrás” de um <em>proxy</em>) o seguinte: Quando o arquivo ultrapassar o <code>max-age</code>, o <em>user-agent</em> deve revalidar o conteúdo junto ao servidor <em>Web</em>. Embora esse seja o comportamento esperado por estes mecanismos, tornar esta informação explícita pode garantir que ferramentas mais “obscuras” sigam este comportamento.</p> <h3>Um pouco sobre o Cache-Control</h3> <p>O <code>Cache-Control</code> foi adicionado na especificação do <a href=http://www.w3.org/Protocols/rfc2616/rfc2616.html title="Conheça o protocolo HTTP versão 1.1"><em>HTTP 1.1</em></a> com a finalidade de contornar as limitações do <code>Expires</code>, e também de melhorar o controle sobre o <em>cache</em> de determinado conteúdo por diferentes tipos de mecanismos.</p> <p>Além do uso do <code>max-age</code>, é através do <code>Cache-Control</code> que podemos especificar o comportamento de <em>cache</em> para o navegador (<code>private</code>), para algum <em>proxy</em>, servidores intermediários ou requisições <em>HTTPS</em> (<code>public</code>), ou ainda informarmos que não queremos fazer <em>caching</em> do conteúdo (<code>no-cache</code>).</p> <p><a href=http://www.mnot.net/cache_docs/#CACHE-CONTROL title="Tutorial sobre HTTP caching">Leia mais sobre <em>Cache-Control</em></a>.</p> <p>Vale ressaltar que o <code>Cache-Control</code> tem precedência sobre o <code>Expires</code>.</p> <h2>Qual forma utilizar?</h2> <p>A resposta é: depende do cenário.</p> <p>Para servir arquivos estáticos, a <a href=http://www.webfaction.com/ title="Smarter web hosting"><em>Webfaction</em></a> utiliza os cabeçalhos <code>Last-Modified</code>, <code>Expires</code> e <code>max-age</code>, atribuindo aos dois últimos valores absurdos de <em>cache</em> (por exemplo, datas de expiração para o ano de 2037). Isso garante que o seu navegador, <em>proxy</em> ou <em>gateway</em> “nunca esqueça” de uma determina imagem, folha de estilos ou arquivo <a href=https://klauslaube.com.br/tag/javascript.html title="Leia mais sobre Javascript"><em>Javascript</em></a>.</p> <p>Mesmo com o uso do <code>max-age</code>, é interessante ter o <code>Expires</code> como alternativa, caso o navegador do internauta não compreenda instruções de <code>Cache-Control</code>. Já a utilização do <code>Last-Modified</code>, segundo o <a href=http://www.askapache.com/htaccess/apache-speed-last-modified.html title="Remove Last-Modified Header"><em>Ask Apache</em></a>, não é lá muito interessante pois a sua utilização faz com que alguns navegadores ignorem o cabeçalho <code>Expires</code>. Um argumento mais relevante é a eliminação de procedimentos de validação (como o <code>If-Modified-Since</code> e <code>If-None-Match</code>), deixando a cargo apenas do <code>Expires</code> e <code>max-age</code> determinar o tempo de vida do estático em <em>cache</em>.</p> <p>Em páginas dinâmicas, onde um <em>cache</em> de 5 ou 10 minutos possa ser aplicado, o <code>max-age</code> com <code>Expires</code> é fundamental. Já em páginas que necessitam de um conteúdo em tempo real, ou páginas que utilizam informações de <em>cookies</em> ou sessões, a ausência de <em>cache</em> é justificável.</p> <p>Em documentos <em>HTML</em> onde o conteúdo é atualizado com uma frequência indeterminada, o uso de <code>Last-Modified</code> ou <code>ETag</code> é mais apropriado. Uma vez que fica difícil determinar quando a atualização irá ocorrer, é uma boa estratégia fazer com que o navegador atualize o conteúdo do seu <em>cache</em> quando necessário.</p> <h2>Considerações Finais</h2> <p>Embora seja um conteúdo bem introdutório, acho fundamental sabermos as diferentes maneiras de aplicar <em>cache</em> com o protocolo <em>HTTP</em> antes de partirmos para soluções específicas. Essas recomendações não são infalíveis, e em um cenário mais “extremo”, necessitam sim de auxílio de algumas ferramentas disponíveis no mercado para tornar o <em>cache</em> eficiente tanto para a experiência do usuário, quanto para a estabilidade dos seus serviços.</p> <p>Embora eu tenha utilizado o navegador <em>Web</em> como foco das explicações, “robôs”, ferramentas de <em>proxy</em> e <em>gateways</em> também podem fazer controle de <em>cache</em>. O comportamento é basicamente o mesmo, variando de acordo com instruções passadas no cabeçalho <code>Cache-Control</code>.</p> <p>Como não sou nenhum “expert” no assunto, se você possui alguma sugestão ou correção sobre o uso de <em>cache</em> com <em>HTTP</em>, por favor, conte-nos através dos comentários abaixo.</p> <p>Até a próxima…</p> <h2>Referências</h2> <ul> <li><a href=http://www.askapache.com/htaccess/apache-speed-compression.html title="Material bem interessante sobre como melhorar a performance com Cache no Apache"><em>Ask Apache: Speed tips – Turn on Compressor</em></a></li> <li><a href=http://betterexplained.com/articles/how-to-optimize-your-site-with-http-caching/ title="Excelente artigo falando sobre HTTP e cache"><em>Better Explained: How To Optimize Your Site With HTTP Caching</em></a></li> <li><a href=https://docs.djangoproject.com/en/dev/topics/cache/ title="Leia mais sobre Cache no Django"><em>Django Documentation: Django’s cache framework</em></a></li> <li><a href=https://developers.google.com/speed/articles/caching title="Bom material do Google sobre Caching"><em>Google Developers: HTTP Caching</em></a></li> <li><a href=http://condor.depaul.edu/dmumaugh/readings/handouts/SE435/HTTP/http.html title="Conheça um pouco mais sobre o protocolo HTTP com este artigo científico"><em>John Yannakopoulos: HyperText Transfer Protocol – A Short Course</em></a></li> <li><a href=http://www.mnot.net/cache_docs/ title="Excelente conteúdo sobre caching HTTP"><em>mnot.net: Caching Tutorial</em></a></li> <li><a href=http://www.webscalingblog.com/performance/caching-http-headers-cache-control-max-age.html title="Artigo bem objetivo descrevendo o uso do max-age"><em>Web Scaling Blog: Caching HTTP Headers, Cache-Control: max-age</em></a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre" class=Article-tagLink>web</a> <a href=https://klauslaube.com.br/tag/infraestrutura.html title="Leia mais sobre" class=Article-tagLink>infraestrutura</a> <a href=https://klauslaube.com.br/tag/cache.html title="Leia mais sobre" class=Article-tagLink>cache</a> <a href=https://klauslaube.com.br/tag/http.html title="Leia mais sobre" class=Article-tagLink>http</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2012/05/14/o-cache-e-o-http.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>