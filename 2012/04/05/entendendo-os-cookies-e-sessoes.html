<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>Entendendo os Cookies e Sessões | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="O protocolo HTTP é stateless, ou seja, não mantém o estado de uma requisição. Para suprir esta necessidade, são apresentados os Cookies e Sessões."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, infraestrutura, web, cookies, sessoes, php"><meta property=og:title content="Entendendo os Cookies e Sessões"><meta property=og:description content="O protocolo HTTP é stateless, ou seja, não mantém o estado de uma requisição. Para suprir esta necessidade, são apresentados os Cookies e Sessões."><meta property=og:url content=https://klauslaube.com.br/2012/04/05/entendendo-os-cookies-e-sessoes.html><meta property=og:image content=https://klauslaube.com.br//images/blog/exemplo-php-cookies.png><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2012/04/05/entendendo-os-cookies-e-sessoes.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content=https://klauslaube.com.br//images/blog/exemplo-php-cookies.png> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> Entendendo os Cookies e Sessões </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2012-04-05T16:53:12-03:00 itemprop=datePublished>05 Abr, 2012</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/cookies.jpg alt="Representação de cookies" class=representative-image width=180 height=180> <p>Por muito tempo eu abstrai o conceito de <em>cookies</em> e sessões, e nunca cheguei a prestar muita atenção no seu funcionamento. Recentemente, trabalhando com uma infra mais preocupada com a segurança, disponibilidade e performance, tive a oportunidade de relembrar e me aprofundar em alguns conceitos e práticas.</p> <!-- PELICAN_END_SUMMARY --> <p>O que já sabia é que os <em>cookies</em> são “persistências temporárias” feitas no lado do usuário, e sessões são persistências dependentes de <em>cookies</em>, mas realizadas no lado do servidor.</p> <p>A minha felicidade é que até aí, nada mudou :)</p> <h2>Para que servem Cookies e Sessões?</h2> <p>O <a href=http://wagnerelias.com/2009/02/06/http-essentials/ title="Conheça mais sobre o protocolo HTTP">protocolo <em>HTTP</em></a> é <em>stateless</em>, ou seja, ele não mantém um estado/conexão. Toda a interação que o seu cliente fizer com um servidor <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre Web"><em>web</em></a> acarretará em uma nova requisição e resposta.</p> <p>As requisições são independentes e possuem um tempo de vida (conexão, envio de mensagem, resposta, encerramento da conexão). O servidor <em>web</em> não é capaz de identificar se duas requisições vieram de um mesmo navegador, e o mesmo não faz nenhum gerenciamento em memória para que mensagens sejam compartilhadas entre requisições.</p> <p>É para suprir esta necessidade que entram os <em>cookies</em> e sessões.</p> <h2>Cookies</h2> <p>Através de <em>cookies</em> o servidor <em>web</em> é capaz de trocar informações de estado com o navegador do usuário. Desse modo, somos capazes de adicionar produtos a um carrinho de compras, sem perder estas informações ao mudar de página, sair do <em>website</em> ou até mesmo fechar o navegador.</p> <p>Tecnicamente falando, um <em>cookie</em> é uma pequena quantidade de informação persistida temporariamente pelo navegador. Os navegadores normalmente limitam o tamanho dos <em>cookies</em> em até 4KB, e apagam <em>cookies</em> com a data de “validade vencida”.</p> <p>Para entender como essa troca de informação é feita, vamos criar um <em>cookie</em> com o <a href=https://klauslaube.com.br/tag/php.html title="Leia mais sobre PHP"><em>PHP</em></a>:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span>
    <span class=c1>// cookies.php</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>isset</span><span class=p>(</span><span class=nv>$_COOKIE</span><span class=p>[</span><span class=s1>&#39;cookie_teste&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s1>&#39;Você JÁ passou por aqui!&#39;</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s1>&#39;Você NUNCA passou por aqui.&#39;</span><span class=p>;</span>
        <span class=nb>setcookie</span><span class=p>(</span><span class=s1>&#39;cookie_teste&#39;</span><span class=p>,</span> <span class=s1>&#39;Algum valor...&#39;</span><span class=p>,</span> <span class=nb>time</span><span class=p>()</span> <span class=o>+</span> <span class=mi>3600</span><span class=p>);</span>
    <span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</pre></div> <p>O código acima verifica se o <em>cookie</em> atendendo pelo identificador <code>cookie_teste</code> já existe, caso não exista, cria um <em>cookie</em> com identificador <code>cookie_teste</code>, valor <code>Algum valor...</code> e com <strong>1 hora de vida</strong> (a hora atual mais 3600 segundos).</p> <p>Quando visitamos pela primeira vez o <code>cookies.php</code>, temos a seguinte resposta:</p> <div class=highlight><pre><span></span>$ curl -I localhost/cookies.php

HTTP/1.1 <span class=m>200</span> OK
Date: Wed, <span class=m>04</span> Apr <span class=m>2012</span> <span class=m>00</span>:35:33 GMT
Server: Apache/2.2.21 <span class=o>(</span>Unix<span class=o>)</span> mod_ssl/2.2.21 OpenSSL/0.9.8r DAV/2 PHP/5.3.8
X-Powered-By: PHP/5.3.8
Set-Cookie: <span class=nv>cookie_teste</span><span class=o>=</span>Algum+valor...<span class=p>;</span> <span class=nv>expires</span><span class=o>=</span>Wed, <span class=m>04</span>-Apr-2012 <span class=m>01</span>:35:33 GMT
Content-Type: text/html
</pre></div> <p>Através da função <code>setcookie</code> do <em>PHP</em>, estamos enviando um item chamado <code>Set-Cookie</code> no cabeçalho <em>HTTP</em> da resposta. É através deste que o navegador entende que deve armazenar o valor <code>Algum valor…</code>, atendendo pelo identificador <code>cookie_teste</code>, e que esta informação expira em 1 hora (verifique a data da requisição e a data de validade do <em>cookie</em>).</p> <p>Na próxima vez que o navegador acessar esta <em>URL</em>, ele verificará se possui algum <em>cookie</em> para aquele domínio e <em>path</em>, caso exista, ele passa as informações do <em>cookie</em> no cabeçalho da requisição. Desse modo, a nossa aplicação é capaz de perceber a existência de um <em>cookie</em> (no caso do <em>PHP</em>, através do <em>array</em> global <code>$_COOKIE</code>).</p> <p>Abaixo, um exemplo de requisição utilizando o <em>Google Chrome</em>:</p> <p><img class=align-center src=/images/blog/exemplo-php-cookies.png width=610 height=315 title="Item cookie no cabeçalho de resposta da requisição HTTP" alt="Item cookie no cabeçalho de resposta da requisição HTTP"></p> <p><a href=/images/blog/exemplo-php-cookies.png>Clique para ampliar</a></p> <p>Se excluirmos os <em>cookies</em>, ou o tempo de expiração for atingido, o navegador deixa de anexar esta informação ao cabeçalho da requisição.</p> <h2>Sessões</h2> <p>As sessões têm um princípio similar aos <em>cookies</em>, só que o armazenamento do estado é feito pelo servidor <em>web</em>, e não pelo navegador.</p> <p>Por exemplo, quando construímos uma aplicação que necessita de autenticação, no momento em que o usuário efetuar o <em>login</em>, podemos até permitir que algumas informações sejam armazenadas em um <em>cookie</em>, mas dados mais “sensíveis”, como usuário e <em>e-mail</em>, são mais interessantes de serem guardadas em sessões. Isto, pois <strong>não é seguro</strong> que esse tipo de informação fique “viajando” pela <em>web</em>.</p> <p>Mas se o <em>HTTP</em> é <em>stateless</em>, e o servidor <em>web</em> não tem como identificar que a requisição anterior veio do meu <em>browser</em>, como é que ele sabe que as informações que eu guardei em sessão são de fato minhas? Simples… <strong>através de <em>cookies</em>!</strong></p> <p>Quando iniciamos uma sessão, é enviado um <em>cookie</em> para o navegador, com um valor único que corresponde a sessão aberta no servidor <em>web</em>. Vamos ilustrar através do exemplo abaixo:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span>
    <span class=c1>// sessions.php</span>

    <span class=nb>session_start</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>isset</span><span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;usuario&#39;</span><span class=p>]))</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s2>&quot;Bem vindo </span><span class=si>{</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;usuario&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>!&quot;</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s1>&#39;Você NUNCA passou por aqui.&#39;</span><span class=p>;</span>
        <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;usuario&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;João&#39;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</pre></div> <p>O código acima inicia uma sessão através do método <code>session_start</code>. Na primeira visita, será criado um índice <code>usuario</code> com o valor <code>João</code>. A resposta da nossa requisição será a seguinte:</p> <div class=highlight><pre><span></span>$ curl -I localhost/sessions.php

HTTP/1.1 <span class=m>200</span> OK
Date: Wed, <span class=m>04</span> Apr <span class=m>2012</span> <span class=m>01</span>:51:57 GMT
Server: Apache/2.2.21 <span class=o>(</span>Unix<span class=o>)</span> mod_ssl/2.2.21 OpenSSL/0.9.8r DAV/2 PHP/5.3.8
X-Powered-By: PHP/5.3.8
Set-Cookie: <span class=nv>PHPSESSID</span><span class=o>=</span>4h91dkp7pcp8184nil8rt9ok13<span class=p>;</span> <span class=nv>path</span><span class=o>=</span>/
Expires: Thu, <span class=m>19</span> Nov <span class=m>1981</span> <span class=m>08</span>:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check<span class=o>=</span><span class=m>0</span>, pre-check<span class=o>=</span><span class=m>0</span>
Pragma: no-cache
Content-Type: text/html
</pre></div> <p>Por partes:</p> <ul> <li>Como mencionei, <code>Set-Cookie</code> foi retornado com um identificador (<code>PHPSESSID</code>) e um valor que corresponde a sessão aberta no servidor (<code>4h91dkp7pcp8184nil8rt9ok13</code>). O complemento <code>path</code> está “dizendo” ao navegador que aquele <em>cookie</em> tem validade por todo o domínio (ou seja, valerá inclusive para outros arquivos <em>PHP</em> em outras subpastas). Quando não é informada a data de expiração, o navegador manterá o <em>cookie</em> até o momento em que ele for fechado.</li> <li>O <em>PHP</em> tomou a liberdade de adicionar alguns cabeçalhos de controle de <em>cache</em> (<code>Expires</code>, <code>Cache-Control</code> e <code>Pragma</code>) à nossa resposta. Em resumo, o servidor está dizendo ao navegador para que não armazene esta página em <em>cache</em>. Estes valores podem ser alterados em <a href=http://www.php.net/manual/en/ref.session.php title="PHP: Session functions">tempo de desenvolvimento</a>, ou <a href=http://www.php.net/manual/en/session.configuration.php title="PHP: Runtime configuration">através do <strong>php.ini</strong></a>.</li> <li>Em nenhum momento o <em>Apache</em> informou ao navegador que temos um índice <code>usuario</code> com o valor <code>João</code>. Estas informações estão disponíveis somente no lado do servidor.</li> </ul> <p>Quando visitarmos o <code>sessions.php</code> novamente, o navegador informará ao servidor que ele possui um <em>cookie</em> chamado <code>PHPSESSID</code>. A partir daí o <em>PHP</em> pega o valor deste <em>cookie</em>, recupera a sessão da memória (ou de um banco de dados, ou arquivos em disco) e atribui este valor ao <em>array</em> global <code>$_SESSION</code>.</p> <p>O nome do <em>cookie</em> varia de linguagem para linguagem e até mesmo de <em>framework</em> para <em>framework</em>. Por exemplo, no <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre Django"><em>Django</em></a> ele é chamado por padrão de <code>sessionid</code>, no <a href=https://klauslaube.com.br/tag/codeigniter.html title="Leia mais sobre CodeIgniter"><em>CodeIgniter</em></a> é chamado de <code>ci_session</code>.</p> <h2>Considerações finais</h2> <p>Gostei muito de me aprofundar um pouquinho mais neste assunto, e gostei mais ainda de poder traduzir este aprendizado através deste <em>post</em>.</p> <p>É claro que há alguns cuidados com segurança quando o assunto é <em>cookies</em> e sessões, bem como considerações em relação ao uso de <em>cache</em>. Pretendo falar mais sobre esses temas em <em>posts</em> vindouros.</p> <p>Até a próxima…</p> <h2>Referências</h2> <ul> <li><a href=http://www.php.net/manual/en/book.session.php title="Confira a documentação oficial do PHP que fala sobre Sessões"><em>PHP Manual – Session Handling</em></a></li> <li><a href="http://www.stanford.edu/~ouster/cgi-bin/cs142-fall10/lecture.php?topic=cookie" title="Material resumido, mas muito bom, sobre sessões e Cookies"><em>Stanford.edu – CS 142: Cookies and Session</em></a></li> <li><a href=http://wagnerelias.com/2009/02/06/http-essentials/ title="Wagner nos apresenta de forma objetiva o funcionamento do protocolo HTTP"><em>Wagner Elias</em> – <em>HTTP Essentials</em></a></li> <li><a href=http://wagnerelias.com/2009/04/21/seguranca-de-cookies-de-sessao-e-httponly/ title="Entenda as falhas de segurança apresentadas com o uso de sessões e cookies"><em>Wagner Elias</em> – Segurança de <em>Cookies</em> de sessão e <em>HTTPOnly</em></a></li> <li><a href=http://en.wikipedia.org/wiki/HTTP_cookie title="Leia este bom artigo em inglês sobre Cookies"><em>Wikipedia – HTTP Cookie</em></a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/infraestrutura.html title="Leia mais sobre" class=Article-tagLink>infraestrutura</a> <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre" class=Article-tagLink>web</a> <a href=https://klauslaube.com.br/tag/cookies.html title="Leia mais sobre" class=Article-tagLink>cookies</a> <a href=https://klauslaube.com.br/tag/sessoes.html title="Leia mais sobre" class=Article-tagLink>sessões</a> <a href=https://klauslaube.com.br/tag/php.html title="Leia mais sobre" class=Article-tagLink>php</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2012/04/05/entendendo-os-cookies-e-sessoes.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>