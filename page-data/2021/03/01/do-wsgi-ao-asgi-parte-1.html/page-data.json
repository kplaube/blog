{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021/03/01/do-wsgi-ao-asgi-parte-1.html","result":{"data":{"markdownRemark":{"html":"<p>O <a href=\"/tag/django.html\" title=\"Leia mais sobre Django\"><em>Django 3</em></a> veio para sacudir as estruturas! Parece que foi ontem, mas\na versão já está aí desde 2019. Entre todas as suas adições,\na de maior destaque certamente é a adoção de capacidades <em>async</em> através do <em>ASGI</em> (<em>Asynchronous Server Gateway Interface</em>).</p>\n<p>Se você, assim como eu, não vê motivos para largar o <a href=\"/2012/11/02/entendendo-o-cgi-fastcgi-e-wsgi.html\" title=\"Entendendo o CGI, FastCGI e WSGI\"><em>WSGI</em></a> (<em>Web Server Gateway Interface</em>),\ne ainda tem dificuldades para compreender o que é de fato esse novo <em>Gateway Interface</em>, vem comigo!</p>\n<p>Mas antes de mergulhar na prática, essa é uma boa oportunidade para falarmos sobre <em>async</em>, <em>threads</em>, concorrência e paralelismo.</p>\n<h2>CPU, cores, processos e threads</h2>\n<p>O <em>CPU</em> é a cabeça por trás de todo o processamento. Ele funciona em ciclos que correspondem ao tempo necessário para a execução de uma operação. Um\n<em>CPU</em> pode ter múltiplos <em>cores</em>, e cada <em>core</em> é capaz de executar múltiplos processos.</p>\n<p>No caso dos processos <em>Python</em>, cada um possui um interpretador <em>Python</em>, <em>memory space</em>, e o famigerado <em>GIL</em> (mais a seguir).</p>\n<p>Quando executamos o processo <em>Python</em>, ele:</p>\n<ul>\n<li>Pode executar múltiplos subprocessos.</li>\n<li>A partir da <em>main thread</em>, pode iniciar múltiplas <em>threads</em>.</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9be65b84d1ac7c8037599acba7d77908/5205c/python-thread-multiprocessing.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/klEQVQoz5WRiYrFMAhF8///WEppS3e674szR7CEGXjwAhKN5lxNnPyu53nYZBxHieNYsiyTdV3Fz9lua5omrU3TVM7zfM8dhT6wLEupqkqWZXlBPnTfdzmOQ/N936tt26YG2PnKbdtKURSSJIl0XfcPeN+3dk4MKM9zbQCB67pUTIEUckCCUVDH5xzzgeSBsgNF2O5w7owMgJbnedYYnzPryIA8CzUGAFbXtQzDoL5DhQIAwP/GdECMD5C3MjhCVkcT5FwURRIEgV7CwjB8YxQttl+nM/swdmAYnTORg0rCRvwU05GNyGqaRoUA8kEKlC8WQHs7RsRHkJiJAP4AvrS9ZXpY3AUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Diagrama mostrando a diferença entre multithreading e multiprocessing&quot;\"\n        title=\"Multithreading vs. Multiprocessing\"\n        src=\"/static/9be65b84d1ac7c8037599acba7d77908/e5715/python-thread-multiprocessing.png\"\n        srcset=\"/static/9be65b84d1ac7c8037599acba7d77908/8514f/python-thread-multiprocessing.png 192w,\n/static/9be65b84d1ac7c8037599acba7d77908/804b2/python-thread-multiprocessing.png 384w,\n/static/9be65b84d1ac7c8037599acba7d77908/e5715/python-thread-multiprocessing.png 768w,\n/static/9be65b84d1ac7c8037599acba7d77908/5205c/python-thread-multiprocessing.png 833w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Multithreading vs. Multiprocessing</figcaption>\n  </figure></p>\n<p>Uma <em>thread</em> é uma unidade de execução dentro de um processo. Cada <em>thread</em> utiliza o espaço de memória do mesmo, compartilhando-o com as demais.</p>\n<h2>Concorrência e paralelismo</h2>\n<p>A motivação por trás do uso de <em>threads</em> e subprocessos é permitir que diferentes tarefas aconteçam ao mesmo tempo. E \"ao mesmo tempo\" pode significar\nque a intenção seja de um resultado simultâneo, mas na prática, não necessariamente ocorrendo no mesmo instante.</p>\n<p>Complicado? Para fins didáticos\nvamos utilizar o exemplo proposto pelo <a href=\"https://medium.com/fintechexplained/advanced-python-concurrency-and-parallelism-82e378f26ced\" title=\"Advanced Python: Concurrency And Parallelism\"><em>FinTechExplained</em></a>:</p>\n<blockquote>\n<p>Eu estou esperando 10 amigos para almoçar, e eu tenho 3 horas para cozinhar o suficiente para 10 pessoas.</p>\n</blockquote>\n<p>Os passos para um prato são:</p>\n<ul>\n<li>Começo lavando os vegetais (~5 minutos);</li>\n<li>Corto os vegetais (~13 minutos);</li>\n<li>Cozinho os mesmos (~30 minutos);</li>\n<li>Sirvo (~2 minutos).</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 623px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e1761b77eba92b809d031991a52c7821/6114d/cooking-sync.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIklEQVQoz52RWW/CMBCE8/9/WIVatX3olUIOjkDuCEJJbMfxdJwAgj6AVEsbeb/ZjNdeB3+WuZNfsr5tYPp+ZGakjgVDaD2KFK6YLbxktuZoohZzyM8PmK47mzrKm6GnYEOHAeTUhZ6HzEOY5QJyNh3ixCTrxbcLFfjQ5O3rC8T7G/q6HjvcJwnKokCy2aBKUzQ0KbIMOXkcx/hZLdFtt6jKEjl1dThAkCkph5qOXclohWbygC6J4dTWIIoQBwEq7huenPOHjB1v2PGeucpSlOs1GTuuSggyudsNuWoaSNa1z0/Q1Jwu9NHTyNBE2zcJvCE/MUVd2usdmd1L34PiE2hevX2cQLhfMEKMV7413XsTV+toOPCs26HYz79DqSszu34B8IhnljykTsAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fluxograma mostrando os passos iniciando pela lavagem e terminando em servir\"\n        title=\"O fluxo de forma linear\"\n        src=\"/static/e1761b77eba92b809d031991a52c7821/6114d/cooking-sync.png\"\n        srcset=\"/static/e1761b77eba92b809d031991a52c7821/8514f/cooking-sync.png 192w,\n/static/e1761b77eba92b809d031991a52c7821/804b2/cooking-sync.png 384w,\n/static/e1761b77eba92b809d031991a52c7821/6114d/cooking-sync.png 623w\"\n        sizes=\"(max-width: 623px) 100vw, 623px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">O fluxo de forma linear</figcaption>\n  </figure></p>\n<p>Imagine que temos apenas uma boca no fogão, e que só conseguimos cozinhar um prato por vez.\nSe pensarmos de forma linear, um prato leva aproximadamente 50 minutos para ficar pronto. Se multiplicarmos\npelo número de amigos, precisaremos de <code class=\"language-text\">8 horas</code> cozinhando para atender a demanda.</p>\n<h3>Concorrência</h3>\n<p>Para reduzir o tempo total, uma possibilidade é adquirirmos outro fogão. Continuamos\na cortar os vegetais de forma sequencial, mas o passo de cozimento pode acontecer de uma\nmaneira na qual eu possa ter as duas bocas funcionando, e checar periodicamente o estado de cozimento\nde cada prato.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 623px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6447e2ceb197d9da597ce04369a68e21/6114d/concurrency.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQElEQVQoz41Rf2vCMBTs9/9YQ0Rw2x9jw632l05sq22mtbRN0uR2Ta2M4WCBBy/3Xu4u73n4dSzuH3unZpoG1pixbq0LbwBc9P1YHAoTZkbMaO1wR8J8ItGfW8jVG4ySNxFPBWuYTeKijyNI/x19EvMew24TyMCHqmsIIVAUBTQJO/8D8mOF7vUFzfMj9NoH2haGprxLlqFkY7bfQ+Q5mu0GxeGAI/E0TVHThWZd5BlyiqrTCe3TEu185sgsBURZ4kLcKAWvGgh2O6RRBMG8iUIcSXJIEuzjGHW4RruYQy4X0GGAtjiiJbn6EmjZ25/PEDRTidKRezoOYUhkSdLTgYwCd58wxTEo9kh+S5cFKi4ipHjVddAkqmcP6PkGUo5f/mu7d7dKB0Z2sNfHchgBBX/2edO6/xM3oSnnzG4Grj3fJ7FnumutUyAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Com duas bocas, consigo ter concorrência no cozimento&quot;\"\n        title=\"Com duas bocas, consigo ter concorrência no cozimento\"\n        src=\"/static/6447e2ceb197d9da597ce04369a68e21/6114d/concurrency.png\"\n        srcset=\"/static/6447e2ceb197d9da597ce04369a68e21/8514f/concurrency.png 192w,\n/static/6447e2ceb197d9da597ce04369a68e21/804b2/concurrency.png 384w,\n/static/6447e2ceb197d9da597ce04369a68e21/6114d/concurrency.png 623w\"\n        sizes=\"(max-width: 623px) 100vw, 623px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Com duas bocas, consigo ter concorrência no cozimento</figcaption>\n  </figure></p>\n<p><a href=\"https://diogommartins.wordpress.com/2017/04/07/concorrencia-e-paralelismo-threads-multiplos-processos-e-asyncio-parte-1/\" title=\"CONCORRÊNCIA E PARALELISMO – THREADS, MÚLTIPLOS PROCESSOS E ASYNCIO – PARTE 1\"><em>Diogo M. Martins</em> define concorrência como</a>:</p>\n<blockquote>\n<p>Quando duas ou mais tarefas podem começar a ser executadas e terminar em espaços de tempo que se sobrepõem,\nnão significando que elas precisam estar em execução necessariamente no mesmo instante.</p>\n</blockquote>\n<p>Logo, ao invés de 60 minutos (2 pratos x 30 minutos de cozimento) podemos alcançar um tempo menor.</p>\n<h3>Paralelismo</h3>\n<p>Com dois cozinheiros, cada um trabalhando de sua casa, conseguimos dividir a carga, e portanto, em <code class=\"language-text\">4 horas</code> seremos capazes de atender a demanda.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 623px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f80ff0676dbbd83c47510ccda5d70ff9/6114d/parallelism.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.60416666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACU0lEQVQ4y5VU2VLjMBDM/3/XLlA87Am5E9s57JiQy5csWXJvj0yOheIBVXVpRp6MWupWem3b4hYyijxHGIaI4xjb7Rar1crHMvsaqUU3bn8ncw8341yktEbKRofTyWO722F/OPq1c42rFVyefWjac0UOD7JyZUGUaAko1UHXQP0Wc5ZvrarQbBKoxwc0SXwlJAz1dAy7jIgF9GQMNRqgWYREBBPMUfWfUAczmDCAJlT/GfV0AhOF/rt6/gszn6Ftmo7hnsdJ9ntEmw1OPFLGOWa+4JykKZrXLQpjEPEOS+tgWOOcQ3o4oLAWbV2juvsGPR52DIvxCDl3OHHXknHFDzl3PpFtzjU1HECRbca44iy5jgIUwo6nqicj6GEfrqo6hnb3CrffXWDJzu3OcQdhKWsy+7XDHs1qCXX/3R8bn6n8leEokuUmt4J4hi3v4wrrF4+8n0G/j/lshjAIMJ1MEDAeDXlPvDe81b9v9ilDKa0ohKJymg2UaXxc0Z+XGlrM0A0fGNr1Co6eEjTx2kNivKRo0w0sfXbJpYb1DRVvKIx6vEc9ePZKXxgW9FO+XuNIxUpecDmbIpN8sUAWUVX6VLHxUeKXF+YT6CRBzqaKAmkR59cPiLidD8VvRMgGRxZmZBAzXyyXSPh2DZsVRYmIDQsKYfjN8sWkbJ5Xyr+y6uGuM7cwNPSe5QtwPIIWT9GHPicsX4jikQxZS27mU+Z9772GsX76g+r3TzTc9Dx6oprA8dIvaktum6ui73IZ4teazVz2/x/El314+dui4i2d8P7f5h9rncwIsLK7IgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Com dois cozinheiros, consigo paralelizar o trabalho&quot;\"\n        title=\"Com dois cozinheiros, consigo paralelizar o trabalho\"\n        src=\"/static/f80ff0676dbbd83c47510ccda5d70ff9/6114d/parallelism.png\"\n        srcset=\"/static/f80ff0676dbbd83c47510ccda5d70ff9/8514f/parallelism.png 192w,\n/static/f80ff0676dbbd83c47510ccda5d70ff9/804b2/parallelism.png 384w,\n/static/f80ff0676dbbd83c47510ccda5d70ff9/6114d/parallelism.png 623w\"\n        sizes=\"(max-width: 623px) 100vw, 623px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Com dois cozinheiros, consigo paralelizar o trabalho</figcaption>\n  </figure></p>\n<p>E talvez essa seja a forma mais simplista de definir paralelismo: Quando duas ou mais tarefas são executadas literalmente ao mesmo tempo.</p>\n<p>Bom... se a motivação por trás das <em>threads</em> e subprocessos é permitir que tarefas aconteçam ao mesmo tempo, podemos\nutilizar qualquer um deles para alcançar paralelismo, certo?</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 510px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/34c33f191a9ad0f896382106ff682d5c/18815/concurrency-parallelism.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.645833333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHchlLAD//EABcQAQEBAQAAAAAAAAAAAAAAAAEQACH/2gAIAQEAAQUCXdiF/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGBAAAgMAAAAAAAAAAAAAAAAAEDEAAUH/2gAIAQEABj8CdTAj/8QAGxAAAwACAwAAAAAAAAAAAAAAAAERECFBgaH/2gAIAQEAAT8hk/BlJWbnQ9tpTnH/2gAMAwEAAgADAAAAEBDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAAICAgMAAAAAAAAAAAAAAQARITFBkVGhsf/aAAgBAQABPxBKAOz7KHXbfuNDZ0mQDyTMApjmABQVP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Diagrama com a diferença de execução entre concorrência e paralelismo&quot;\"\n        title=\"Uma imagem pode valer mais que mil palavras (stackoverflow.com)\"\n        src=\"/static/34c33f191a9ad0f896382106ff682d5c/18815/concurrency-parallelism.jpg\"\n        srcset=\"/static/34c33f191a9ad0f896382106ff682d5c/7809d/concurrency-parallelism.jpg 192w,\n/static/34c33f191a9ad0f896382106ff682d5c/4ecad/concurrency-parallelism.jpg 384w,\n/static/34c33f191a9ad0f896382106ff682d5c/18815/concurrency-parallelism.jpg 510w\"\n        sizes=\"(max-width: 510px) 100vw, 510px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Uma imagem pode valer mais que mil palavras (stackoverflow.com)</figcaption>\n  </figure></p>\n<p>Não necessariamente.</p>\n<h2>GIL (Global Interpreter Lock)</h2>\n<p>O <em>Python Global Interpreter Lock</em> (ou <em>GIL</em>) é uma \"trava\" que permite que apenas uma <em>thread</em> tenha controle sobre o interpretador. Ou seja,\napenas uma <em>thread</em> executa por vez, mesmo em uma arquitetura <em>multi-thread</em> com mais de um <em>core</em>.</p>\n<p>Infame? No mínimo. Mas há uma boa motivação para essa trava existir. De forma resumida, ela está relacionada\ncom a forma como a linguagem <a href=\"https://stackify.com/python-garbage-collection/\" title=\"Leia sobre o gerenciamento de memória em Python\">gerencia memória</a>, e previne\nproblemas de <em>memory leak</em> e <em>deadlocks</em>, ao mesmo tempo que oferece números interessantes de performance.</p>\n<p>O artigo do <em>RealPython</em>,\n<a href=\"https://realpython.com/python-gil/\" title=\"Leia o artigo na íntegra\">\"What Is the Python Global Interpreter Lock (GIL)?\"</a>,\né uma excelente referência para você saber tudo a respeito.</p>\n<p>Para o bem ou para o mal, na prática você não consegue atingir paralelismo utilizando <em>threads</em> em <em>Python</em> (e note, essa é uma realidade específica da linguagem).\nAinda assim, fazer <code class=\"language-text\">multithreading</code> te dará o resultado concorrente que você deseja.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 553px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fe93b4fbfc08ea6eb2319840fce81a40/74cfa/gil-lock.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.39583333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACcElEQVQ4y3VUaVPbQAzN//8tHT60U2Y69IDSDuTgSEtIAiQhhxPbSbC9l6/dfdUaHCgt8mi8llZv9SStG9ZaODHGIIqiau1spS6hMgmpBFQqya8rX5GnUJIjI59SHLrMq/0u3knDfdSqlEItaaYwmY4wvB3gbjJCacrKzlmEm2EP49EQM/JnKd8lVAHihUgpUegcuc5Q2Jy0gCoS2q1gSsqydAdmpJRtSWyMhNWKskxhnpg2iqIAYwxlUUIIjmE4QOuuiebNCc7nXYTrNpC0YdkZTNxGvDhCND9EsT2tbDZpwbDfsE8laeR5Dt/3KfUMgmozCPs4ujrEQfsTWpMOttszAmxSYBs6asIb7mN2/QEqOAYYHRSfEmD3GfA1ZUe3pMcQrcxkWK89mDyBLVmlj5QLV2WiLGALBl0IqqH9uymuqGlKHRQxwtUC62AFFq0R0lupvNqsKeYhieGvQ3j+itYRHIzD+qfLNSCjLs7nUyy9GbabEAmLKdjfsWD0vVx5mM4miJNoZ3+zyzBuDKizduuGBFkUQnoech4jSiPwnEFqAa4TCKIaqQewNHkGdFl5FCCErAbWxB14g/cYdfcgg2+IL7/i5t0e7k6+oBv8wuXiAp8vDrB/+hHtSQvd5QX6fg/6aU4bWuvH+aPxkQRoRQ/C/4nE+4Ey6UAMm9h8P8byqoP+po9BcI3L6TnOxh1cr67QD3oYbW6pbP+hzLkgUEEjJOlqqUpTuj25axYdKsjnVKVkJ3VrqWSlnPPXVw+75tQaBCHG4wk1hu0K78aj9j8mwXF/f4/FYlHZdhnWP4mX4srgMjRa4y2pp8NdEIfxB0keMRpuQNCqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Fluxograma de como a GIL funciona&quot;\"\n        title=\"GIL e o gerenciamento de threads\"\n        src=\"/static/fe93b4fbfc08ea6eb2319840fce81a40/74cfa/gil-lock.png\"\n        srcset=\"/static/fe93b4fbfc08ea6eb2319840fce81a40/8514f/gil-lock.png 192w,\n/static/fe93b4fbfc08ea6eb2319840fce81a40/804b2/gil-lock.png 384w,\n/static/fe93b4fbfc08ea6eb2319840fce81a40/74cfa/gil-lock.png 553w\"\n        sizes=\"(max-width: 553px) 100vw, 553px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">GIL e o gerenciamento de threads</figcaption>\n  </figure></p>\n<p>E como conseguimos de fato paralelismo então? Utilizando processos!</p>\n<p>Com a biblioteca de <code class=\"language-text\">multiprocessing</code>, ao invés de iniciarmos\numa <em>thread</em>, iniciamos um novo processo <em>Python</em> que se encarregará de executar o que for requisitado. E citando o início desse artigo:</p>\n<blockquote>\n<p>No caso dos processos Python, cada um possui um interpretador Python, memory space, e o famigerado GIL.</p>\n</blockquote>\n<p>Logo, não sofremos a limitação da trava uma vez que estamos\nfalando de processos à parte, gerenciados pelo Sistema Operacional.</p>\n<h2>Multithreading e Multiprocessing</h2>\n<p>Para ficar um pouco mais claro, vamos a um exemplo prático. Verificaremos o tamanho de alguns sites.</p>\n<p>A forma mais recomendada de dar os primeiros passos com <em>threads</em> em <em>Python</em> é através da biblioteca <code class=\"language-text\">concurrent.futures</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># thread.py</span>\n\n<span class=\"token keyword\">import</span> concurrent<span class=\"token punctuation\">.</span>futures\n<span class=\"token keyword\">import</span> urllib<span class=\"token punctuation\">.</span>request\n\nURLS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'http://www.foxnews.com/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'http://www.cnn.com/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'http://www.bbc.co.uk/'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_url</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">with</span> urllib<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>urlopen<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span>timeout<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> conn<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> conn<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">with</span> concurrent<span class=\"token punctuation\">.</span>futures<span class=\"token punctuation\">.</span>ThreadPoolExecutor<span class=\"token punctuation\">(</span>max_workers<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> executor<span class=\"token punctuation\">:</span>\n        future_to_url <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>executor<span class=\"token punctuation\">.</span>submit<span class=\"token punctuation\">(</span>load_url<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> url <span class=\"token keyword\">for</span> url <span class=\"token keyword\">in</span> URLS<span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">for</span> future <span class=\"token keyword\">in</span> concurrent<span class=\"token punctuation\">.</span>futures<span class=\"token punctuation\">.</span>as_completed<span class=\"token punctuation\">(</span>future_to_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            url <span class=\"token operator\">=</span> future_to_url<span class=\"token punctuation\">[</span>future<span class=\"token punctuation\">]</span>\n            data <span class=\"token operator\">=</span> future<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'%r tem %d bytes'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Caso você queira saber mais sobre a sintaxe, vale a pena conferir a <a href=\"https://docs.python.org/3.6/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor\" title=\"Leia sobre ThreadPoolExecutor\">documentação\noficial do <em>Python</em></a>.</p>\n<p>A execução deve apresentar um resultado parecido com o abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">'http://www.bbc.co.uk/' tem 361696 bytes\n'http://www.cnn.com/' tem 1143256 bytes\n'http://www.foxnews.com/' tem 334772 bytes</code></pre></div>\n<p>O <code class=\"language-text\">ThreadPoolExecutor</code> estende do tipo <code class=\"language-text\">Executor</code>. Possuímos também o filho <code class=\"language-text\">ProcessPoolExecutor</code>, que tem uma interface semelhante, mas utiliza o módulo <code class=\"language-text\">multiprocessing</code>\npor baixo dos panos:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># process.py</span>\n\n<span class=\"token keyword\">import</span> concurrent<span class=\"token punctuation\">.</span>futures\n<span class=\"token keyword\">import</span> urllib<span class=\"token punctuation\">.</span>request\n\nURLS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'http://www.foxnews.com/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'http://www.cnn.com/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'http://www.bbc.co.uk/'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_url</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">with</span> urllib<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>urlopen<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span>timeout<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> conn<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> conn<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">with</span> concurrent<span class=\"token punctuation\">.</span>futures<span class=\"token punctuation\">.</span>ProcessPoolExecutor<span class=\"token punctuation\">(</span>max_workers<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> executor<span class=\"token punctuation\">:</span>\n        future_to_url <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>executor<span class=\"token punctuation\">.</span>submit<span class=\"token punctuation\">(</span>load_url<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> url <span class=\"token keyword\">for</span> url <span class=\"token keyword\">in</span> URLS<span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">for</span> future <span class=\"token keyword\">in</span> concurrent<span class=\"token punctuation\">.</span>futures<span class=\"token punctuation\">.</span>as_completed<span class=\"token punctuation\">(</span>future_to_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            url <span class=\"token operator\">=</span> future_to_url<span class=\"token punctuation\">[</span>future<span class=\"token punctuation\">]</span>\n            data <span class=\"token operator\">=</span> future<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'%r tem %d bytes'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Para maiores detalhes sobre a implementação, <a href=\"https://docs.python.org/3.6/library/concurrent.futures.html#concurrent.futures.ProcessPoolExecutor\" title=\"Leia mais sobre\">confira a documentação do <em>ProcessPoolExecutor</em></a>.</p>\n<p>Com auxílio da ferramenta de linha de comando <code class=\"language-text\">time</code>, podemos calcular quanto tempo\ncada <em>script</em> leva para executar as tarefas concorrentemente:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ time python thread.py\n'http://www.bbc.co.uk/' tem 360652 bytes\n'http://www.foxnews.com/' tem 336778 bytes\n'http://www.cnn.com/' tem 1143341 bytes\npython thread.py  0.15s user 0.06s system 38% cpu 0.555 total\n\n$ time python process.py\n'http://www.bbc.co.uk/' tem 360652 bytes\n'http://www.cnn.com/' tem 1143341 bytes\n'http://www.foxnews.com/' tem 336779 bytes\npython process.py  0.41s user 0.12s system 74% cpu 0.715 total</code></pre></div>\n<p>E surpreendentemente vemos que o exemplo com <em>threads</em> (<code class=\"language-text\">0.15s</code>) leva\nmenos tempo que o com subprocessos (<code class=\"language-text\">0.41s</code>).</p>\n<h2>I/O-bound e CPU-bound</h2>\n<p>Pela ideia de que <em>threads</em> em <em>Python</em> não são paralelas, podemos chegar erroneamente à conclusão de que <em>multiprocessing</em> é a solução\ndefinitiva.</p>\n<p>Depende do tipo de problema que estamos tentando resolver. Há duas categorias distintas\nque influenciam na decisão:</p>\n<ul>\n<li>Problemas <em>CPU-bound</em>: Onde o progresso do processo é limitado pela velocidade da <em>CPU</em> .</li>\n<li>Problemas <em>I/O-bound</em>: O progresso é limitado pela velocidade do subsistema de entrada/saída.</li>\n</ul>\n<p>Um exemplo do primeiro é um conjunto de operações matemáticas complexas, que dependem exclusivamente do uso da <em>CPU</em>. O código\nda seção anterior é um exemplo de <em>I/O-bound</em>.</p>\n<h3>Threads e I/O</h3>\n<p>O Sistema Operacional é responsável pelo gerenciamento de uma <em>thread</em>. <a href=\"https://en.wikipedia.org/wiki/Preemption_%28computing%29#Preemptive_multitasking\" title=\"Preemption (computing)\">Ele a interrompe a qualquer momento, salva o seu estado, e executa qualquer outra em seu lugar,\npodendo resumi-la ao fim do processo</a>.</p>\n<p><em>Larry Hastings</em>, no <a href=\"https://www.youtube.com/watch?t=11m40s&#x26;v=4zeHStBowEk&#x26;feature=youtu.be\" title=\"Veja o talk no Youtube\">\"Python's Infamous GIL\"</a>, descreve\ncomo o gerenciamento da <em>GIL</em> funciona do ponto de vista da linguagem:</p>\n<blockquote>\n<p>The way Python threads work with the GIL is with a simple counter. With every 100 byte codes executed the\nGIL is supposed to be released by the thread currently executing in order to give other threads a chance to execute code.</p>\n</blockquote>\n<p>Quando acessamos um banco de dados em outro servidor, um serviço <em>web</em>, ou um arquivo em um sistema de arquivos, estamos\nrealizando uma operação <em>I/O-bound</em>. Qualquer ação que demande comunicação com o <em>hardware</em> (como os <em>sockets</em>), envolve comunicação\ncom o <em>kernel</em> da máquina, e essa operação é mais lenta que as operações de uma <em>CPU</em>.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a3efed2b8019b2972a3207772d1cdbab/d326d/iobound.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.79166666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnUlEQVQoz2WSYU/bMBCG8///ycY0oX1jFULbgIlWTKQEWAWUZk0a1qRNnMSOHdd5d3baUrSTTokvd8/dvbEHsqZpsLOu65y7eF2jGA2RX57j9ugD7shfTweoL35AJAmMbPa5u1qvqir4vo+iKP4D1gRkeQ7JGPLRFTICjQkafPqIZHACQY1ENIcRHEZrV+O1besKd1PugNa13rgY5xwVNZRlD07PvyP4cozx8Wcsvp1BXI+g1qseiAM7HH8bgVIKm80buMzXULxGRQCjJCQNoxsBuR3IeyvtLa81bp8z/HqY4/4l3cY7tATWtJY9K9oqmKZgnIAEc3rLFilT8GzXKIqoe/9hsbbJKwSPCwyGL/jpz3A/Xe7BWrfuLc4asEpg/Ji4p5UtTAkYxzFmsxnCMERnNJJcgUvTF6U1/EmEr1dTDIM/uJksIKR+J0qUCQI2uPkdYxKL9xpaY7wFb1oYY/ax+bLE3VOCB5JA0GokNulqtjn97OHfigbg8A7/qjVN+pRl6Zwx64zkqElDifUqQ0L3z161wxx3ZgWydIl/E0quQBrr7F0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Diagrama de tempo comparando I/O waiting e CPU processing com Threads&quot;\"\n        title=\"I/O e CPU em um contexto I/O-Bound com Threads (realpython.com)\"\n        src=\"/static/a3efed2b8019b2972a3207772d1cdbab/e5715/iobound.png\"\n        srcset=\"/static/a3efed2b8019b2972a3207772d1cdbab/8514f/iobound.png 192w,\n/static/a3efed2b8019b2972a3207772d1cdbab/804b2/iobound.png 384w,\n/static/a3efed2b8019b2972a3207772d1cdbab/e5715/iobound.png 768w,\n/static/a3efed2b8019b2972a3207772d1cdbab/4ad3a/iobound.png 1152w,\n/static/a3efed2b8019b2972a3207772d1cdbab/d326d/iobound.png 1197w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">I/O e CPU em um contexto I/O-Bound com Threads (realpython.com)</figcaption>\n  </figure></p>\n<p>Como resultado, a maioria das operações <em>I/O-bound</em> ficará em um estado de \"espera\" até o momento em que ela receba um resultado. E como afirma <em>Cody Piersall</em>,\nnessa <a href=\"https://stackoverflow.com/questions/32256775/how-does-the-gil-in-python-affect-the-downloading-of-webpages-in-parallel\" title=\"How does the GIL in python affect the downloading of webpages in parallel?\">incrivelmente simples resposta no <em>Stackoverflow</em></a>:</p>\n<blockquote>\n<p>The GIL won't hurt you here.</p>\n<p>For I/O bound tasks (like downloading webpages), the GIL is not a problem. Python releases the GIL when I/O is happening,\nwhich means all the threads will be able execute the requests in parallel.</p>\n</blockquote>\n<p>Em outras palavras, a <em>thread</em> que necessita pegar dados de uma fonte externa irá adquirir a <em>GIL</em>. Subseqüentemente o <em>lock</em> é liberado\ne é adquirido por outra <em>thread</em> que inicia outro código <em>I/O-bound</em> (por exemplo). Quando a <em>GIL</em> é adquirida novamente pela primeira <em>thread</em>, possivelmente\nela já tenha recebido os dados.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9936bc4be1cba43e506c44266381f21d/264eb/gil-lock-threads.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkElEQVQoz4VSy26DMBDk/z+rl15atVKlRomCSiAgAtiAwS8wpoMt0UalYQ+wLJ6d2fEGdV2P4zjPMyEEubXWGNO2bZ7nyFGf8XTvvxForZum+QpDKYRUKk3TcxgWeS6EmPciEC56QkGYp1kURVLKgXN84vfUMoNfJbFO3WzvNARKqWmavOwkjoFEvuCHAYk+ndXLm/74tJxvM+MoWkB8RUjf97CA99wboV7fxdOzPpyGw2m8lVbrOzBojYvj8UgJhUnAo5txYENqW1Qmv011Y6HFzfIDXrOyLOmtgHj4XBQFZAvOR2NQ6ni/bdiawfa+6ymlrQvwozJozRgzo9kBY0jtRsL8cRyDf5FtjLdwB4xznHPpAnjIlkp2zr9Vmr+CDfAafrGwbfHlIlumlVp0DUMcRZCDBDT+doP/JMG/ilQLNWNKa8E6IxZJ0IW3X6FtsHWxbItSfqcIpUmSwMjfKxQ83l4M77cIdsD2rutQwUU8Yl4D5wCDClABBvP8FaILijtgsGFQ3+V6va5ysixDo2/02aWkjKljGgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Fluxograma com threads e os passos de acquire GIL, waiting for GIL, e releasing GIL&quot;\"\n        title=\"Exemplo onde a GIL é aquirida e liberada em diferentes threads (medium.com/fintechexplained)\"\n        src=\"/static/9936bc4be1cba43e506c44266381f21d/e5715/gil-lock-threads.png\"\n        srcset=\"/static/9936bc4be1cba43e506c44266381f21d/8514f/gil-lock-threads.png 192w,\n/static/9936bc4be1cba43e506c44266381f21d/804b2/gil-lock-threads.png 384w,\n/static/9936bc4be1cba43e506c44266381f21d/e5715/gil-lock-threads.png 768w,\n/static/9936bc4be1cba43e506c44266381f21d/264eb/gil-lock-threads.png 867w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Exemplo onde a GIL é aquirida e liberada em diferentes threads (medium.com/fintechexplained)</figcaption>\n  </figure></p>\n<p>Some isso ao fato de que <a href=\"https://stackoverflow.com/questions/3044580/multiprocessing-vs-threading-python%5D\" title=\"Multiprocessing vs Threading Python [duplicate]\">criar novos processos é normalmente mais caro do que <em>threads</em></a>, e temos uma resposta satisfatória aos números\napresentados no experimento anterior.</p>\n<p>Portanto, se:</p>\n<ul>\n<li><em>CPU-bound</em>: Use <em>multiprocessing</em>;</li>\n<li><em>I/O-bound</em>: Use <em>threads</em> ou <em>asyncio</em>.</li>\n</ul>\n<h2>Ah! Claro! asyncio!</h2>\n<p>E voltamos ao <em>asynchronous</em>, afinal esse é um <em>post</em> sobre <em>ASGI</em> :)</p>\n<p>Segundo <em>Miguel Grinberg</em>, no <em>talk</em> <a href=\"https://www.youtube.com/watch?v=iG6fr81xHKA\" title=\"Veja a apresentação na íntegra\">\"Asynchronous Python for the Complete Beginner\"</a>, <em>async</em>\né:</p>\n<blockquote>\n<p>A style of concurrent programming in which tasks release the CPU during waiting\nperiods, so that other tasks can use it.</p>\n</blockquote>\n<p>É importante salientar que:</p>\n<ul>\n<li><em>Async</em> (<em>async IO</em>, <em>asynchoronous</em>, ou <em>asynchronous IO</em>) e <em>asyncio</em> não são exatamente a mesma coisa;</li>\n<li>O <em>asynchronous IO</em>, de forma geral, é um estilo de programação concorrente;</li>\n<li>Já o <a href=\"https://docs.python.org/3/library/asyncio.html\" title=\"Leia mais na documentação oficial\"><em>asyncio</em></a> é uma das implementações <em>Python</em> desse estilo (há outras implementações,\ncomo o <a href=\"http://github.com/MagicStack/uvloop\" title=\"Veja o repositório\"><em>uvloop</em></a>).</li>\n</ul>\n<p>Continuamos dentro dos domínios da concorrência, mas ainda assim, apresentando uma técnica completamente diferente.</p>\n<h3>Event loop</h3>\n<p>De forma simplista, imagine que há um objeto <em>Python</em> chamado de <em>event loop</em>, e esse camarada é\nquem controla como e quando cada <em>task</em> irá rodar. Ele é consciente de cada <em>task</em>,\ne sabe em qual estado cada uma está.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/868e2dbfba60262f09a26c4b9517c56a/e8950/python-event-loop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.9375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACZUlEQVQoz21S20sUURyev6FnY8vSxIJywQxJQguj6EGLwAdB0h6kngJDeuwtiEgDJSqELj4UYl62HkTUNS287Mraiqvb7Nnd2Zndndmdvcxt58y5dDTCNfo4D+f8fpzf+c73fRwlhGBIKSX76wCkbHOocQCO2PrkpxdiXGQHB+Oyu5hNZZMJRX8qFsKCLCG7RBxkKVmCMIcISUX5gpqNm06kYKD9R2AJqT9JeMoKTWnKKrUUJBvmWlL1x6WtqBQRYx/nJ6Btc9Qx52bey0rWoDSgFGVNRxCFp+zBXs+tlt72lu5HHcNgLZ22jNmdmFayIaFKPrsOggghDmG8G/DnY2EB+P3JPOOQ89FnPdOuqurKM3UVpxuPHHXdu9ufXsTfgvFAQt77EabExthxOC3Gry6Ni8mUd+Ld8lZYsFBo1Lh9qae2/qL7zvPu/r6rzWdPVjXOP41GI/oiEORiQZCEuZUFaFmcllF8y94MCDPlQEHbTCu+N/mbTZ2V568Nvb6/PX35RmvD8Wr35OONtIhErZAsWjsJMLk+C6HDUWj+Cv0QReB5O7Cyy49HNsIe1Nf+xFVT29XZ3NXWVHXqXMuFNv/LXEo1Y0V9j/Zf8zgI7YWvYxKIGrohZNV1JRNPmKEVcP1KR8WJumM17ob61pEHi+omNanzPZYuaoahayC0jZlg1LHl5I4OnaCOQTG3lBBCOZlPSoEP6qv+meGHXxYGhUwAI7LnNsjrASnLJ6Ij3rGSVeJgSf88OpTgI6wJEWZ0eFWMFyQWDStFTJFZyWji8pDZtq3kMhhjjhWZ6AQ5hzP5f/yT1N9+UVqiDH6zPwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Ilustração mostrando de forma subjetiva como o event loop funciona\"\n        title=\"O event loop é um pouco abstrato, e não consegui pensar em nenhum diagrama para explicá-lo (fadeevab.com)\"\n        src=\"/static/868e2dbfba60262f09a26c4b9517c56a/e5715/python-event-loop.png\"\n        srcset=\"/static/868e2dbfba60262f09a26c4b9517c56a/8514f/python-event-loop.png 192w,\n/static/868e2dbfba60262f09a26c4b9517c56a/804b2/python-event-loop.png 384w,\n/static/868e2dbfba60262f09a26c4b9517c56a/e5715/python-event-loop.png 768w,\n/static/868e2dbfba60262f09a26c4b9517c56a/4ad3a/python-event-loop.png 1152w,\n/static/868e2dbfba60262f09a26c4b9517c56a/71c1d/python-event-loop.png 1536w,\n/static/868e2dbfba60262f09a26c4b9517c56a/e8950/python-event-loop.png 2000w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">O event loop é um pouco abstrato, e não consegui pensar em nenhum diagrama para explicá-lo (fadeevab.com)</figcaption>\n  </figure></p>\n<p>Por exemplo, o estado \"pronto\" indica que a tarefa tem trabalho a fazer e está pronta para rodar. O \"esperando\" indica\nque a tarefa está esperando que alguma coisa externa termine, como as <em>I/O-bounds operations</em> que discutimos anteriormente.</p>\n<p>Para deixar as coisas simples, vamos imaginar que o <em>event loop</em> mantenha uma lista para tarefas \"prontas para executar\", e outra para \"esperando\". Ele\npega uma das <em>tasks</em> prontas para executar e bota para rodar. E aqui vai um detalhe importante: <a href=\"https://en.wikipedia.org/wiki/Cooperative_multitasking\" title=\"Cooperative multitasking\">A tarefa terá total controle da execução até o momento que\nela, cooperativamente, devolve o controle para o <em>event loop</em></a>.</p>\n<p>Quando a tarefa devolve o controle para o <em>event loop</em>, ele a coloca na determinada fila dependendo do seu estado. Ele (o <em>event loop</em>) percorre a lista de tarefas \"esperando\"\npara checar se o <em>I/O</em> de alguma delas já acabou, e portanto, se o seu estado agora é \"pronta para executar\". Essa tarefa é então movida para a lista de prontos para executar,\ne o <em>event loop</em> pega a próxima tarefa dessa mesma lista.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2a93ebfd4c3925f285434e70ae26e35a/dc616/iobound-asyncio.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.8125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACCUlEQVQoz21SaXPTMBD1//8ZDPQihWH6CVpa6BRKSpoSkri5yFUrPnPZjWRblh+SHQcH2Jmd1Ui7b/ftk4atpWm6i+n27vl7FZvrK3TfVFB/+QLNo4PsHNxcY/3xHNR4ymuE2NVrQRCAEPIHbPvAKMXgrgqut+BdXqB39g6N18foy0guPsCVd/5DHZFlojyUpus6Go0GbNvemzSKIiwl6Go0wnP1FuuvN2hWTlA/PED7tAJy/h6LT5fwZdNo7iFNeD4hYwxUFqpYBhSSBo9jTKZTrIgBevcNoVyB/vYUP06OcH/4Ci0J7H2+gn/7BbFkmgGiZGXKCrBoYkhQZzgEXy5BHRuBacKfzbCRrJjryAnnSHicAxYgZVGESBFzDioBGQux9n0kaVruDRqGMGYmnsgMxLRgWvb+hGXgXxZDh4R4NCg6BkNrEoBzobIyRYsd6+MFHgZLNIYr/Byt0bdiaK7rYiopFaao9s0IXTNBz1IuoBsReCL+2nGKscvRs1P0t65qtE6ng3a7DRWLnfXNcAvGs6gb4T+AiWw8sovGfJerhXIXsVRT/UfOc+m7hKFtxNCJpEViNCdU7lTsGCjQJEkwMEt5Rp67p3Ixgb/hWFMBn0mnuf/PNlGa52W56pzsq7xTWiRYzF14noO552buOk72+Wu1GsbjsXzz4Mkvo3y1XKDbfYRjW/gN9KOMDP8ANGAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Diagrama de tempo comparando I/O waiting e CPU processing com asyncio&quot;\"\n        title=\"I/O e CPU em um contexto I/O-Bound com asyncio (realpython.com)\"\n        src=\"/static/2a93ebfd4c3925f285434e70ae26e35a/e5715/iobound-asyncio.png\"\n        srcset=\"/static/2a93ebfd4c3925f285434e70ae26e35a/8514f/iobound-asyncio.png 192w,\n/static/2a93ebfd4c3925f285434e70ae26e35a/804b2/iobound-asyncio.png 384w,\n/static/2a93ebfd4c3925f285434e70ae26e35a/e5715/iobound-asyncio.png 768w,\n/static/2a93ebfd4c3925f285434e70ae26e35a/dc616/iobound-asyncio.png 933w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">I/O e CPU em um contexto I/O-Bound com asyncio (realpython.com)</figcaption>\n  </figure></p>\n<p>E o processo se repete.</p>\n<h3>asyncio x multithreading</h3>\n<p>O <em>async</em> e <em>threads</em> podem até parecer ter algumas semelhanças, mas há muitas diferenças. Para começar, as \"tarefas\" no contexto\ndo <em>asyncio</em> são chamadas de <em>coroutines</em>. Recorremos ao <a href=\"https://stackoverflow.com/questions/1934715/difference-between-a-coroutine-and-a-thread\" title=\"Difference between a “coroutine” and a “thread”?\"><em>Stackoverflow</em> para deixar as coisas mais claras</a>:</p>\n<blockquote>\n<p>With threads, the operating system switches running threads preemptively according to its scheduler, which is an algorithm in\nthe operating system kernel. With coroutines, the programmer and programming language determine when to switch coroutines;\nin other words, tasks are cooperatively multitasked by pausing and resuming functions at set points, typically (but not\nnecessarily) within a single thread.</p>\n</blockquote>\n<p>Duas coisas importantes precisam ser observadas com essa afirmação:</p>\n<ol>\n<li>Tarefas nunca são interrompidas no meio de uma operação, portanto, é mais fácil e seguro compartilhar recursos com <em>asyncio</em> em comparação com <em>threads</em>.</li>\n<li>É isso mesmo que você leu: Tipicamente (mas não necessariamente) dentro de uma única <em>thread</em>.</li>\n</ol>\n<p>Outro ponto importante é que assim como <em>threads</em>, corrotinas são mais leves que subprocessos. Mas aposto que você ainda está chocado com o <em>single-thread</em>, então\nvamos voltar a ele.</p>\n<h3>O exemplo da enxadrista</h3>\n<p>O <em>asyncio</em> é (<a href=\"https://docs.python.org/3/library/asyncio-dev.html#concurrency-and-multithreading\" title=\"Concurrency and Multithreading\">por padrão</a>) <em>single-threaded</em> e <em>single-process</em>. Como ele consegue ser uma alternativa tão interessante quanto os seus primos?</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c3bb25e3bbc3a415256c9afebe6b824d/b17f8/queens-gambit.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAABAv/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAQ9j3O2RYf8A/8QAGxAAAQQDAAAAAAAAAAAAAAAAAgABA0EQEiL/2gAIAQEAAQUCGYmXO11j/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BJ//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABsQAAEEAwAAAAAAAAAAAAAAAAEAAhEhAxIg/9oACAEBAAY/AriAg7GKR2rj/8QAGhABAAMBAQEAAAAAAAAAAAAAAQARQSExUf/aAAgBAQABPyELQ6bOb58sRusluguOtlpH2f/aAAwDAQACAAMAAAAQrA//xAAXEQEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/EKQx/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEh/9oACAECAQE/EK1//8QAHBABAAIDAAMAAAAAAAAAAAAAAQARITFBYZGh/9oACAEBAAE/EGt8T0ca9wMiTL6bo33PyIWf4BWr34jduS2xYAoCJEqVZ//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Protagonista de Gambit&#39;s Queen jogando xadresz&quot;\"\n        title=\"Achou que não ia ter referência ao Gambito? (lifestyleasia.com)\"\n        src=\"/static/c3bb25e3bbc3a415256c9afebe6b824d/212bf/queens-gambit.jpg\"\n        srcset=\"/static/c3bb25e3bbc3a415256c9afebe6b824d/7809d/queens-gambit.jpg 192w,\n/static/c3bb25e3bbc3a415256c9afebe6b824d/4ecad/queens-gambit.jpg 384w,\n/static/c3bb25e3bbc3a415256c9afebe6b824d/212bf/queens-gambit.jpg 768w,\n/static/c3bb25e3bbc3a415256c9afebe6b824d/5ef17/queens-gambit.jpg 1152w,\n/static/c3bb25e3bbc3a415256c9afebe6b824d/ac99c/queens-gambit.jpg 1536w,\n/static/c3bb25e3bbc3a415256c9afebe6b824d/b17f8/queens-gambit.jpg 1600w\"\n        sizes=\"(max-width: 768px) 100vw, 768px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Achou que não ia ter referência ao Gambito? (lifestyleasia.com)</figcaption>\n  </figure></p>\n<p>Voltamos a citar o <em>RealPython</em>, <a href=\"https://realpython.com/async-io-python/\" title=\"Async IO in Python\">trazendo o exemplo da enxadrista</a>:</p>\n<blockquote>\n<p>Chess master Judit Polgár hosts a chess exhibition in which she plays multiple amateur players.\nShe has two ways of conducting the exhibition: synchronously and asynchronously.</p>\n<p>Assumptions</p>\n<ul>\n<li>24 opponents</li>\n<li>Judit makes each chess move in 5 seconds</li>\n<li>Opponents each take 55 seconds to make a move</li>\n<li>Games average 30 pair-moves (60 moves total)</li>\n</ul>\n<p><strong>Synchronous version:</strong> Judit plays one game at a time, never two at the same time, until the game is complete.\nEach game takes (55 + 5) * 30 == 1800 seconds, or 30 minutes. The entire exhibition takes 24 * 30 == 720 minutes, or <strong>12 hours</strong>.</p>\n<p><strong>Asynchronous version:</strong> Judit moves from table to table, making one move at each table. She leaves the table and lets the opponent\nmake their next move during the wait time. One move on all 24 games takes Judit 24 * 5 == 120 seconds, or 2 minutes.\nThe entire exhibition is now cut down to 120 * 30 == 3600 seconds, or just <strong>1 hour</strong>.</p>\n</blockquote>\n<p>Temos apenas uma <em>Judit</em>, que pode fazer um movimento por vez por ela mesma. Ela jogar cada jogo de forma síncrona limita ela\ntambém ao tempo que o outro enxadrista tem para respondê-la. Mas de forma assíncrona, ela consegue lidar com múltiplas tarefas acontecendo concorrentemente,\nem turnos que permitem que ao tempo que um enxadrista está pensando em uma resposta, ela se move para o próximo, e retorna quando o primeiro estiver pronto.</p>\n<p>Imagine que <em>Judit</em> é o <em>event loop</em>, e que as jogadas com os 24 oponentes são tarefas acontecendo concorrentemente.</p>\n<h3>async/await</h3>\n<p>Mas como?</p>\n<p>O <em>Python</em> apresenta algumas palavras reservadas que permitem informar ao <em>event loop</em> o estado da tarefa sendo executada.\nVocê provavelmente já ouviu falar das principais: <code class=\"language-text\">async</code> e <code class=\"language-text\">await</code>.</p>\n<p>Com a primeira, indicamos ao <em>Python</em> que uma função trata-se de uma corrotina (ou um <a href=\"https://www.python.org/dev/peps/pep-0525/\" title=\"Leia a PEP 525\"><em>generator</em> assíncrono</a>).\nJá com o <code class=\"language-text\">await</code>, estamos dando o controle de volta ao <em>event loop</em>, e sinalizando que podemos esperar pelo resultado de determinada operação.</p>\n<p>Ou seja, com o código abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    r <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> f<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> r</code></pre></div>\n<p>Queremos dizer:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Suspenda a execução de g(),\naté que o que quer que a gente esteja esperando em f()\nseja retornado.\n\nNesse meio tempo, vá executar alguma outra coisa...</code></pre></div>\n<p>E note que bibliotecas para <em>I/O</em> precisam suportar essa forma de escrita, caso contrário não estaremos de fato fazendo uso das propriedades do <em>async</em>.</p>\n<h3>Na prática</h3>\n<p>Voltamos ao mesmo exemplo usado com <em>threads</em> e <em>multiprocessing</em>, mas agora reescrito para utilizar a biblioteca <code class=\"language-text\">asyncio</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># async.py</span>\n\n<span class=\"token keyword\">import</span> asyncio\n<span class=\"token keyword\">import</span> httpx\n<span class=\"token keyword\">import</span> itertools\n\nURLS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'http://www.foxnews.com/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'http://www.cnn.com/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'http://www.bbc.co.uk/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">]</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">measure_url</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    resp <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    length <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> httpx<span class=\"token punctuation\">.</span>AsyncClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> client<span class=\"token punctuation\">:</span>\n        results <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> asyncio<span class=\"token punctuation\">.</span>gather<span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">*</span><span class=\"token builtin\">map</span><span class=\"token punctuation\">(</span>measure_url<span class=\"token punctuation\">,</span> itertools<span class=\"token punctuation\">.</span>repeat<span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> URLS<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> results<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>url<span class=\"token punctuation\">}</span></span><span class=\"token string\"> tem </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>length<span class=\"token punctuation\">}</span></span><span class=\"token string\"> bytes\"</span></span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    asyncio<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Note o uso das palavras reservadas <code class=\"language-text\">async</code> e <code class=\"language-text\">await</code>, e do inicializador do <em>event loop</em>. Além, claro,\ndo uso de bibliotecas não bloqueantes como o caso da <a href=\"https://www.python-httpx.org\" title=\"A next-generation HTTP client for Python\"><em>httpx</em></a>.</p>\n<p>E como fica o comparativo com <em>threads</em> e processos? Mais uma vez rodando com <code class=\"language-text\">time</code>, temos:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ time python async.py\nhttp://www.foxnews.com/ tem 339756 bytes\nhttp://www.cnn.com/ tem 1145150 bytes\nhttp://www.bbc.co.uk/ tem 317556 bytes\npython async.py  0.22s user 0.07s system 13% cpu 2.151 total</code></pre></div>\n<p>Nada mal. Quase metade do tempo usando <code class=\"language-text\">multiprocessing</code>, e um pouco mais que usando <em>threads</em>. Isso não quer\ndizer que <em>asyncio</em> é necessariamento mais lento, <a href=\"https://stackoverflow.com/questions/8546273/is-non-blocking-i-o-really-faster-than-multi-threaded-blocking-i-o-how\" title=\"Is non-blocking I/O really faster than multi-threaded blocking I/O? How?\">apenas que o contexto desse experimento favoreceu o exemplo com <em>threads</em></a>.</p>\n<p>O propósito do comparativo com <code class=\"language-text\">time</code> nesse artigo é apenas ilustrar que há diferença entre as opções possíveis. Mas se\nvocê não está satisfeito com o resultado, o <em>Stackoverflow</em> <a href=\"https://stackoverflow.com/questions/27435284/multiprocessing-vs-multithreading-vs-asyncio-in-python-3\" title=\"multiprocessing vs multithreading vs asyncio in Python 3\">pode ajudar novamente</a>:</p>\n<blockquote>\n<ul>\n<li>CPU Bound => Multi Processing</li>\n<li>I/O Bound, Fast I/O, Limited Number of Connections => Multi Threading</li>\n<li>I/O Bound, Slow I/O, Many connections => Asyncio</li>\n</ul>\n</blockquote>\n<p>Vai depender do contexto do problema sendo resolvido.</p>\n<h2>Considerações finais</h2>\n<p>Eu lembro de estar em mais de uma entrevista de emprego, e ser perguntado\nsobre como fazer <em>CPU-bound</em> e <em>IO-bound</em> em <em>Python</em>. </p>\n<p>Agora sabemos o básico sobre os principais conceitos relacionados à concorrência em <em>Python</em>. Temos uma perspectiva\nmais detalhada sobre a <em>GIL</em>, e não entramos no mérito de debater se ela é boa ou ruim.\nEntender a natureza das <em>threads</em> na linguagem é mais importante, e é crucial para decidirmos da melhor forma como solucionar\nproblemas concorrentes.</p>\n<p>E optar pelo <em>async/ASGI</em> faz parte disso também. Portanto, agora que temos todo o contexto de concorrência e paralelismo,\nno próximo <em>post</em> vamos revisitar o funcionamento do <em>WSGI</em>, compará-lo com o seu primo mais novo, e compreender a motivação por trás da alternativa.</p>\n<p>Até a próxima.</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"https://callhub.io/understanding-python-gil/\">CallHub - Understanding Python GIL</a></li>\n<li><a href=\"https://dev.to/mervynlee94/multi-threading-vs-event-loop-in-python-1h4h\">Dev.to - Multi-threading vs Event Loop in Python</a></li>\n<li><a href=\"https://diogommartins.wordpress.com/2017/04/07/concorrencia-e-paralelismo-threads-multiplos-processos-e-asyncio-parte-1/\">Diogo M Martins - Concorrência e paralelismo: Threads, múltiplos processos e asyncio - Parte 1</a></li>\n<li><a href=\"https://medium.com/fintechexplained/advanced-python-concurrency-and-parallelism-82e378f26ced\">FinTechExplained - Advanced Python: Concurrency And Parallelism</a></li>\n<li><a href=\"https://medium.com/fullstackai/concurrency-in-python-cooperative-vs-preemptive-scheduling-5feaed7f6e53\">FullStackAI - Concurrency in Python: Cooperative vs Preemptive Scheduling</a></li>\n<li><a href=\"https://levelup.gitconnected.com/diy-multithreading-vs-multiprocessing-in-python-fb93698ca7f3\">Gitconnected - DIY: Multithreading vs Multiprocessing in Python</a></li>\n<li><a href=\"https://blog.miguelgrinberg.com/post/sync-vs-async-python-what-is-the-difference\">Miguel Grinberg - Sync vs. Async Python: What is the Difference?</a></li>\n<li><a href=\"https://www.blopig.com/blog/2019/01/making-the-most-of-your-cpus-when-using-python/\">Oxford Protein Informatics Group - Making the most of your CPUs when using python</a></li>\n<li><a href=\"https://realpython.com/async-io-python/\">RealPython - Async IO in Python: A Complete Walkthrough</a></li>\n<li><a href=\"https://realpython.com/python-concurrency/\">RealPython - Speed Up Your Python Program With Concurrency</a></li>\n<li><a href=\"https://realpython.com/python-gil/\">RealPython - What Is the Python Global Interpreter Lock (GIL)?</a></li>\n<li><a href=\"https://stackify.com/python-garbage-collection/\">Stackify - Python Garbage Collection: What It Is and How It Works</a></li>\n<li><a href=\"https://stackoverflow.com/questions/1934715/difference-between-a-coroutine-and-a-thread\">Stackoverflow - Difference between a “coroutine” and a “thread”?</a></li>\n<li><a href=\"https://stackoverflow.com/questions/33352298/how-does-python-handle-thread-locking-context-switching\">Stackoverflow - How does python handle thread locking / context switching?</a></li>\n<li><a href=\"https://stackoverflow.com/questions/8546273/is-non-blocking-i-o-really-faster-than-multi-threaded-blocking-i-o-how\">Stackoverflow - Is non-blocking I/O really faster than multi-threaded blocking I/O? How?</a></li>\n<li><a href=\"https://stackoverflow.com/questions/27435284/multiprocessing-vs-multithreading-vs-asyncio-in-python-3\">Stackoverflow - multiprocessing vs multithreading vs asyncio in Python 3</a></li>\n<li><a href=\"https://stackoverflow.com/questions/3044580/multiprocessing-vs-threading-python\">Stackoverflow - Multiprocessing vs Threading Python [duplicate]</a></li>\n<li><a href=\"https://stackoverflow.com/questions/868568/what-do-the-terms-cpu-bound-and-i-o-bound-mean\">Stackoverflow - What do the terms “CPU bound” and “I/O bound” mean?</a></li>\n<li><a href=\"https://stackoverflow.com/questions/1050222/what-is-the-difference-between-concurrency-and-parallelism\">Stackoverflow - What is the difference between concurrency and parallelism?</a></li>\n<li><a href=\"https://testdriven.io/blog/python-concurrency-parallelism/\">Testdriven.io - Parallelism, Concurrency, and AsyncIO in Python - by example</a></li>\n<li><a href=\"https://timber.io/blog/multiprocessing-vs-multithreading-in-python-what-you-need-to-know/\">Timber - Multiprocessing Vs. Threading In Python: What You Need To Know.</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=iG6fr81xHKA\">Youtube - Miguel Grinberg Asynchronous Python for the Complete Beginner PyCon 2017</a></li>\n</ul>","excerpt":"O Django 3 veio para sacudir as estruturas! Parece que foi ontem, mas\na versão já está aí desde 2019. Entre todas as suas adições,\na de…","frontmatter":{"date":"2021-03-01T17:45:00.000Z","title":"Do WSGI ao ASGI - Parte 1","tags":["python","django","wsgi","asgi","async","asyncio","threads","paralelismo","concorrencia","desenvolvimento-web"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAACaElEQVQ4y7VUTWgTQRReaS0IlTSxpWprLUp7EA8Kas9eLFSEKujJi9Sfa8WDt4JUUBB6i9qkSSotFFt7SNJuknWzu9KQxNqNWdNIiw2NMVrNog2m2Uyy2RlnNxgSCUUoXR47jzfzzfe+efOGQDv4iJrRIoQKRBCppvrq+N/gHTGPrySvUuE+MnSRDA1wy/7vv3AQwm3BsjbvTojXqPDDpRhh9NSbvISROjq5kMrmEFJUBTXBJXnYccZT52aD170fGscYnZXdb+WarGxYTCMNXQNciq3/lmZjG+aP8ZuscJsVBljBYOP2jTGGF77IZx5tvCpm1iqWa+DSfqubmc7JBeIpVTdKYzadlWu0sHorq7PQhol3fHAY2ffmvD0Q/CjjVbCsqN4wv4blNY+/0du4BtNr4jmNbc8oTRjdrVPROP9AcbVJzpbil5catljFfINdJp7RTTau3sScmHl/xbXUTy5eJt9eIvlpfg5xZyWyEzgOyCuPa4BvcVFM1WBmeuf4TGQI+c/DQC8KXMAG6W4w3w483cChl1ceVYFLaY+E13GGdZbAxKIdUYfT9oNbzkNbjhZs2fkO4DoG3MeBw6B8c9RgTmSk09M+whyYCU4hqiPr6sJUefpU3nsG/4GnC5DtBX8/KkpVB1Y+e1GSAmJBTNIy2ZbDCqmTsjBYCN2RhbuKyMG0APM//y1VGQ+1ZJQUA5zNqkKcJ3lEXn2S9/UpmyFtkYIqmqTqeuLbhycV6Wue6QF2HXC2qscbHZIj9/+WV9m+MdSNYTZRjBkL4UFZuCd/GoG5ZGW2u9mSKgnWr74CilaVXXgM/gAy4w2lbEBDQwAAAABJRU5ErkJggg==","width":180,"height":180,"src":"/static/88f9f9668b6ebef34fbbce3fe78ac897/d8216/python-logo-2.png","srcSet":"/static/88f9f9668b6ebef34fbbce3fe78ac897/d8216/python-logo-2.png 1x"}},"publicURL":"/static/88f9f9668b6ebef34fbbce3fe78ac897/python-logo-2.png"}},"fields":{"readingTime":{"minutes":17.25},"slug":"/2021/03/01/do-wsgi-ao-asgi-parte-1.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2021/03/01/do-wsgi-ao-asgi-parte-1.html"}},"staticQueryHashes":["2831923220","4114525740"]}