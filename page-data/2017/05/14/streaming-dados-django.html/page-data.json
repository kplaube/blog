{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/05/14/streaming-dados-django.html","result":{"data":{"markdownRemark":{"html":"<p>Recentemente na <a href=\"http://loadsmart.com/\" title=\"Book a truck with Loadsmart\"><em>Loadsmart</em></a>,\nhouve a necessidade de lidar com um cenário onde se faz necessário acessar uma <em>view</em>\nque retorna um <em>CSV</em> de tamanho considerável, gerado a partir de parâmetros dinâmicos,\nno melhor esquema \"imprima um relatório\".</p>\n<p>Embora o <a href=\"/tag/django.html\" title=\"Leia mais sobre Django\"><em>Django</em></a> seja desenhado para requisições curtas, existe a possibilidade\nde fazer <em>streaming</em> de grandes arquivos <em>CSVs</em> através da classe <code class=\"language-text\">StreamingHttpResponse</code>.</p>\n<p>Vale a nota: Esse artigo é sobre <em>CSVs</em>, mas você também pode <a href=\"http://stackoverflow.com/questions/30791228/serving-a-django-static-text-file\" title=\"Serving a django static text file\">\"streamar\" outros tipos de dados</a>\natravés desse método supimpa.</p>\n<h2>Motivação</h2>\n<p>Em determinados cenários, precisamos retornar arquivos relativamente grandes para\no usuário. O exemplo acima, uma requisição com parâmetros que irão gerar um relatório\nem <em>CSV</em>, é um caso bem comum.</p>\n<p>O comportamento de resposta padrão do <em>Django</em> é retornar uma instância de <code class=\"language-text\">HttpResponse</code>.\nO problema é que nesse modo carregaremos o arquivo inteiro para a memória do\nservidor, e só depois enviamos o arquivo para o cliente. Além de prejudicarmos o <em>Time To\nFirst Byte</em> (TTBT), podemos gerar picos de memória na máquina hospedeira (que podem afetar\ndemais requisições sendo processadas) e <em>timeouts</em> de conexão.</p>\n<p>Um exemplo de como faríamos esse retorno através do <code class=\"language-text\">HttpResponse</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> csv\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>http <span class=\"token keyword\">import</span> HttpResponse\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>view <span class=\"token keyword\">import</span> View\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CsvReportView</span><span class=\"token punctuation\">(</span>View<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Abstraindo a logica de filtro por parametros do request</span>\n        cargoes <span class=\"token operator\">=</span> Cargoes<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>filter_by_request_parms<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n\n        response <span class=\"token operator\">=</span> HttpResponse<span class=\"token punctuation\">(</span>content_type<span class=\"token operator\">=</span><span class=\"token string\">'text/csv'</span><span class=\"token punctuation\">)</span>\n        response<span class=\"token punctuation\">[</span><span class=\"token string\">'Content-Disposition'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'attachment; filename=\"filtered_cargoes.csv\"'</span>\n\n        writer <span class=\"token operator\">=</span> csv<span class=\"token punctuation\">.</span>writer<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">for</span> row <span class=\"token keyword\">in</span> cargoes<span class=\"token punctuation\">.</span>values_list<span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'commodity'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'weight'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            writer<span class=\"token punctuation\">.</span>writerow<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> response</code></pre></div>\n<p>Se você tem certa intimidade com geradores, deve estar supondo que essa pode ser uma\nmaneira de solucionar esse problema... e você está certo!</p>\n<h2>Como funciona o StreamingHttpResponse?</h2>\n<p>O <code class=\"language-text\">StreamingHttpResponse</code> funciona com a ajuda do conceito de <em>generators</em>. Achei\numa excelente definição no <a href=\"http://stackoverflow.com/questions/1756096/understanding-generators-in-python\" title=\"Understanding Generators in Python\"><em>Stackoverflow</em></a>:</p>\n<blockquote>\n<p>(...) is simply a function which returns an object on which you can\ncall next, such that for every call it returns some value, until it raises\na StopIteration exception, signaling that all values have been generated.\nSuch an object is called an iterator.</p>\n</blockquote>\n<p><a href=\"https://www.slideshare.net/ramalho/iteraveis-e-geradores-em-python\" title=\"Iteraveis e geradores em Python\">Leia mais sobre iteráveis e geradores</a>.</p>\n<p>Para tanto, o uso da palavra reservada <code class=\"language-text\">yield</code> se faz necessário. Logo, ao invés de termos o exemplo abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">my_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    message <span class=\"token operator\">=</span> <span class=\"token string\">'Hello, there!'</span>\n    response <span class=\"token operator\">=</span>  HttpResponse<span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\n    response<span class=\"token punctuation\">[</span><span class=\"token string\">'Content-Length'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> response</code></pre></div>\n<p>Teremos:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token string\">'Hello,'</span>\n    <span class=\"token keyword\">yield</span> <span class=\"token string\">'there!'</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">my_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> StreamingHttpResponse<span class=\"token punctuation\">(</span>hello<span class=\"token punctuation\">)</span></code></pre></div>\n<p><a href=\"https://andrewbrookins.com/django/how-does-djangos-streaminghttpresponse-work-exactly/\" title=\"How does Django’s StreamingHttpResponse work, exactly\">Leia mais no excelente \"How does Django's StreamingHttpResponse work, exactly?\"</a>.</p>\n<p>Voltando ao exemplo do <em>CSV</em>, teremos:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> csv\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>db <span class=\"token keyword\">import</span> models\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>http <span class=\"token keyword\">import</span> StreamingHttpResponse\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>views<span class=\"token punctuation\">.</span>generic <span class=\"token keyword\">import</span> View\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Echo</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Interface parecida com a que usamos para escrever arquivos.\n    \"\"\"</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> value\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CsvReportView</span><span class=\"token punctuation\">(</span>View<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Abstraindo a logica de filtro por parametros do request</span>\n        cargoes <span class=\"token operator\">=</span> Cargoes<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>filter_by_request_parms<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Usamos a mesma interface de buffer utilizada para escrever</span>\n        <span class=\"token comment\"># um arquivo. No entanto, apenas damos um `return value`</span>\n        <span class=\"token comment\"># aos inves de persistirmos o valor</span>\n        pseudo_buffer <span class=\"token operator\">=</span> Echo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        writer <span class=\"token operator\">=</span> csv<span class=\"token punctuation\">.</span>writer<span class=\"token punctuation\">(</span>pseudo_buffer<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Construimos o nosso gerador</span>\n        gen_func <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>writer<span class=\"token punctuation\">.</span>writerow<span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> row <span class=\"token keyword\">in</span> cargos<span class=\"token punctuation\">.</span>values_list<span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'commodity'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'weight'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        response <span class=\"token operator\">=</span> StreamingHttpResponse<span class=\"token punctuation\">(</span>gen_func<span class=\"token punctuation\">,</span> content_type<span class=\"token operator\">=</span><span class=\"token string\">'text/csv'</span><span class=\"token punctuation\">)</span>\n        response<span class=\"token punctuation\">[</span><span class=\"token string\">'Content-Disposition'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'attachment;filename=\"filtered_cargoes.csv\"'</span>\n\n        <span class=\"token keyword\">return</span> response</code></pre></div>\n<p>Antes mesmo de termos todo o <em>CSV</em> montado, já estamos retornando dados ao usuário.</p>\n<p><a href=\"https://docs.djangoproject.com/en/1.11/howto/outputting-csv/#streaming-large-csv-files\" title=\"Leia mais na documentação do Django\">Veja o exemplo da documentação ofical do <em>Django</em></a>.</p>\n<h2>É a melhor maneira de resolver esse problema?</h2>\n<p>Caso a sua única opção seja retornar o dado através de uma <em>view</em> <em>Django</em>, sim. Além\nde um uso mais eficiente de memória, o retorno do <code class=\"language-text\">StreamingHttpResponse</code>\nvai impedir que, por exemplo, um <em>load balancer</em> feche a conexão do seu usuário pelo\nfato de o serviço <em>Django</em> estar levando muito tempo para montar a resposta.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 610px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4b7ece8243cfe756552c9dfb41282281/5aae9/biznis-cat.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.708333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKElEQVQoz2NgAAEmBmZORjZ+Fh4xBgFJFesQ0+h6j4YNNUuvda643NixIbtiVlDuBPOkVgHrcCYxVSYBGUZeKWZ5QwYWHUcmfhlmFl4GBg5jYbUEdedcr5S8gPKi8IbU2adzll5Jnnc+tXdHVMcGnZzpvFZhrEpmzDJ6LGrWbI7xDKx6bmwWQZyWQQzCio7iqjOtQ3ssgytMfGK9Mxzbt+u27FZt2aVas0k+b7GIVz6zhCqjkAIDpyjQmUzSugxMUqbM6i5s5hEMKjYeMmoVBnYlBvZxBnZxgTn6dRtESjdIVG/Xbd0hkjxV0C6RmVecgV2IgZGTiZGF18ibgVnTnVPPm9sokEHdJVJW+aSz+25Pvz6f+LbM1sTO9VETdibPO1U494CRd4qsvgu3nAGjoAIDAzubsKyQQwQDg4IFs5YTp7K5oKQ6AyP3NH2LCabWhrYR+rGNFhm91hn9XgUzXCJKFdXMeRWMOCW1GLnEgG5mldZlYudhYOaTZxRRY+STYuSXY+CWWqyiXK9uranhZO0YnV42Ja5uSWTrOtvEJh4hRU5RVQZRNUZOMUZWYSYWfgZGRqATRBg4xdk5RDU5Rdy5xc5qClbae/n4ZOblTs7r35m++HzZ7mch7Wu4ZYy4VKwZBBQZmXkZmTgZGdlAUWzNyp3BwdvHytHOwpHEIRAmICQnrcyu5SjikqUUVCEX0yQb3ynlmcMopsHII83AxMXIyApKF2AAANqtfDsY9XT+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;O Django com StreamingHttpResponse fica mais biznis (thelegomovie.wikia.com)&quot;\"\n        title=\"O Django com StreamingHttpResponse fica mais biznis (thelegomovie.wikia.com)\"\n        src=\"/static/4b7ece8243cfe756552c9dfb41282281/5aae9/biznis-cat.png\"\n        srcset=\"/static/4b7ece8243cfe756552c9dfb41282281/8514f/biznis-cat.png 192w,\n/static/4b7ece8243cfe756552c9dfb41282281/804b2/biznis-cat.png 384w,\n/static/4b7ece8243cfe756552c9dfb41282281/5aae9/biznis-cat.png 610w\"\n        sizes=\"(max-width: 610px) 100vw, 610px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">O Django com StreamingHttpResponse fica mais biznis (thelegomovie.wikia.com)</figcaption>\n  </figure></p>\n<p>Mas segundo a recomendação da <a href=\"https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.StreamingHttpResponse\" title=\"Veja mais na documentação do Django\">própria documentação</a>\ndo <code class=\"language-text\">StreamingHttpResponse</code>, já que essa é uma \"operação bloqueante\",\no ideal seria realizá-la em um <em>background job</em> (por exemplo) e deixar com que o\nusuário acesse essa informação quando ela já estiver pronta.</p>\n<p>O <code class=\"language-text\">django-report-builder</code> entrega essa <a href=\"https://django-report-builder.readthedocs.io/en/latest/quickstart/#asynchronous-report-generation\" title=\"Leia mais na documentação da biblioteca\">modalidade de \"asynchronous reports\"</a>\natravés do <a href=\"http://www.celeryproject.org/\" title=\"Celery: Distributed Task Queue\"><em>Celery</em></a>.</p>\n<h2>Considerações finais</h2>\n<p>É fato que a \"mágica pesada\" fica no lado do <a href=\"/tag/wsgi.html\" title=\"Leia mais sobre WSGI\"><em>WSGI</em></a>, como você pode ver <a href=\"https://andrewbrookins.com/django/how-does-djangos-streaminghttpresponse-work-exactly/#the-wsgi-server\" title=\"How does Django’s StreamingHttpResponse work, exactly?\">aqui</a>.\nO <em>Django</em> \"faz o que pode\" quando o assunto é lidar com grandes volumes de dados. Mas\no ideal é sempre deixar essa carga de processamento fora do ciclo de vida da requisição do usuário.</p>\n<p>Mesmo assim, o <code class=\"language-text\">StreamingHttpResponse</code> vem como uma boa alternativa para resolver\nalguns problemas de <em>views</em> com tempos de resposta e consumo de recursos muito altos, podendo\nser a solução ideal para alguns relatórios que você emite em sua aplicação.</p>\n<p>Até a próxima.</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"http://blog.aeguana.com/2015/12/12/csv-export-data-for-django-model/\"><em>Aeguana - How to export data as a CSV – Django model</em></a></li>\n<li><a href=\"https://andrewbrookins.com/django/how-does-djangos-streaminghttpresponse-work-exactly/\"><em>Andrew Brookins - How does Django's StreamingHttpResponse work, exactly?</em></a></li>\n<li><a href=\"https://docs.djangoproject.com/en/1.11/ref/request-response/#streaminghttpresponse-objects\"><em>Django Documentation - StreamingHttpResponse</em></a></li>\n<li><a href=\"http://www.ericcarmichael.com/streaming-django-responses-on-heroku.html\"><em>nerdery - Streaming Django responses on Heroku</em></a></li>\n<li><a href=\"http://www.rodvdka.co.za/heroku/long-polling/h12/h18/django/2016/10/13/long-polling-heroku.html\"><em>rodvdka - Django long running report on Django</em></a></li>\n<li><a href=\"http://stackoverflow.com/questions/33208849/python-django-streaming-video-mp4-file-using-httpresponse\"><em>Stackoverflow - Streaming video/mp4 file using HttpResponse</em></a></li>\n<li><a href=\"http://stackoverflow.com/questions/1756096/understanding-generators-in-python\"><em>Stackoverflow - Understanding Generators in Python</em></a></li>\n</ul>","excerpt":"Recentemente na Loadsmart,\nhouve a necessidade de lidar com um cenário onde se faz necessário acessar uma view\nque retorna um CSV de tamanho…","frontmatter":{"date":"2017-05-14T15:45:00.000Z","title":"Streamando dados no Django","tags":["desenvolvimento-web","python","django","streaming","generators","wsgi","csv"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQ4y61UbW/SUBTmhxvnd92nJdsXv5joFnUui4kkGjfGXoCJoOVFOlrWlltKKVA6wEWgt4+3pesKFHTiSW7uW/uc5zn3nBPDf7ZY1KHjOMEcXv8T4DxYGHRthn86iwScl+UNOt13dBMt0o6W76wAnGHgz79uR6iVZBBRiwzBstjG5sEopRiYAxTTPLgUD6EgeVfUpow5DRzOO7nbBwzdH2q8Cv60iMzOe1y+OoFyxiF/Xl6QJReu0e/2Fx7xXrLLjG0y2wfgHu+g+jIOMStAOTzFxWEKV3kR2bdJiCd5CPsJVNiwqROZGTOSr86KMEsiDLXtOWiUFRw/e4Pc5h4SG8/x+ckLpJ/ugvuYhSJokCvEi3GvbS1K7uo9aPXpi1pMjj2eeGvyTUDtIIG2QFD8IiBzVMB5PIfMpzxE9mh63YA9sUOAPnX1uomBNQxkTBigVK5jNLbhfm5oJgzSQZOlUVMxoMktDG5+LsgOGN6wl5V5gvFogoakQ9e6EH8Q5BijnmGBz4n4elxA+nUS9e+1pdU1E0MXlAgN9MwhzIqEapJDpztEh4G71hJVVD+kcNufMnPVzRZFVGL7pl2WUHq0BTV+AYs5WlWK4fWS0qNeZbVSHKR3R7Dv8p76dys60JLmcF+CTrgqIhL5Ye3LL7WH9MS/brBrAa5jvwEi7w0wG7BW1QAAAABJRU5ErkJggg==","width":180,"height":180,"src":"/static/d2dedad07b8314159f8d999aa3b9e847/d8216/django-pony.png","srcSet":"/static/d2dedad07b8314159f8d999aa3b9e847/d8216/django-pony.png 1x"}},"publicURL":"/static/d2dedad07b8314159f8d999aa3b9e847/django-pony.png"}},"fields":{"readingTime":{"minutes":4.42},"slug":"/2017/05/14/streaming-dados-django.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2017/05/14/streaming-dados-django.html"}},"staticQueryHashes":["2831923220","4114525740"]}