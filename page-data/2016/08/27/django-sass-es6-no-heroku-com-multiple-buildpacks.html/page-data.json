{"componentChunkName":"component---src-templates-blog-post-js","path":"/2016/08/27/django-sass-es6-no-heroku-com-multiple-buildpacks.html","result":{"data":{"markdownRemark":{"html":"<p>Anteriormente, falamos sobre como utilizar o <code class=\"language-text\">django-compressor</code> com <a href=\"/tag/sass.html\" title=\"Leia mais sobre Sass\"><em>Sass</em></a>\ne <a href=\"/tag/es6.html\" title=\"Leia mais sobre ES6\"><em>ES6</em></a>. Se você quisesse utilizar o <em>Heroku</em>,\ncom uma aplicação <a href=\"/tag/python.html\" title=\"Leia mais sobre Python\"><em>Python</em></a> executando operações de <em>build</em>\nem <a href=\"/tag/node.html\" title=\"Leia mais sobre Node.JS\"><em>Node.js</em></a>, seria uma tarefa um tanto árdua,\nque exigiria um certo nível de paciência na\nconstrução do seu próprio <em>Buildpack</em>. Hoje, com o <em>Multiple Buildpacks</em>, isso não é mais necessário.</p>\n<h2>Build o quê?</h2>\n<p><em>Buildpack</em>.</p>\n<p>São conjuntos de scripts que, dependendo da linguagem de programação que você escolher,\nresolverão dependências, geração de <em>assets</em> e até mesmo compilação arquivos, dentro da plataforma <em>Heroku</em>.</p>\n<p>Ou seja, eles são uma espécie de \"provisionamento\", onde você escreverá uma série de\ninstruções que deixarão o ambiente preparado para receber o seu projeto.</p>\n<p>Antigamente, para você trabalhar com compilação/transpilação de <em>assets</em> em um projeto\n<em>Django</em> no <em>Heroku</em>, você tinha duas opções:</p>\n<ul>\n<li>Utilizar (ou construir) um <em>Buildpack</em> customizado que realizasse o procedimento de instalação das dependências e build (como o <a href=\"https://github.com/jiaaro/heroku-buildpack-django\" title=\"Veja o repositório no GitHub\">heroku-buildpack-django</a>);</li>\n<li>\"Commitar\" os arquivos \"buildados\" e utilizar o <em>Buildpack Python</em> padrão.</li>\n</ul>\n<p>Eu nunca tive muita paciência com a questão de provisionamento no <em>Heroku</em>,\nentão geralmente eu partia para a ignorância e vivia \"commitando\" <em>CSS</em> e <em>JS</em> compilados.</p>\n<h2>Repita comigo: Nunca mais vou commitar arquivos compilados</h2>\n<p>É uma péssima ideia! Principalmente quando você está trabalhando em uma equipe grande.\nA quantidade de <em>merge hells</em> envolvendo arquivos compilados é aquele tipo de dor de\ncabeça que você deveria evitar desde o princípio.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a5e7fde62eb0da75c7d6193857640faa/c08c5/multipack-pacific-rim.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHISawFD//EABoQAAICAwAAAAAAAAAAAAAAAAECABEQEjH/2gAIAQEAAQUCAXVas9WLj//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAQEBAAAAAAAAAAAAAAAAABABMf/aAAgBAQAGPwLWv//EABkQAQADAQEAAAAAAAAAAAAAAAEAESFRYf/aAAgBAQABPyG4eK3sKQsziDD5FTnGKrs//9oADAMBAAIAAwAAABD7H//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/EFf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhYTFB/9oACAEBAAE/EK0oaJu+D2KDaGsdgsFnNgLgQsD8yM6kRMeS5K2f/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Não dá pra pilotar um Jaeger sozinho (deadline.com)&quot;\"\n        title=\"Não dá pra pilotar um Jaeger sozinho (deadline.com)\"\n        src=\"/static/a5e7fde62eb0da75c7d6193857640faa/c08c5/multipack-pacific-rim.jpg\"\n        srcset=\"/static/a5e7fde62eb0da75c7d6193857640faa/7809d/multipack-pacific-rim.jpg 192w,\n/static/a5e7fde62eb0da75c7d6193857640faa/4ecad/multipack-pacific-rim.jpg 384w,\n/static/a5e7fde62eb0da75c7d6193857640faa/c08c5/multipack-pacific-rim.jpg 640w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Não dá pra pilotar um Jaeger sozinho (deadline.com)</figcaption>\n  </figure></p>\n<p>De forma bem resumida, vamos ilustrar como funcionaria o fluxo de <em>build</em> de estáticos com\nmúltiplos <em>Buildpacks</em>. Para começar, vamos criar um novo <em>app</em> no <em>Heroku</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ heroku create</code></pre></div>\n<p>Caso você tenha dúvidas sobre como criar um projeto <em>Python</em> no <em>Heroku</em>,\no \"<a href=\"https://devcenter.heroku.com/articles/getting-started-with-python#introduction\" title=\"Leia documentação oficial\">Getting started</a>\" deles é muito bacana e fácil de seguir.</p>\n<p>Supondo que já instalamos o <em>Django</em>, e que criamos os arquivos <code class=\"language-text\">runtime.txt</code>,\ndeterminando qual a versão do <em>Python</em> que usaremos, e <code class=\"language-text\">requirements.txt</code>,\npara resolução de dependências, automaticamente o <em>Heroku</em> saberá preparar\no ambiente para o nosso projeto.</p>\n<p>Mas caso você queira ter certeza disso, podemos usar o comando <code class=\"language-text\">buildpacks:set</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ heroku buildpacks:set heroku/python</code></pre></div>\n<p>Como no <a href=\"/2016/06/04/django-e-sass-com-django-compressor.html\" title=\"Django e Sass com django-compressor\"><em>post</em> sobre <em>Django</em> e <em>Sass</em></a>,\nutilizaremos a biblioteca <em>Python</em> <code class=\"language-text\">libsass</code>. Logo, vamos adicioná-la ao <code class=\"language-text\">requirements.txt</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># requirements.txt\n\nDjango\ndjango-compressor\nlibsass</code></pre></div>\n<p>Não podemos deixar de configurar o <code class=\"language-text\">django-compressor</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># settings.py</span>\n\nCOMPRESS_PRECOMPILERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">'text/x-sass'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sassc {infile} {outfile}'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Mas e o <em>ES6</em>? Precisaremos do <a href=\"/tag/babel.html\" title=\"Leia mais sobre BabelJS\">BabelJS</a>,\ne consequentemente do <em>Node.js</em>, para realizar o <em>transpiling</em>.</p>\n<h2>Python + Node.js em uma mesma instância Heroku</h2>\n<p>Para adicionar um novo <em>Buildpack</em>, temos o seguinte comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ heroku buildpacks:add --index 1 heroku/nodejs</code></pre></div>\n<p>Onde <code class=\"language-text\">--index</code> determina qual será a ordem de execução do <em>Buildpack</em>.\nNesse caso, opto por ele ser o primeiro e o do <em>Python</em> segundo,\nsomente para garantir que todas as dependências estejam sanadas quando\na resolução de estáticos do <em>Django</em> acontecer.</p>\n<p>O <em>Buildpack Python</em> executa operações dependendo de alguns arquivos\ndo nosso projeto. Por exemplo, como mencionado acima, precisamos especificar\na versão da linguagem (<code class=\"language-text\">runtime.txt</code>), instalar as dependências do projeto\n(<code class=\"language-text\">requirements.txt</code>) e no caso do <em>Django</em>, executar a operação de\n<code class=\"language-text\">collectstatic</code> após o deploy (<code class=\"language-text\">manage.py</code>).</p>\n<p>No caso do <em>Node.js</em>, precisaremos ter um arquivo <code class=\"language-text\">package.json</code> na raíz do\nprojeto, contendo todas as bibliotecas que o projeto usa, para essa linguagem:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ npm init .\n$ npm install --save babelify babel-preset-es2015</code></pre></div>\n<p>Não podemos esquecer do <code class=\"language-text\">.babelrc</code>, essencial para a execução do <em>Babel</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// .babelrc</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"presets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"es2015\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>E por fim, falta adicionar o pré-compilador ao <code class=\"language-text\">django-compressor</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># settings.py</span>\n\nCOMPRESS_PRECOMPILERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">'text/x-sass'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sassc {infile} {outfile}'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">'text/es6'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'./node_modules/.bin/browserify {infile} -t babelify --outfile {outfile}'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Pronto! Ao dar o <code class=\"language-text\">git push heroku master</code>, a plataforma executará primeiro o\n<em>Buildback Node.js</em>, e na sequência o <em>Buildpack Python</em>. No momento de entrega das\npáginas, teremos os binários <code class=\"language-text\">browserify</code> e <code class=\"language-text\">sassc</code> instalados em nossa instância,\ne poderemos entregar nossas páginas com <em>CSS</em> e <em>JS</em> compilados sem a necessidade de \"commitá-los\".</p>\n<h2>Comprimindo no momento do deploy</h2>\n<p>Comprimir/compilar <em>assets</em> no momento da requisição também é algo que deve ser evitado.\nEmbora o <em>Django Compressor</em> faça um excelente trabalho nesse quesito, se estivermos usando\numa <em>CDN</em> para a entrega desses estáticos, esse procedimento não deve acontecer durante a requisição de um usuário.</p>\n<p>Para executar o comando <code class=\"language-text\">compress</code> da biblioteca <code class=\"language-text\">django-compressor</code> em tempo de <em>deploy</em>,\nbasta fazermos duas coisas:</p>\n<ul>\n<li>Garantir que <code class=\"language-text\">COMPRESS_OFFLINE</code>, na configuração do seu projeto, esteja setado como <code class=\"language-text\">True</code>;</li>\n<li>Criar um diretório <code class=\"language-text\">bin</code>, e dentro dele um arquivo <code class=\"language-text\">post_compile</code>, com a instrução de <code class=\"language-text\">compress</code>.</li>\n</ul>\n<p>Exemplo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\npython manage.py compress</code></pre></div>\n<p>Feito! Agora a cada <em>deploy</em> da sua aplicação, o <em>build</em> dos <em>assets</em> acontecerá\nautomaticamente, dispensando assim a necessidade de ficar enviando <em>CSS</em> e <em>JS</em> \"buildados\"\natravés de <code class=\"language-text\">git push</code>.</p>\n<p>Dúvidas sobre a relação entre Django, Sass e ES6? Eu a detalho um pouco melhor nesses dois posts:</p>\n<ul>\n<li><a href=\"http://klauslaube.com.br/2016/06/20/django-e-es6-com-django-compressor.html\">Django e ES6 com django-compressor</a></li>\n<li><a href=\"http://klauslaube.com.br/2016/06/04/django-e-sass-com-django-compressor.html\">Django e Sass com django-compressor</a></li>\n</ul>\n<p>Até a próxima.</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"https://devcenter.heroku.com/articles/using-multiple-buildpacks-for-an-app\">Heroku Dev Center: Using Multiple Buildpacks for an App</a></li>\n</ul>","excerpt":"Anteriormente, falamos sobre como utilizar o  com Sass\ne ES6. Se você quisesse utilizar o Heroku,\ncom uma aplicação Python executando…","frontmatter":{"date":"2016-08-27T16:00:00.000Z","title":"Django, Sass e ES6 no Heroku com Multiple Buildpacks","tags":["desenvolvimento","web","python","django","sass","es6","css","js","heroku","buildpack"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAACcElEQVQ4y42UaU8aURSG/XetbK0gyC7GKMgmUsSNTWDYhdLKYIWh7FDBoiKirQuaLvFD05/gx8YPNukPQPpSGrUEismZydx7z3POee89d4bGJcSdyaSuiXGXrL9h9aH/0MOBYMzG51nx7mlYGuNae8DIKeSvOlaThfxx8m09mzlKpw5Tyb/WGeZzx35fQSSww/kelkkJTM1qwvWDS6OB1M+tK+SBWW3YOB+dN5AwpWJNpQzN6V7vV7+sLG2iig7fgV18ns1iohJUjfbUoFYGt96dmk3xUbYJpUrFzlSyHo3s0IeN4VDJ583zRi3/wAiGkNn0BxZz0evJtVqtncoFFEpEjmr1M4alrTMWY3EjuusmMpjvhk3LsUz6iElfcNpT8Eby4ScGpD1vfD+sX+IDhZDrFbcr+z+YcKQBb5cbL/SRZOIgSlagWSx0oNrIQNjjygJuNpu3t61bPK3Wzc0vnfYV+/kKGRkEQ9X19c+93U8QPzXpQ/3g/d4Cg7YQJXf6wjhSCJNP+cGMss04+RHW8uabPcDY5IFwHcKwN8AmJzwwxKLi+38yD4LRRs+YS1ZLIuArcDlmwJwRExV7HNzR7CIy2CenI4W2Q4h4rNou2/MIGB7Yp6urH+hWqZiA8gTVzhwMFBk04wa52wNGe6IfqXiNSV/UasLyaT8wLHE5FrTt6ck39Dzioj297lwXTAj5dr1uvVb7qpoJqmbW8NaqwxpVSKt+qZj2wwczOIXK+wuLmUKme7iTHApDwa3t8nk+97FYOMHd7FixeFIuNfBRLp1BM7q9x8+grZxnEwscEpGzp6FDsTV9/yR3t7yfdTn8BrowWHz7lKdaAAAAAElFTkSuQmCC","width":180,"height":180,"src":"/static/970dc11c79fd02b80ec38266e0ec561d/d8216/heroku-logo.png","srcSet":"/static/970dc11c79fd02b80ec38266e0ec561d/d8216/heroku-logo.png 1x"}},"publicURL":"/static/970dc11c79fd02b80ec38266e0ec561d/heroku-logo.png"}},"fields":{"readingTime":{"minutes":4.355},"slug":"/2016/08/27/django-sass-es6-no-heroku-com-multiple-buildpacks.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2016/08/27/django-sass-es6-no-heroku-com-multiple-buildpacks.html"}}}