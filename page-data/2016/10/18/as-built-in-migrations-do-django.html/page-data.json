{"componentChunkName":"component---src-templates-blog-post-js","path":"/2016/10/18/as-built-in-migrations-do-django.html","result":{"data":{"markdownRemark":{"html":"<p>Quem usa o <a href=\"/tag/django.html\" title=\"Leia mais sobre Django\"><em>Django</em></a> há mais tempo já ouviu\nfalar do <a href=\"/tag/south.html\" title=\"Leia mais sobre South\"><em>South</em></a>. Famosa biblioteca\nresponsável por trazer o comportamento de <a href=\"/tag/migrations.html\" title=\"Leia mais sobre Migrations\"><em>migrations</em></a>\npara o <em>Django</em>. Sem dúvida impactou inúmeros projetos e transformou o processo de\n<em>deploy</em> de toda a comunidade envolvida com o <em>framework</em>.</p>\n<p>Nas versões mais recentes do <em>Django</em>, contamos com um <em>engine</em> <em>built-in</em>,\nmuito prático, e que traz alguns conceitos que ficaram famosos com o <em>South</em>.</p>\n<p>Vamos nessa dar adeus ao <code class=\"language-text\">syncdb</code>, e começar a nossa aventura com o <code class=\"language-text\">migrate</code>.</p>\n<h2>O que são migrations?</h2>\n<p>Diretamente da documentação do <em>South</em>:</p>\n<blockquote>\n<p>(...) são uma forma de alterar o schema do seu banco de dados de uma versão para outra.</p>\n</blockquote>\n<p>Você mantém em seu projeto uma série de instruções que modificam o <em>database</em>\nde acordo com a evolução do projeto. Quando uma nova pessoa fizer parte do time,\nnão é necessário a realização de nenhum \"dump\" <em>SQL</em>, apenas a execução dessas <em>migrations</em>\né o suficiente para você ter o <em>db</em> pronto para uso.</p>\n<p>Dentro do ecossistema <em>Django</em>, as <em>built-in migrations</em> vieram como uma excelente\ncontribuição ao projeto. A distribuição de <em>apps</em> fica mais coerente, agora que o\ndesenvolvedor não precisa mais de uma \"segunda biblioteca\" para passar a usar\num app que estamos distribuindo.</p>\n<h2>Faça migrations</h2>\n<p>Para exemplificar como toda essa mágica funciona, vamos criar um <em>app</em> chamado \"lista<em>de</em>compras\":</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py startapp lista_de_compras</code></pre></div>\n<p>Nosso <em>application</em> terá uma estrutura similar a essa:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">lista_de_compras/\n    __init__.py\n    admin.py\n    apps.py\n    migrations/\n        __init__.py\n    models.py\n    tests.py\n    views.py</code></pre></div>\n<p>Não esqueça de adicioná-lo ao <code class=\"language-text\">INSTALLED_APPS</code>.</p>\n<p>Vamos nos focar na pasta <code class=\"language-text\">migrations</code> e no <code class=\"language-text\">models.py</code>. Nesse último, criaremos o modelo <code class=\"language-text\">Item</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># models.py</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Item</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    nome <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n    quantidade <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>IntegerField<span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Agora, na linha de comando, invocamos o comando de criação de <em>migrations</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py makemigrations</code></pre></div>\n<p>Se tudo ocorreu bem, na pasta <code class=\"language-text\">migrations</code> do <em>app</em>, um novo arquivo\n<a href=\"/tag/python.html\" title=\"Leia mais sobre Python\"><em>Python</em></a> foi criado:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># migrations/0001_initial.py</span>\n\n<span class=\"token keyword\">from</span> __future__ <span class=\"token keyword\">import</span> unicode_literals\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>db <span class=\"token keyword\">import</span> migrations<span class=\"token punctuation\">,</span> models\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Migration</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">.</span>Migration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    initial <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n\n    dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">]</span>\n\n    operations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        migrations<span class=\"token punctuation\">.</span>CreateModel<span class=\"token punctuation\">(</span>\n            name<span class=\"token operator\">=</span><span class=\"token string\">'Item'</span><span class=\"token punctuation\">,</span>\n            fields<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> models<span class=\"token punctuation\">.</span>AutoField<span class=\"token punctuation\">(</span>auto_created<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> primary_key<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> serialize<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'ID'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span><span class=\"token string\">'nome'</span><span class=\"token punctuation\">,</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span><span class=\"token string\">'quantidade'</span><span class=\"token punctuation\">,</span> models<span class=\"token punctuation\">.</span>IntegerField<span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p>Por partes:</p>\n<p>O <code class=\"language-text\">unicode_literals</code> é uma ferramenta que torna possível a execução de seu projeto em <em>Python</em> 2 e 3.\nEla tem a função de \"marcar\" suas <em>strings</em> como <em>unicode</em>, como explicado na <a href=\"https://docs.djangoproject.com/en/1.10/topics/migrations/#supporting-python-2-and-3\" title=\"Suportando Python 2 e 3\">documentação do <em>Django</em></a>.</p>\n<p>É criada (automaticamente) uma classe <code class=\"language-text\">Migration</code> herdando de <code class=\"language-text\">migrations.Migration</code>. Nela, temos\n3 propriedades muito importantes:</p>\n<ul>\n<li><code class=\"language-text\">initial</code>: Informamos explicitamente ao <em>Django</em> que essa é a <em>migration</em> inicial do <em>app</em>. Essa\ninformação é importante para alguns casos, como quando é <a href=\"https://docs.djangoproject.com/en/1.10/topics/migrations/#django.db.migrations.Migration.initial\" title=\"Leia mais na documentação do Django\">preciso executar o --fake-initial</a>.</li>\n<li><code class=\"language-text\">dependencies</code>: Aqui informamos as dependências da nossa <em>migration</em>. Por exemplo, se dependermos\nde outra <em>migration</em> ou <em>app</em>, precisamos deixar claro que há uma dependência para manter uma ordem\ncoerente de execução.</li>\n<li><code class=\"language-text\">operations</code>: Por fim, as operações que precisam ser executadas. No exemplo acima, estamos criando\na tabela <code class=\"language-text\">lista_de_compras_item</code>, com os campos <code class=\"language-text\">id</code>, <code class=\"language-text\">nome</code> e <code class=\"language-text\">quantidade</code>.</li>\n</ul>\n<h2>No more syncdb</h2>\n<p>Calma! A tabela ainda não existe no banco dados. Para que isso aconteça é necessário executar o comando\n<code class=\"language-text\">migrate</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py migrate</code></pre></div>\n<p><code class=\"language-text\">migrate</code> executará todas as <em>migrations</em> pendentes do seu projeto. Caso queira executar\napenas de um <em>app</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py migrate lista_de_compras</code></pre></div>\n<h2>Evoluindo o Schema</h2>\n<p>Vamos supor que exista o requisito de criar um <a href=\"/tag/rest.html\" title=\"Leia mais sobre REST\"><em>API REST</em></a> para o projeto,\nlogo, expor o campo <code class=\"language-text\">id</code> não é uma boa prática! Precisamos de um campo único e não\nsequencial, que trará um pouco de <em>obfuscation</em> e segurança ao nosso <em>endpoint</em>.</p>\n<p>Primeiro, adicionamos o campo ao modelo:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># models.py</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Item</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    uuid <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>UUIDField<span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span>uuid<span class=\"token punctuation\">.</span>uuid4<span class=\"token punctuation\">,</span> editable<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> unique<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    nome <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n    quantidade <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>IntegerField<span class=\"token punctuation\">(</span>default<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Seguindo o procedimento, para homologar as alterações em uma <em>migration</em>, precisamos do <code class=\"language-text\">makemigrations</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py makemigrations lista_de_compras</code></pre></div>\n<p>Se você executar o <code class=\"language-text\">migrate</code> em um banco de dados vazio, provavelmente não terá nenhum problema. Mas\nem um banco já existente, provavelmente uma <em>exception</em> acontecerá. O fato é que o uso do campo <code class=\"language-text\">unique</code>\ne o campo <code class=\"language-text\">default</code>, em uma <em>migration</em>, não é tão <a href=\"https://code.djangoproject.com/ticket/23932\" title=\"Document how to set a unique value for new fields using migrations\">intuitivo como parece</a>.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/886cfa7973442256a4caa2fc8bba883f/c08c5/croods-migration.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQD/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAP/2gAMAwEAAhADEAAAAcsYlIWJB//EABcQAQEBAQAAAAAAAAAAAAAAAAEAERL/2gAIAQEAAQUCULobC1XW6b//xAAXEQEAAwAAAAAAAAAAAAAAAAAAARIT/9oACAEDAQE/Ac1Jf//EABURAQEAAAAAAAAAAAAAAAAAAAAS/9oACAECAQE/AaU//8QAGBAAAgMAAAAAAAAAAAAAAAAAARAAITH/2gAIAQEABj8C2WGF/8QAGxAAAgIDAQAAAAAAAAAAAAAAAAFBUREhMWH/2gAIAQEAAT8h5uitGrkTdHsZhtwXJGiT/9oADAMBAAIAAwAAABCwP//EABcRAQEBAQAAAAAAAAAAAAAAAAEAMWH/2gAIAQMBAT8QCbdL/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAERUf/aAAgBAgEBPxCcqv/EABoQAQADAQEBAAAAAAAAAAAAAAEAESExUYH/2gAIAQEAAT8QtanSsKiI8FRnZZ4i4a4+QwXoxKIGAT//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Migrar é preciso (indiewire.com)&quot;\"\n        title=\"Migrar é preciso (indiewire.com)\"\n        src=\"/static/886cfa7973442256a4caa2fc8bba883f/c08c5/croods-migration.jpg\"\n        srcset=\"/static/886cfa7973442256a4caa2fc8bba883f/7809d/croods-migration.jpg 192w,\n/static/886cfa7973442256a4caa2fc8bba883f/4ecad/croods-migration.jpg 384w,\n/static/886cfa7973442256a4caa2fc8bba883f/c08c5/croods-migration.jpg 640w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Migrar é preciso (indiewire.com)</figcaption>\n  </figure></p>\n<p>Para fazer esse procedimento, vamos seguir as recomendações da <a href=\"https://docs.djangoproject.com/en/1.10/howto/writing-migrations/#migrations-that-add-unique-fields\" title=\"Migrations that add unique fields\">documentação do Django</a>.</p>\n<p>Primeiro, removemos os atributos <code class=\"language-text\">unique=True</code> e <code class=\"language-text\">default=uuid.uuid4</code> da <em>migration</em> recém criada, e adicionamos\no parâmetro <code class=\"language-text\">null=True</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># migrations/0002_item_uuid.py</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Migration</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">.</span>Migration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">(</span><span class=\"token string\">'lista_de_compras'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0001_initial'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n    operations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        migrations<span class=\"token punctuation\">.</span>AddField<span class=\"token punctuation\">(</span>\n            model_name<span class=\"token operator\">=</span><span class=\"token string\">'item'</span><span class=\"token punctuation\">,</span>\n            name<span class=\"token operator\">=</span><span class=\"token string\">'uuid'</span><span class=\"token punctuation\">,</span>\n            field<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>UUIDField<span class=\"token punctuation\">(</span>editable<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> null<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p>O próximo passo é popular as linhas já existentes com <code class=\"language-text\">uuids</code>. Faremos isso através de <em>data migrations</em>.</p>\n<h2>Data migrations</h2>\n<p>Diretamente da documentação do <em>Django</em>:</p>\n<blockquote>\n<p>Migrations that alter data are usually called “data migrations”;\nthey’re best written as separate migrations, sitting alongside your schema migrations.</p>\n</blockquote>\n<p>Em alguns casos precisamos inserir ou alterar dados, de acordo com a evolução do <em>database</em>\ndo nosso projeto. O <em>Django</em> não possui nenhuma forma \"automática\" para geração de\n<em>data migrations</em>, por isso, o caminho ideal é utilizar o comando <code class=\"language-text\">--empty</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py makemigrations --empty lista_de_compras</code></pre></div>\n<p>Com isso, uma <em>migration</em> \"em branco\" será criada, pronta para customização:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># migrations/0003_auto_20161010_1635.py</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Migration</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">.</span>Migration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">(</span><span class=\"token string\">'lista_de_compras'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0002_item_uuid'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n    operations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p>Importante notar que agora o atributo <code class=\"language-text\">dependencies</code> está preenchido com a <em>migration</em>\nanterior à recém criada. É sempre necessário ter atenção à sua lista de dependências,\npara certificar-se que o fluxo acontecerá numa ordem coerente.</p>\n<p>Criaremos a função responsável por inserir <em>UUIDs</em> nos registros já existentes:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># migrations/0003_auto_20161010_1635.py</span>\n<span class=\"token keyword\">import</span> uuid\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">gen_uuid</span><span class=\"token punctuation\">(</span>apps<span class=\"token punctuation\">,</span> schema_editor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    Item <span class=\"token operator\">=</span> apps<span class=\"token punctuation\">.</span>get_model<span class=\"token punctuation\">(</span><span class=\"token string\">'lista_de_compras'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Item'</span><span class=\"token punctuation\">)</span>\n    items <span class=\"token operator\">=</span> Item<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items<span class=\"token punctuation\">:</span>\n        item<span class=\"token punctuation\">.</span>uuid <span class=\"token operator\">=</span> uuid<span class=\"token punctuation\">.</span>uuid4<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        item<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Usamos o parâmetro <code class=\"language-text\">apps</code> para \"importar\" o modelo. Na sequência, utilizamos o <em>ORM</em>\npara pegar todos os items do banco de dados, iteramos por eles preenchendo o campo\n<code class=\"language-text\">uuid</code>.</p>\n<p>Precisamos adicionar essa função ao atributo <code class=\"language-text\">operations</code>, da <em>migration</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># migrations/0003_auto_20161010_1635.py</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Migration</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">.</span>Migration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">(</span><span class=\"token string\">'lista_de_compras'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0002_item_uuid'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n    operations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        migrations<span class=\"token punctuation\">.</span>RunPython<span class=\"token punctuation\">(</span>gen_uuid<span class=\"token punctuation\">,</span> reverse_code<span class=\"token operator\">=</span>migrations<span class=\"token punctuation\">.</span>RunPython<span class=\"token punctuation\">.</span>noop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p>Utilizamos a função <code class=\"language-text\">RunPython</code> para executar operações em nossa <em>migration</em>\nque dependem de processamento por parte da linguagem (ou do <em>Django</em>). Em alguns\ncenários, esse tipo de operação não tem um processo de <em>rollback</em>, portanto,\ndeixamos explícito que não temos como desfazer a operação através do parâmetro\n<code class=\"language-text\">reverse_code</code> com valor <code class=\"language-text\">migrations.RunPython.noop</code>.</p>\n<p>A <em>migration</em> deve ter ficado mais ou menos assim:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># migrations/0003_auto_20161010_1635.py</span>\n<span class=\"token keyword\">from</span> __future__ <span class=\"token keyword\">import</span> unicode_literals\n\n<span class=\"token keyword\">import</span> uuid\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>db <span class=\"token keyword\">import</span> migrations<span class=\"token punctuation\">,</span> transaction\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">gen_uuid</span><span class=\"token punctuation\">(</span>apps<span class=\"token punctuation\">,</span> schema_editor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    Item <span class=\"token operator\">=</span> apps<span class=\"token punctuation\">.</span>get_model<span class=\"token punctuation\">(</span><span class=\"token string\">'lista_de_compras'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Item'</span><span class=\"token punctuation\">)</span>\n    items <span class=\"token operator\">=</span> Item<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items<span class=\"token punctuation\">:</span>\n        item<span class=\"token punctuation\">.</span>uuid <span class=\"token operator\">=</span> uuid<span class=\"token punctuation\">.</span>uuid4<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        item<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Migration</span><span class=\"token punctuation\">(</span>migrations<span class=\"token punctuation\">.</span>Migration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">(</span><span class=\"token string\">'lista_de_compras'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0002_item_uuid'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n    operations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        migrations<span class=\"token punctuation\">.</span>RunPython<span class=\"token punctuation\">(</span>gen_uuid<span class=\"token punctuation\">,</span> reverse_code<span class=\"token operator\">=</span>migrations<span class=\"token punctuation\">.</span>RunPython<span class=\"token punctuation\">.</span>noop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p>Ainda não acabou! Uma vez que todos os registros já possuam o seu <code class=\"language-text\">uuid</code>\npreenchido, precisamos voltar à proposta original do nosso modelo: Com\num campo default, e com preenchimento obrigatório. Para tanto, basta\nexecutar novamente o <code class=\"language-text\">makemigrations</code>. Uma nova <em>migration</em> será criada,\ncom todas as <em>constraints</em> definidas corretamente.</p>\n<p>Agora rode o <code class=\"language-text\">migrate</code>. Acabamos de criar um campo <code class=\"language-text\">uuid</code>,\npreenchemos os registros já existentes no <em>database</em>, e criamos\n<em>constraints</em> para os registros que virão no futuro.</p>\n<p>Até a próxima.</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"https://docs.djangoproject.com/en/1.10/topics/migrations/\">Django documentation: Migrations</a></li>\n<li><a href=\"https://south.readthedocs.io/en/latest/whataremigrations.html\">South documentation: What are migrations?</a></li>\n</ul>","excerpt":"Quem usa o Django há mais tempo já ouviu\nfalar do South. Famosa biblioteca\nresponsável por trazer o comportamento de migrations\npara o…","frontmatter":{"date":"2016-10-18T12:43:00.000Z","title":"As built-in migrations do Django","tags":["desenvolvimento-web","migrations","python","django","south","banco-de-dados"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACe0lEQVQ4y6WV/UtTYRTH/Rv6A4qgLNN02Wb5vqlbNF0mZTW3dG1uWsu0DFeUxCiIQdEvkRQlGb35i4FpSKnJ7BW1sQqi8odICi0pMpe4t2/Pc9a9qHgvky483Hue+5zP/Z7nOefchI2OIkiNdHsh4nk/d11CPA7KGi0NYV7FbYd2aUBh0YbqAqyrykEyG3wu1ZqPpMosrN+Xt2gUkkCugDuVnqiE1/8cj31PkFtnQFOLG0PvfDjf3kIf4splFQovM2q3ELDqbB2ES92wHXd6O+j51YfXWGXKYOt00kBxz5i6FEsulu9SoOykBdFoFLPBWeiOlsN5wYWel/1wXz+HZLZGUiGfVLJ7mk1Dykxn9uPwxWYW2iVSFAwFUXLMhLxD21Bxuhb6JiMUbH8XPRRhQlGtQZZTj4dDA1h4hSNhaFjIV7tukT3ge4rV5k1QSYWsqtFhLTu9u333yGF6JsCcb4q2ALzSeYPsvhEvEs2bpYFcXc7BEnz7OUkO/BSXGRJR1mwRgep4gZQiLL/0LiOmAr/Jweqpx0qjku4xYCQGvB+3wgJkO4sx8eM7ObT1tGPF7nTscTvIDoVDC4CD8kBhD1sf3BYPwj/6Fr6Pb0S78MgOXOuOHUrvsIxCsczsLA3sRbjc2Yavk+OIsDARBX5NT+HT+Bjy60vR4e0mYNezR/IK5xb6mr2ZyDywFYbjZiq9YlcF1TDf67GJLwTkGSAAJWtZgPLweVNIYQnOk5xXhLaxHIP+F2L4fG9lK0WqbXEFqVY1bJ4GvP88isDMH5xq9bDGkC3CltQPYyWpRRIDcNXaxp0Ek2rAssB5df5PTZpNTQ32v4DzO5H87+Ev3E2COGrAjDwAAAAASUVORK5CYII=","width":180,"height":180,"src":"/static/46012f1b5a5e44b0747baafa90e04f8a/d8216/django-logo.png","srcSet":"/static/46012f1b5a5e44b0747baafa90e04f8a/d8216/django-logo.png 1x"}},"publicURL":"/static/46012f1b5a5e44b0747baafa90e04f8a/django-logo.png"}},"fields":{"readingTime":{"minutes":6.15},"slug":"/2016/10/18/as-built-in-migrations-do-django.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2016/10/18/as-built-in-migrations-do-django.html"}}}