{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018/01/05/testando-apps-django-com-tox.html","result":{"data":{"markdownRemark":{"html":"<p>O <a href=\"https://docs.djangoproject.com/pt-br/2.0/releases/2.0/\" title=\"Django 2.0 release notes\"><em>Django 2.0</em></a> foi lançado,\ne com ele o suporte a <a href=\"/tag/python.html\" title=\"Leia mais sobre Python\"><em>Python</em></a> <code class=\"language-text\">2.7</code> deixa de existir para\nas próximas versões do <em>framework</em>. Alegria para os usuários, preocupação para os desenvolvedores\ndos <a href=\"http://henriquebastos.net/desmistificando-o-conceito-de-django-apps/\" title=\"Desmistificando O Conceito De Django Apps\"><em>apps</em></a>.\nAfinal, a versão <code class=\"language-text\">1.11</code> é <em>LTS</em> (Long Term Support), logo, alguns <em>apps</em> (ainda) não podem abraçar\nincondicionalmente a versão <code class=\"language-text\">3.x</code> da linguagem.</p>\n<p>É nesse cenário que bibliotecas como o <a href=\"http://six.readthedocs.io/\" title=\"Python 2 and 3 Compatibility Library\"><em>six</em></a>\ne <a href=\"https://tox.readthedocs.io/en/latest/\" title=\"Standardize testing in Python\"><em>tox</em></a> mostram o seu valor. Nesse artigo,\nvamos falar um pouquinho mais sobre a última.</p>\n<h2>Antes de começar: Vida longa ao Python 3!</h2>\n<p>O <em>Python 2</em> estará aí por mais um tempo (até 2020). Portanto, qual a motivação para mudar para o <em>Python 3</em> agora?</p>\n<p>Na <a href=\"https://loadsmart.com/\" title=\"Book a truck in seconds\"><em>Loadsmart</em></a>, o nosso principal projeto é em <em>Python</em> <code class=\"language-text\">2.7</code>.\nMas estamos experimentando <em>Python</em> <code class=\"language-text\">3.x</code> há um bom tempo em projetos paralelos. O fato é que a nova versão da linguagem está mais eficiente,\npossui suporte a assincronicidade, melhor controle de exceções e o fogo ardente do \"unicode hell\" foi controlado.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8828b6f6e53d7cc049d0cbca6862b42/c08c5/python-snakes.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAGRkZK01hP/xAAaEAEBAAIDAAAAAAAAAAAAAAABAgMiABES/9oACAEBAAEFAve0wHKwIybORKx9TH//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAaEAACAwEBAAAAAAAAAAAAAAAAARESMUEh/9oACAEBAAY/Aq4RbZOMTPOCUH//xAAbEAEAAgMBAQAAAAAAAAAAAAABABEhMUEQUf/aAAgBAQABPyEKGUcLuWBFnCr5MAQgbm/JlOc/Z//aAAwDAQACAAMAAAAQx/8A/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAwEBPxCqaRH/xAAWEQADAAAAAAAAAAAAAAAAAAAQIUH/2gAIAQIBAT8QqH//xAAdEAEAAwABBQAAAAAAAAAAAAABABEhMUFxkaHR/9oACAEBAAE/ED/px4O0NoWC4DUJDgGzIAjZAW3XPyDUAWAvpue4734VdL4n/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Indiana Jones encarando uma cobra&quot;\"\n        title=\"Migrar para Python 3 pode parecer assustador. Mas é tranquilo, Indy...\"\n        src=\"/static/e8828b6f6e53d7cc049d0cbca6862b42/c08c5/python-snakes.jpg\"\n        srcset=\"/static/e8828b6f6e53d7cc049d0cbca6862b42/7809d/python-snakes.jpg 192w,\n/static/e8828b6f6e53d7cc049d0cbca6862b42/4ecad/python-snakes.jpg 384w,\n/static/e8828b6f6e53d7cc049d0cbca6862b42/c08c5/python-snakes.jpg 640w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Migrar para Python 3 pode parecer assustador. Mas é tranquilo, Indy...</figcaption>\n  </figure></p>\n<p>É verdade que há quebra de compatibilidade entre as versões, mas se considerarmos que a <code class=\"language-text\">2.7</code> só tem mais 2 anos de \"vida\",\na urgência de migração fica mais latente.</p>\n<h2>tox é uma sacada das boas!</h2>\n<p>O site oficial da biblioteca a define como:</p>\n<blockquote>\n<p>(...) a generic virtualenv management and test command line tool (...)</p>\n</blockquote>\n<p>Com <em>tox</em> é possível:</p>\n<ul>\n<li>Validar o seu pacote contra diferentes versões do <em>Python</em>;</li>\n<li>Rodar os seus testes em diferentes <em>environments</em>.</li>\n</ul>\n<p>Não é só por usar <a href=\"/tag/virtualenv.html\" title=\"Leia mais sobre Virtualenv\"><em>ambientes virtuais</em></a> que o <em>tox</em> é\numa boa ideia. Ele vem sendo uma mão na roda para os desenvolvedores de pacotes <em>Python</em>\nque precisam dar suporte às versões <code class=\"language-text\">2.x</code> e <code class=\"language-text\">3.x</code>, e que utilizam testes automatizados como\n<em>design</em> das soluções.</p>\n<p>Com o <em>Django</em> a \"granularidade\" pode ser ainda maior, rodando testes em ambientes\nque são combinações entre diferentes versões da linguagem e do <em>framework</em>.</p>\n<h2>Antes de continuar: Travis e Build Matrix</h2>\n<p>Se você estiver utilizando o <a href=\"\"><em>Travis CI</em></a>, poderoso serviço de Continuous Integration, consegue reproduzir o comportamento que apresentaremos\na seguir através do uso de <a href=\"https://docs.travis-ci.com/user/customizing-the-build/#Build-Matrix\" title=\"Customizing the build\"><em>Build Matrix</em></a>.</p>\n<p>A diferença é que com o <em>tox</em>, podemos obter o mesmo comportamento em tempo de desenvolvimento. Agilizando um pouco mais o processo.</p>\n<p>Veja mais em <a href=\"https://vevurka.github.io/dsp17/git/quality/django/python/travis_ci_frisor/\" title=\"Setting up Travis CI for github repo in Python\">\"Travis CI for Python project\"</a>.</p>\n<h2>Na prática</h2>\n<p>Vou aproveitar o tema e usar o <em>tox</em> para me ajudar em um <em>refactoring</em> de um <em>app</em> de\ncódigo aberto, que há muito não dou suporte: O <a href=\"https://github.com/kplaube/django-simple-contact\" title=\"Veja no Github\">django-simple-contact</a>.</p>\n<p>Se você quiser acompanhar o passo-a-passo, clone o projeto e dê um <code class=\"language-text\">git checkout</code> da <em>revisão</em> <code class=\"language-text\">80145ae</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ git clone git@github.com:kplaube/django-simple-contact.git\n$ cd django-simple-contact/\n$ git checkout 80145ae</code></pre></div>\n<p>Na estrutura atual, é possível executar os testes através do <code class=\"language-text\">setup.py</code> ou <code class=\"language-text\">python runtests.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python setup.py test\n(...)\n-----------------------------------------------\nRan 6 tests in 0.230s\n\nOK\nDestroying test database for alias &#39;default&#39;...</code></pre></div>\n<p>É possível fazer a troca da versão do <em>Python/Django</em> de forma manual (através do <a href=\"/tag/pyenv.html\" title=\"Leia mais sobre pyenv\"><em>pyenv</em></a>, por exemplo).\nObviamente que o <em>tox</em> deixa tudo mais interessante (e automatizado).</p>\n<h3>Instalando o tox</h3>\n<p>Finalmente, vamos adicionar a ferramenta ao projeto:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ pip install tox</code></pre></div>\n<p>Caso esteja usando <em>pyenv</em>, a instalação do <code class=\"language-text\">tox-pyenv</code> é sugerida.\n<a href=\"https://pypi.python.org/pypi/tox-pyenv\" title=\"tox plugin that makes tox use &#x60;pyenv which&#x60; to find python executables\">Leia mais sobre a biblioteca</a>.</p>\n<p>Para deixar tudo mais organizado, vamos nos inspirar na estrutura do projeto\n<a href=\"https://github.com/vandersonmota/model_mommy\" title=\"Object factory for django\"><em>modelmommy</em></a>. Criaremos um arquivo <code class=\"language-text\">requirements.txt</code> com o seguinte conteúdo:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># requirements.txt\n\nbleach\ndjango&gt;=1.8.0</code></pre></div>\n<p>A versão <code class=\"language-text\">1.8.0</code> (até o momento) é a <em>LTS</em> mais antiga, portanto, garantiremos suporte dessa versão em diante.\nO <a href=\"https://pypi.python.org/pypi/bleach\" title=\"An easy safelist-based HTML-sanitizing tool\"><em>bleach</em></a> é uma dependência do projeto, não\nrelevante ao exemplo desse artigo.</p>\n<p>É interessante deixarmos explícito a instalação do <em>tox</em>... um <code class=\"language-text\">requirements-dev.txt</code> pode ser uma solução:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># requirements-dev.txt\n\ntox</code></pre></div>\n<p>Agora, quando um <em>dev</em> juntar-se ao projeto, ele poderá executar o comando <code class=\"language-text\">pip install -r requirements-dev.txt</code>, e ter\nas dependências necessárias para contribuir com o <em>app</em>.</p>\n<h3>Configurando</h3>\n<p>Antes de executar a ferramenta é necessário criar um arquivo <code class=\"language-text\">tox.ini</code>, que será responsável por configurar os ambientes\ne disparar os testes:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token comment\"># tox.ini</span>\n\n<span class=\"token selector\">[tox]</span>\n<span class=\"token constant\">envlist</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> py27-django{18,111}, py36-django{18,111,20}</span>\n\n<span class=\"token selector\">[testenv]</span>\n<span class=\"token constant\">commands</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> python runtests.py</span>\n<span class=\"token constant\">setenv</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span></span>\n<span class=\"token constant\">    DJANGO_SETTINGS_MODULE</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>simple_contact.tests.test_settings</span>\n<span class=\"token constant\">    PYTHONPATH</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>{toxinidir}</span>\n<span class=\"token constant\">basepython</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span></span>\n    py27: python2.7\n    py36: python3.6\n<span class=\"token constant\">deps</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span></span>\n    bleach\n    django18: Django<span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">=</span>1.8</span>\n    django111: Django<span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">=</span>1.11</span>\n    django20: Django<span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">=</span>2.0</span></code></pre></div>\n<p>Por partes:</p>\n<ul>\n<li><code class=\"language-text\">[tox]</code>: Aqui colocamos as configurações globais. <code class=\"language-text\">envlist</code> conterá a lista de ambientes nos quais executaremos os testes.</li>\n<li>\n<p><code class=\"language-text\">[testenv]</code>: Configurações por ambiente de teste. Poderíamos ter configurações específicas ao utilizar <code class=\"language-text\">[testenv:py36-django20]</code>, por exemplo.</p>\n<ul>\n<li><code class=\"language-text\">commands</code>: O comando a ser executado.</li>\n<li><code class=\"language-text\">setenv</code>: Variáveis de ambiente setadas para a execução dos testes.</li>\n<li><code class=\"language-text\">basepython</code>: Nome do interpretador <em>Python</em> utilizado para a criação do ambiente virtual. Repare no \"match\" com <code class=\"language-text\">py27-</code> e <code class=\"language-text\">py36-</code> do <code class=\"language-text\">envlist</code>.</li>\n<li><code class=\"language-text\">deps</code>: Dependências para determinado ambiente de teste. Repare no \"match\" com <code class=\"language-text\">django{18,111,20}</code>.</li>\n</ul>\n</li>\n</ul>\n<p>Com o uso dos <em>brackets</em>, ao invés de criarmos um <code class=\"language-text\">testenv</code> para cada combinação (exemplo: <code class=\"language-text\">py27-django18</code>, <code class=\"language-text\">py27-django111</code>, <code class=\"language-text\">py36-django18</code>, etc),\no <em>tox</em> fica responsável por fazer a \"matriz de combinações\".</p>\n<p>Agora sim, podemos executar a ferramenta de linha de comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ tox\n(...)\nERROR:   py27-django18: commands failed\nERROR:   py27-django111: commands failed\nERROR:   py36-django18: commands failed\nERROR:   py36-django111: commands failed\npy36-django20: commands succeeded</code></pre></div>\n<p>No meu ambiente local, como esperado, apenas os testes do ambiente <code class=\"language-text\">py36-django20</code> passaram. Para ter acesso a versão corrigida,\ndê um <em>checkout</em> da revisão <code class=\"language-text\">a37ebd1608</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ git checkout a37ebd1608\n$ tox\n(...)\npy27-django18: commands succeeded\npy27-django111: commands succeeded\npy36-django18: commands succeeded\npy36-django111: commands succeeded\npy36-django20: commands succeeded</code></pre></div>\n<p>Perfeito!</p>\n<p>Ainda é possível executar apenas os testes de um ambiente específico:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ tox -e py36-django20\n(...)\n-----------------------------------------------\nRan 6 tests in 0.055s\n\nOK\nDestroying test database for alias &#39;default&#39;...</code></pre></div>\n<p>O resultado final está disponível na <em>tag</em> <code class=\"language-text\">0.3.0</code> do projeto.</p>\n<h2>Considerações finais</h2>\n<p>Que esse movimento da comunidade <em>Django</em> consiga influenciar ainda mais a adoção do <em>Python 3</em>. Admito que sem essa\n\"motivação extra\", dificilmente cogitaria o <em>upgrade</em> da linguagem em meus projetos nesse momento.</p>\n<p>O <em>tox</em> é sem dúvida uma ferramenta que pode auxiliar nessa fase de transição, portanto, não hesite em adicioná-la ao seu <em>toolbelt</em>.</p>\n<p>Para uma integração <em>seamless</em> com o <em>Travis CI</em>, o <a href=\"https://github.com/tox-dev/tox-travis\" title=\"Seamless integration of Tox into Travis CI\"><em>tox-travis</em></a>\né recomendado.</p>\n<p>Até a próxima!</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"https://www.activestate.com/blog/2017/01/python-3-vs-python-2-its-different-time\">ActiveState - Python 3 vs Python 2: It's different this time</a></li>\n<li><a href=\"http://henriquebastos.net/desmistificando-o-conceito-de-django-apps/\">Henrique Bastos - Desmistificando O Conceito De Django Apps</a></li>\n<li><a href=\"http://jsatt.com/blog/using-tox-with-travis-ci-to-test-django-apps/\">Jeremy Satterfield - Using Tox with Travis CI to Test Django Apps</a></li>\n<li><a href=\"https://vevurka.github.io/dsp17/git/quality/django/python/travis_ci_frisor/\">vevurka-dev - Travis CI for Python project</a></li>\n</ul>","excerpt":"O Django 2.0 foi lançado,\ne com ele o suporte a Python  deixa de existir para\nas próximas versões do framework. Alegria para os usuários…","frontmatter":{"date":"2018-01-05T17:05:00.000Z","title":"Testando apps Django com Tox","tags":["desenvolvimento-web","testes","tdd","tox","django","python","virtualenv"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACe0lEQVQ4y6WV/UtTYRTH/Rv6A4qgLNN02Wb5vqlbNF0mZTW3dG1uWsu0DFeUxCiIQdEvkRQlGb35i4FpSKnJ7BW1sQqi8odICi0pMpe4t2/Pc9a9qHgvky483Hue+5zP/Z7nOefchI2OIkiNdHsh4nk/d11CPA7KGi0NYV7FbYd2aUBh0YbqAqyrykEyG3wu1ZqPpMosrN+Xt2gUkkCugDuVnqiE1/8cj31PkFtnQFOLG0PvfDjf3kIf4splFQovM2q3ELDqbB2ES92wHXd6O+j51YfXWGXKYOt00kBxz5i6FEsulu9SoOykBdFoFLPBWeiOlsN5wYWel/1wXz+HZLZGUiGfVLJ7mk1Dykxn9uPwxWYW2iVSFAwFUXLMhLxD21Bxuhb6JiMUbH8XPRRhQlGtQZZTj4dDA1h4hSNhaFjIV7tukT3ge4rV5k1QSYWsqtFhLTu9u333yGF6JsCcb4q2ALzSeYPsvhEvEs2bpYFcXc7BEnz7OUkO/BSXGRJR1mwRgep4gZQiLL/0LiOmAr/Jweqpx0qjku4xYCQGvB+3wgJkO4sx8eM7ObT1tGPF7nTscTvIDoVDC4CD8kBhD1sf3BYPwj/6Fr6Pb0S78MgOXOuOHUrvsIxCsczsLA3sRbjc2Yavk+OIsDARBX5NT+HT+Bjy60vR4e0mYNezR/IK5xb6mr2ZyDywFYbjZiq9YlcF1TDf67GJLwTkGSAAJWtZgPLweVNIYQnOk5xXhLaxHIP+F2L4fG9lK0WqbXEFqVY1bJ4GvP88isDMH5xq9bDGkC3CltQPYyWpRRIDcNXaxp0Ek2rAssB5df5PTZpNTQ32v4DzO5H87+Ev3E2COGrAjDwAAAAASUVORK5CYII=","width":180,"height":180,"src":"/static/46012f1b5a5e44b0747baafa90e04f8a/d8216/django-logo.png","srcSet":"/static/46012f1b5a5e44b0747baafa90e04f8a/d8216/django-logo.png 1x"}},"publicURL":"/static/46012f1b5a5e44b0747baafa90e04f8a/django-logo.png"}},"fields":{"readingTime":{"minutes":5.71},"slug":"/2018/01/05/testando-apps-django-com-tox.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2018/01/05/testando-apps-django-com-tox.html"}}}