{"componentChunkName":"component---src-templates-blog-post-js","path":"/2011/11/20/migrations-em-django-south.html","result":{"data":{"markdownRemark":{"html":"<p>E quem nunca precisou adicionar ou remover alguma\ncoluna, nas tabelas do seu banco de dados, depois que a aplicação já\nestava em produção? Os riscos existem (e são altos), e podem ser\ndiminuidos através de processos automatizados.</p>\n<p>Em um mundo ideal, o procedimento de <em>deploy</em> (para entregas contínuas)\n<strong>deve ser automatizado</strong>. Com o <em>South</em>, “migrar” a estrutura e os\ndados da sua base de dados para a versão presente em seu novo deploy, é\nsimples, prático e 100% integrado ao <a href=\"/tag/django.html\" title=\"Leia mais sobre Django\"><em>Django</em></a>.</p>\n<h2>Instalando o South</h2>\n<p>O <a href=\"http://south.aeracode.org/\" title=\"Página oficial do projeto South\"><em>South</em></a> é muito, mas muito simples de instalar. Utilizando o\n<em>pip</em>, basta o seguinte comando para termos os <em>eggs</em> em nosso\n<code class=\"language-text\">PYTHONPATH</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ pip install south</code></pre></div>\n<p>Não podemos esquecer de adicioná-lo ao <code class=\"language-text\">INSTALLED_APPS</code> do\n<code class=\"language-text\">settings.py</code> (afinal, trata-se de uma <em>app Django</em>):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">INSTALLED_APPS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'django.contrib.auth'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token string\">'south'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Pronto! Você acabou de ganhar alguns comandos para construir as suas\n<em>migrations</em>.</p>\n<h2>Direto para a prática</h2>\n<p>Sem perder tempo, vamos construir uma <em>app Django</em> para que possamos\ndemonstrar o uso do <em>South</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py startapp blog</code></pre></div>\n<p>Lembrando de adicioná-la ao <code class=\"language-text\">settings.py</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># settings.py</span>\nINSTALLED_APPS <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'django.contrib.auth'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token string\">'south'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'blog'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Vamos criar um modelo bem básico, com alguns campos (posteriormente,\nincrementaremos esta estrutura):</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># blog/models.py</span>\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>db <span class=\"token keyword\">import</span> models\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Blog</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    titulo <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span><span class=\"token string\">'Titulo'</span><span class=\"token punctuation\">,</span> max_length<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n    texto <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>TextField<span class=\"token punctuation\">(</span><span class=\"token string\">'Texto'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Através do comando <code class=\"language-text\">schemamigration</code>, com parâmetro <code class=\"language-text\">–-initial</code>,\ncriaremos a nossa primeira migration:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py schemamigration blog --initial</code></pre></div>\n<p>Vale notar que o comando acima não cria nenhuma tabela no banco de\ndados. O que ele faz é criar um conjunto de instruções que representa\neste modelo. Na medida que são feitas alterações no modelo, é necessário\ngerar novas <em>migrations</em>, que serão sempre baseados nas estruturas já\ncriadas.</p>\n<p>Por exemplo, vamos de fato criar a tabela <em>blog</em> no banco de dados:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py migrate blog\n\nRunning migrations for blog:\n- blog:0001_initial\n- Loading initial data for blog.\nNo fixtures found.</code></pre></div>\n<p>Se houvesse alguma <em>fixture</em>, o <em>South</em> faria o <em>insert</em> das informações\npara você.</p>\n<p>A primeira <em>migration</em> foi criada. Como mencionado antes, a partir de\nagora toda migration criada será baseada na <em>migration</em> “anterior”\n(podemos deduzir a ordem das <em>migrations</em> através do prefixo numérico,\nno caso acima, o <code class=\"language-text\">0001</code> indica que esta é a primeira).</p>\n<p>Vamos adicionar um campo no modelo (que equivale a uma coluna no banco\nde dados), para ilustrar a criação de novas <em>migrations</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># blog/models.py</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Blog</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    titulo <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span><span class=\"token string\">'Titulo'</span><span class=\"token punctuation\">,</span> max_length<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n    resumo <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>TextField<span class=\"token punctuation\">(</span><span class=\"token string\">'Resumo'</span><span class=\"token punctuation\">,</span> blank<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> null<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    texto <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>TextField<span class=\"token punctuation\">(</span><span class=\"token string\">'Texto'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Não é mais necessário o uso do parâmetro <code class=\"language-text\">-–initial</code>, de agora em\ndiante precisaremos do parâmetro <code class=\"language-text\">–-auto</code> (que construirá a\n<em>migration</em> automaticamente, de acordo com a primeira já existente):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py schemamigration blog --auto\n\n+ Added field resumo on blog.Blog\nCreated 0002_auto__add_field_blog_resumo.py. You can now apply this migration\nwith: ./manage.py migrate blog</code></pre></div>\n<p>Pronto! Uma nova <em>migration</em> foi criada… e com um nome bem intuitivo\n(repare no prefixo numérico). Basta darmos a ordem de replicar estas\ninstruções no banco de dados:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ python manage.py migrate blog\n\nRunning migrations for blog:\n- Migrating forwards to 0002_auto__add_field_blog_resumo.\n- blog:0002_auto__add_field_blog_resumo\n- Loading initial data for blog.\nNo fixtures found.</code></pre></div>\n<p>A nova coluna foi inserida na tabela <em>blog</em>, sem necessitar de nenhuma\nintervenção manual. Se você ficou curioso para saber como essa “mágica”\nacontece, basta abrir as <em>migrations</em> e ver que são instruções escritas\nem <a href=\"/tag/python.html\" title=\"Leia mais sobre Python\"><em>Python</em></a>, que interagem com o banco de dados “por trás” do <em>ORM</em>\ndo <em>Django</em>.</p>\n<p>O <em>South</em> possui mais alguns recursos interessantes (como <em>data\nmigrations</em>), que você pode conferir <a href=\"http://south.aeracode.org/docs/tutorial/index.html\" title=\"Aprenda mais sobre o South\">neste tutorial</a>.</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"http://south.aeracode.org/\" title=\"Visite a página oficial do projeto South\"><em>South – Intelligent schema and data migrations for Django</em></a></li>\n</ul>","excerpt":"E quem nunca precisou adicionar ou remover alguma\ncoluna, nas tabelas do seu banco de dados, depois que a aplicação já\nestava em produção…","frontmatter":{"date":"2011-11-20T21:35:00.000Z","title":"Migrations em Django com South","tags":["desenvolvimento-web","python","django","migrations","south","banco-de-dados"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACU0lEQVQ4y2NgGAUUA/+S1Qz+xVAMYpdCaSAmC2QW1jNklnYyJDSsZ4ytWcWcUL+OMf//f7BcRNV6nPp0jU2xYobS9sUMWa1rmeoWXGLI6tjKUD3nHEN60wqmhJwaBn0jPZwadU3ANGO0aQ6qgT1ztzMmN61jKJt5VjK9batPybSTspmtaxliiyczKqqpwBQygmkzMzBf38QEZCBYTNvYGCTGCjewZfZ+hpSmDW7hRbM+eqf2/A8vnPk1p31jYEbrOpjXeKGKWXRNIQbqQQwEsbWB2AiIvXWNIXIM////Z01oWHPFLLLjv1Foy3eT0Ob/gcWL7wDFmXQMDSP0TMz8gAqlgTgHiP2B2AaI1YHYDohbgTgGiKuAOAuIRRj+724QWl0V/rImLe5/Xlbxj+SU4n+Nde0f33/4pa+ipeWmb2oeB1SYq2dsqgOkw4C4BohVgTgeiAOB2BKIPYEYZLExw7FmX4bj6VKT1wSy/1/izfR/bbjQ/7PFOot7o00ZDIyNtfVMTIugBmVCXeMFxOVAnAbEIVAxUyC2B2IthqvZUgyPVnayHC4wqNqepLDzYLZG48YYFY71WcYMZuamYkBFwtAwFAdiTj0IWxaIOaBYABRpQIuZgZiJ4UaFHsPLWi2G42WmDK1+CgxH8nUYbqbyMGwssGM0NTdDjWVQhOBIRnrASAEayMBwNkeJ4XSWAsOhAn3muhADxgMFBsynspUZN6VoAF1ogpzmkDEjzoR9IoGf4XiCAMP+BHGG42lSDAcSxBhOJ/IwnEngZliRZDxaNg0AAAA/1OZeXeSuawAAAABJRU5ErkJggg==","width":180,"height":180,"src":"/static/04ee76a53503f2eeadf92ccc6a9331e9/d8216/south-logo.png","srcSet":"/static/04ee76a53503f2eeadf92ccc6a9331e9/d8216/south-logo.png 1x"}},"publicURL":"/static/04ee76a53503f2eeadf92ccc6a9331e9/south-logo.png"}},"fields":{"readingTime":{"minutes":3.275},"slug":"/2011/11/20/migrations-em-django-south.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2011/11/20/migrations-em-django-south.html"}},"staticQueryHashes":["2831923220","4114525740"]}