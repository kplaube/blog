{"componentChunkName":"component---src-templates-blog-post-js","path":"/2012/04/05/entendendo-os-cookies-e-sessoes.html","result":{"data":{"markdownRemark":{"html":"<p>Por muito tempo eu abstrai o conceito de\n<em>cookies</em> e sessões, e nunca cheguei a prestar muita atenção no seu\nfuncionamento. Recentemente, trabalhando com uma infra mais preocupada\ncom a segurança, disponibilidade e performance, tive a oportunidade de\nrelembrar e me aprofundar em alguns conceitos e práticas.</p>\n<p>O que já sabia é que os <em>cookies</em> são “persistências temporárias” feitas\nno lado do usuário, e sessões são persistências dependentes de\n<em>cookies</em>, mas realizadas no lado do servidor.</p>\n<p>A minha felicidade é que até aí, nada mudou :)</p>\n<h2>Para que servem Cookies e Sessões?</h2>\n<p>O <a href=\"http://wagnerelias.com/2009/02/06/http-essentials/\" title=\"Conheça mais sobre o protocolo HTTP\">protocolo <em>HTTP</em></a> é <em>stateless</em>, ou seja, ele não mantém um\nestado/conexão. Toda a interação que o seu cliente fizer com um servidor\n<a href=\"/tag/desenvolvimento-web.html\" title=\"Leia mais sobre Web\"><em>web</em></a> acarretará em uma nova requisição e resposta.</p>\n<p>As requisições são independentes e possuem um tempo de vida (conexão,\nenvio de mensagem, resposta, encerramento da conexão). O servidor <em>web</em>\nnão é capaz de identificar se duas requisições vieram de um mesmo\nnavegador, e o mesmo não faz nenhum gerenciamento em memória para que\nmensagens sejam compartilhadas entre requisições.</p>\n<p>É para suprir esta necessidade que entram os <em>cookies</em> e sessões.</p>\n<h2>Cookies</h2>\n<p>Através de <em>cookies</em> o servidor <em>web</em> é capaz de trocar informações de\nestado com o navegador do usuário. Desse modo, somos capazes de\nadicionar produtos a um carrinho de compras, sem perder estas\ninformações ao mudar de página, sair do <em>website</em> ou até mesmo fechar o\nnavegador.</p>\n<p>Tecnicamente falando, um <em>cookie</em> é uma pequena quantidade de informação\npersistida temporariamente pelo navegador. Os navegadores normalmente\nlimitam o tamanho dos <em>cookies</em> em até 4KB, e apagam <em>cookies</em> com a\ndata de “validade vencida”.</p>\n<p>Para entender como essa troca de informação é feita, vamos criar um\n<em>cookie</em> com o <a href=\"/tag/php.html\" title=\"Leia mais sobre PHP\"><em>PHP</em></a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n    <span class=\"token comment\">// cookies.php</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_COOKIE</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'cookie_teste'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'Você JÁ passou por aqui!'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'Você NUNCA passou por aqui.'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">setcookie</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'cookie_teste'</span><span class=\"token punctuation\">,</span> <span class=\"token single-quoted-string string\">'Algum valor...'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">3600</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>O código acima verifica se o <em>cookie</em> atendendo pelo identificador\n<code class=\"language-text\">cookie_teste</code> já existe, caso não exista, cria um <em>cookie</em> com\nidentificador <code class=\"language-text\">cookie_teste</code>, valor <code class=\"language-text\">Algum valor...</code> e com <strong>1\nhora de vida</strong> (a hora atual mais 3600 segundos).</p>\n<p>Quando visitamos pela primeira vez o <code class=\"language-text\">cookies.php</code>, temos a seguinte\nresposta:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -I localhost/cookies.php\n\nHTTP/1.1 200 OK\nDate: Wed, 04 Apr 2012 00:35:33 GMT\nServer: Apache/2.2.21 (Unix) mod_ssl/2.2.21 OpenSSL/0.9.8r DAV/2 PHP/5.3.8\nX-Powered-By: PHP/5.3.8\nSet-Cookie: cookie_teste=Algum+valor...; expires=Wed, 04-Apr-2012 01:35:33 GMT\nContent-Type: text/html</code></pre></div>\n<p>Através da função <code class=\"language-text\">setcookie</code> do <em>PHP</em>, estamos enviando um item\nchamado <code class=\"language-text\">Set-Cookie</code> no cabeçalho <em>HTTP</em> da resposta. É através deste\nque o navegador entende que deve armazenar o valor <code class=\"language-text\">Algum valor…</code>,\natendendo pelo identificador <code class=\"language-text\">cookie_teste</code>, e que esta informação\nexpira em 1 hora (verifique a data da requisição e a data de validade do\n<em>cookie</em>).</p>\n<p>Na próxima vez que o navegador acessar esta <em>URL</em>, ele verificará se\npossui algum <em>cookie</em> para aquele domínio e <em>path</em>, caso exista, ele\npassa as informações do <em>cookie</em> no cabeçalho da requisição. Desse modo,\na nossa aplicação é capaz de perceber a existência de um <em>cookie</em> (no\ncaso do <em>PHP</em>, através do <em>array</em> global <code class=\"language-text\">$_COOKIE</code>).</p>\n<p>Abaixo, um exemplo de requisição utilizando o <em>Google Chrome</em>:</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 760px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/574c72cb92153b3981d5e76c2ba7a077/3c051/exemplo-php-cookies.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.52083333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABs0lEQVQoz4WSTW/TQBCG/Zs5wpkzdy49wo9AHCoUgdKqpLF37SRe2yTONmpLHMffduZl1klMUwmx0qN3dlc7O1/W0/PjYa01rfWGkiSlum6pqmpq25bapum167rj3tgnPRwOPebO6HlZthhRFAr8igKEyoMz/YnJ3S1cKSGnUwjbgRAGgXveS+ee7wTCMIRSCkEQIIoixHGM5XIJ68Nnh95/ivDuyqe3V4refFT0ZRyTXoUkPY+82Yz4AbEDilcxpemOSWm3+6tJkgxYd35B32SJa1HStVPi67REtCngzz1I14bWa6S7FHmWo8gL1HWNpmkGXi+LoZNNwyl1WHAqwvV6bOlipR/we7sFR4WqqlCWJVOB6wcu3YBl6smgY+2OCm4GgtsbuKMR/PEYz/MFWq35I8L/1hAhHb/oN8bhYjKB/f0H9GyOR472SQXIOLosz5FlGfb7Pbh+vW0oiqLnwuHJZ18bxV2U3gzLeI2EH5dcu7bt+hR5VHp4fC7UcBnhUfmi5ZHw4bkulK+wedgg2SbDo5fQqzL8w2GH0DRFSJ45bshy1aeXc7om1XOaxj53+tyUP/Oi9lEWEjCnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Item cookie no cabeçalho de resposta da requisição HTTP&quot;\"\n        title=\"Item cookie no cabeçalho de resposta da requisição HTTP\"\n        src=\"/static/574c72cb92153b3981d5e76c2ba7a077/3c051/exemplo-php-cookies.png\"\n        srcset=\"/static/574c72cb92153b3981d5e76c2ba7a077/8514f/exemplo-php-cookies.png 192w,\n/static/574c72cb92153b3981d5e76c2ba7a077/804b2/exemplo-php-cookies.png 384w,\n/static/574c72cb92153b3981d5e76c2ba7a077/3c051/exemplo-php-cookies.png 760w\"\n        sizes=\"(max-width: 760px) 100vw, 760px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Item cookie no cabeçalho de resposta da requisição HTTP</figcaption>\n  </figure></p>\n<p><a href=\"/images/blog/exemplo-php-cookies.png\">Clique para ampliar</a></p>\n<p>Se excluirmos os <em>cookies</em>, ou o tempo de expiração for atingido, o\nnavegador deixa de anexar esta informação ao cabeçalho da requisição.</p>\n<h2>Sessões</h2>\n<p>As sessões têm um princípio similar aos <em>cookies</em>, só que o\narmazenamento do estado é feito pelo servidor <em>web</em>, e não pelo\nnavegador.</p>\n<p>Por exemplo, quando construímos uma aplicação que necessita de\nautenticação, no momento em que o usuário efetuar o <em>login</em>, podemos até\npermitir que algumas informações sejam armazenadas em um <em>cookie</em>, mas\ndados mais “sensíveis”, como usuário e <em>e-mail</em>, são mais interessantes\nde serem guardadas em sessões. Isto, pois <strong>não é seguro</strong> que esse tipo\nde informação fique “viajando” pela <em>web</em>.</p>\n<p>Mas se o <em>HTTP</em> é <em>stateless</em>, e o servidor <em>web</em> não tem como\nidentificar que a requisição anterior veio do meu <em>browser</em>, como é que\nele sabe que as informações que eu guardei em sessão são de fato minhas?\nSimples… <strong>através de <em>cookies</em>!</strong></p>\n<p>Quando iniciamos uma sessão, é enviado um <em>cookie</em> para o navegador, com\num valor único que corresponde a sessão aberta no servidor <em>web</em>. Vamos\nilustrar através do exemplo abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n    <span class=\"token comment\">// sessions.php</span>\n\n    <span class=\"token function\">session_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'usuario'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"Bem vindo <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'usuario'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span>!\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token single-quoted-string string\">'Você NUNCA passou por aqui.'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$_SESSION</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'usuario'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token single-quoted-string string\">'João'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>O código acima inicia uma sessão através do método <code class=\"language-text\">session_start</code>.\nNa primeira visita, será criado um índice <code class=\"language-text\">usuario</code> com o valor\n<code class=\"language-text\">João</code>. A resposta da nossa requisição será a seguinte:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -I localhost/sessions.php\n\nHTTP/1.1 200 OK\nDate: Wed, 04 Apr 2012 01:51:57 GMT\nServer: Apache/2.2.21 (Unix) mod_ssl/2.2.21 OpenSSL/0.9.8r DAV/2 PHP/5.3.8\nX-Powered-By: PHP/5.3.8\nSet-Cookie: PHPSESSID=4h91dkp7pcp8184nil8rt9ok13; path=/\nExpires: Thu, 19 Nov 1981 08:52:00 GMT\nCache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0\nPragma: no-cache\nContent-Type: text/html</code></pre></div>\n<p>Por partes:</p>\n<ul>\n<li>Como mencionei, <code class=\"language-text\">Set-Cookie</code> foi retornado com um identificador\n(<code class=\"language-text\">PHPSESSID</code>) e um valor que corresponde a sessão aberta no\nservidor (<code class=\"language-text\">4h91dkp7pcp8184nil8rt9ok13</code>). O complemento <code class=\"language-text\">path</code>\nestá “dizendo” ao navegador que aquele <em>cookie</em> tem validade por\ntodo o domínio (ou seja, valerá inclusive para outros arquivos <em>PHP</em>\nem outras subpastas). Quando não é informada a data de expiração, o\nnavegador manterá o <em>cookie</em> até o momento em que ele for fechado.</li>\n<li>O <em>PHP</em> tomou a liberdade de adicionar alguns cabeçalhos de controle\nde <em>cache</em> (<code class=\"language-text\">Expires</code>, <code class=\"language-text\">Cache-Control</code> e <code class=\"language-text\">Pragma</code>) à nossa\nresposta. Em resumo, o servidor está dizendo ao navegador para que\nnão armazene esta página em <em>cache</em>. Estes valores podem ser\nalterados em <a href=\"http://www.php.net/manual/en/ref.session.php\" title=\"PHP: Session functions\">tempo de desenvolvimento</a>, ou <a href=\"http://www.php.net/manual/en/session.configuration.php\" title=\"PHP: Runtime configuration\">através do <strong>php.ini</strong></a>.</li>\n<li>Em nenhum momento o <em>Apache</em> informou ao navegador que temos um\níndice <code class=\"language-text\">usuario</code> com o valor <code class=\"language-text\">João</code>. Estas informações estão\ndisponíveis somente no lado do servidor.</li>\n</ul>\n<p>Quando visitarmos o <code class=\"language-text\">sessions.php</code> novamente, o navegador informará ao\nservidor que ele possui um <em>cookie</em> chamado <code class=\"language-text\">PHPSESSID</code>. A partir daí\no <em>PHP</em> pega o valor deste <em>cookie</em>, recupera a sessão da memória (ou de\num banco de dados, ou arquivos em disco) e atribui este valor ao <em>array</em>\nglobal <code class=\"language-text\">$_SESSION</code>.</p>\n<p>O nome do <em>cookie</em> varia de linguagem para linguagem e até mesmo de\n<em>framework</em> para <em>framework</em>. Por exemplo, no <a href=\"/tag/django.html\" title=\"Leia mais sobre Django\"><em>Django</em></a> ele é chamado\npor padrão de <code class=\"language-text\">sessionid</code>, no <a href=\"/tag/codeigniter.html\" title=\"Leia mais sobre CodeIgniter\"><em>CodeIgniter</em></a> é chamado de\n<code class=\"language-text\">ci_session</code>.</p>\n<h2>Considerações finais</h2>\n<p>Gostei muito de me aprofundar um pouquinho mais neste assunto, e gostei\nmais ainda de poder traduzir este aprendizado através deste <em>post</em>.</p>\n<p>É claro que há alguns cuidados com segurança quando o assunto é\n<em>cookies</em> e sessões, bem como considerações em relação ao uso de\n<em>cache</em>. Pretendo falar mais sobre esses temas em <em>posts</em> vindouros.</p>\n<p>Até a próxima…</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"http://www.php.net/manual/en/book.session.php\" title=\"Confira a documentação oficial do PHP que fala sobre Sessões\"><em>PHP Manual – Session Handling</em></a></li>\n<li><a href=\"http://www.stanford.edu/~ouster/cgi-bin/cs142-fall10/lecture.php?topic=cookie\" title=\"Material resumido, mas muito bom, sobre sessões e Cookies\"><em>Stanford.edu – CS 142: Cookies and Session</em></a></li>\n<li><a href=\"http://wagnerelias.com/2009/02/06/http-essentials/\" title=\"Wagner nos apresenta de forma objetiva o funcionamento do protocolo HTTP\"><em>Wagner Elias</em> – <em>HTTP Essentials</em></a></li>\n<li><a href=\"http://wagnerelias.com/2009/04/21/seguranca-de-cookies-de-sessao-e-httponly/\" title=\"Entenda as falhas de segurança apresentadas com o uso de sessões e cookies\"><em>Wagner Elias</em> – Segurança de <em>Cookies</em> de sessão e <em>HTTPOnly</em></a></li>\n<li><a href=\"http://en.wikipedia.org/wiki/HTTP_cookie\" title=\"Leia este bom artigo em inglês sobre Cookies\"><em>Wikipedia – HTTP Cookie</em></a></li>\n</ul>","excerpt":"Por muito tempo eu abstrai o conceito de\ncookies e sessões, e nunca cheguei a prestar muita atenção no seu\nfuncionamento. Recentemente…","frontmatter":{"date":"2012-04-05T16:53:12.000Z","title":"Entendendo os Cookies e Sessões","tags":["desenvolvimento-web","infraestrutura","cookies","sessões","php"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAMFAQIE/8QAFgEBAQEAAAAAAAAAAAAAAAAAAwAB/9oADAMBAAIQAxAAAAG844ohS1Cm3KyNv//EAB0QAAMAAAcAAAAAAAAAAAAAAAECEQADEBITISL/2gAIAQEAAQUCZgMc/aGrmH2s3IIpRWM0/8QAFxEBAAMAAAAAAAAAAAAAAAAAAQACEP/aAAgBAwEBPwErHf/EABcRAQADAAAAAAAAAAAAAAAAAAEAAhD/2gAIAQIBAT8BbQ3/xAAZEAACAwEAAAAAAAAAAAAAAAABEAARMWH/2gAIAQEABj8C7NRh1WQ//8QAHBABAQEAAwADAAAAAAAAAAAAAREAITFBEFFx/9oACAEBAAE/IeFU+hikSPhM5L3rP6M591iH8d6eSacK4A0D4//aAAwDAQACAAMAAAAQv9/8/8QAFxEBAQEBAAAAAAAAAAAAAAAAEQEAEP/aAAgBAwEBPxCQ3Bpm8//EABcRAQEBAQAAAAAAAAAAAAAAABEBABD/2gAIAQIBAT8QskyI4nP/xAAcEAEAAwACAwAAAAAAAAAAAAABABEhMUEQobH/2gAIAQEAAT8QBbIX2MDYjke8idjZLCopg44qFmH2NR1eTqFvnKVWsEiPcphNVYeP/9k=","width":180,"height":180,"src":"/static/f5b9c6261591d2fdcbc59f451228b8c0/a8ad2/cookies.jpg","srcSet":"/static/f5b9c6261591d2fdcbc59f451228b8c0/a8ad2/cookies.jpg 1x"}},"publicURL":"/static/f5b9c6261591d2fdcbc59f451228b8c0/cookies.jpg"}},"fields":{"readingTime":{"minutes":6.405},"slug":"/2012/04/05/entendendo-os-cookies-e-sessoes.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2012/04/05/entendendo-os-cookies-e-sessoes.html"}}}