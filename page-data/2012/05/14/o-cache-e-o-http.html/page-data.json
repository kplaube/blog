{"componentChunkName":"component---src-templates-blog-post-js","path":"/2012/05/14/o-cache-e-o-http.html","result":{"data":{"markdownRemark":{"html":"<p>Em tempos de alta demanda, o <strong><em>cache</em></strong> pode tornar-se o melhor amigo das\naplicações <a href=\"/tag/desenvolvimento-web.html\" title=\"Leia mais sobre Web\"><em>web</em></a>.\nAtravés dele temos uma opção prática, acessível e barata para melhorar\nperformance, diminuir consumo de recursos e tempos de resposta. Qualquer\nmilissegundo economizado é um ponto a mais com o seu usuário, com os\nmecanismos de busca e com o seu serviço de hospedagem.</p>\n<p>Antes de falarmos de <em>cache</em> em aplicações <a href=\"/tag/django.html\" title=\"Leia mais sobre o Django\"><em>Django</em></a> ou\n<a href=\"/tag/codeigniter.html\" title=\"Leia mais sobre Codeigniter\"><em>Codeigniter</em></a>, acho interessante falarmos sobre o uso de <em>cache</em> com\no protocolo <em>HTTP</em>. Afinal, é esta a primeira camada a “atacar” quando\nprecisamos melhorar os tempos de resposta das nossas aplicações <em>web</em>.</p>\n<h2>O que é “caching”?</h2>\n<p>Segundo <a href=\"http://betterexplained.com/articles/how-to-optimize-your-site-with-http-caching/\" title=\"How To Optimize Your Site With HTTP Caching\"><em>Kalid Azad</em></a>:</p>\n<blockquote>\n<p>Caching is a great example of the ubiquitous time-space tradeoff\nin programming. You can save time by using space to store\nresults.</p>\n</blockquote>\n<p>Basicamente, <strong><em>caching</em></strong> é o ato de “economizar processamento”\narmazenando os seus resultados. Um bom exemplo é o temporário do seu\nnavegador, onde uma imagem que não teve alteração desde o momento do seu\n<em>download</em> é resgatada do seu disco e não da <em>internet</em>. Uma tarefa mais\nrápida e menos custosa.</p>\n<p>Logo, entendemos que o <strong><em>cache</em></strong> é um local em disco ou memória\nutilizado para armazenar estes resultados. Ele pode se aplicar ao\n<em>front-end</em> (como ilustrado no exemplo acima), ou ao <em>back-end</em>, através\ndos servidores <em>web</em>, como o <em>Apache</em> e o <a href=\"/2011/12/19/nginx-poderoso-rapido-facil.html\" title=\"Leia mais sobre Nginx\"><em>Nginx</em></a>, ou através de\nferramentas mais específicas, como <em>Memcached</em> e <em>Redis</em>.</p>\n<p>Assim como a definição de <a href=\"/2012/04/05/entendendo-os-cookies-e-sessoes.html\" title=\"Entendendo os Cookies e Sessões\"><em>cookies</em> e sessões</a>, a utilização de\n<em>cache</em> nos navegadores <em>Web</em> é feita através de informações\ntransmitidas pelo cabeçalho da requisição e resposta.</p>\n<p>Existem quatro tipos de cabeçalhos específicos para <em>cache</em> em <em>HTTP</em>.\nMas todos partem da premissa que o arquivo em questão (pode ser um\ndocumento, imagem, <em>script</em>, etc) já está armazenado no disco do\ninternauta, acessível ao navegador.</p>\n<h2>Last-Modified</h2>\n<p>Com o <code class=\"language-text\">Last-Modified</code>, o navegador informa ao servidor que irá baixar\num arquivo desde que a sua data de modificação seja diferente da data do\narquivo armazenado. Na requisição é passado o cabeçalho\n<code class=\"language-text\">If-Modified-Since</code>, e se a data do arquivo no servidor for mais\nrecente, o navegador faz um novo <em>download</em>.</p>\n<p>Vamos fazer uma requisição tendo como resposta um cabeçalho\n<code class=\"language-text\">Last-Modified</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -i -I http://klauslaube.com.br/media/blog/security.jpg\n\nHTTP/1.1 200 OK\n...\nDate: Tue, 01 May 2012 19:20:27 GMT\nLast-Modified: Sat, 07 Apr 2012 17:51:10 GMT\n...</code></pre></div>\n<p>Uma vez que o arquivo esteja em disco, o navegador tem como informar a\ndata da última alteração. Então, fazemos uma nova requisição ao arquivo\n<code class=\"language-text\">security.jpg</code>, passando esta data no cabeçalho <code class=\"language-text\">If-Modified-Since</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -i -H &quot;If-Modified-Since: Sat, 07 Apr 2012 17:51:10 GMT&quot; http://klauslaube.com.br/media/blog/security.jpg\n\nHTTP/1.1 304 Not Modified\nDate: Tue, 01 May 2012 19:22:00 GMT\nLast-Modified: Sat, 07 Apr 2012 17:51:10 GMT</code></pre></div>\n<p>A resposta <code class=\"language-text\">304 Not Modified</code> não traz o conteúdo do arquivo em seu\ncorpo, e é através desta resposta que o navegador sabe que não precisa\nfazer o <em>download</em> do arquivo, utilizando assim a versão que está em seu\n<em>cache</em>.</p>\n<h2>ETag</h2>\n<p>O modo como a <code class=\"language-text\">ETag</code> funciona é bem parecido com o conceito do\n<code class=\"language-text\">Last-Modified</code>. A diferença está no método de comparação: ao invés de\nfazer comparações pela data, são realizadas comparações através de\nidentificadores únicos, atribuídos aos arquivos envolvidos nas\nrequisições.</p>\n<p>Quando trabalhamos com <code class=\"language-text\">ETag</code>, obtemos respostas com o seguinte\ncabeçalho:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -i -I http://localhost/exemplo-cache.html\n\nHTTP/1.1 200 OK\n...\nDate: Tue, 01 May 2012 19:46:18 GMT\nETag: &quot;2c6b0d8-13-4befe555d6f80&quot;\n...</code></pre></div>\n<p>É através do valor <code class=\"language-text\">2c6b0d8-13-4befe555d6f80</code> que navegador e servidor\nsaberão se aquele arquivo em questão já está armazenado em <em>cache</em>. Isso\né possível através do cabeçalho <code class=\"language-text\">If-None-Match</code>, enviado pelo\nnavegador na requisição:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -i -I -H &quot;If-None-Match: \\&quot;2c6b0d8-13-4befe555d6f80\\&quot;&quot; http://localhost/exemplo-cache.html\n\nHTTP/1.1 304 Not Modified\nDate: Tue, 01 May 2012 19:50:40 GMT\nETag: &quot;2c6b0d8-13-4befe555d6f80&quot;</code></pre></div>\n<p>Uma vez que o valor bata com o identificador do arquivo, o servidor\ninforma ao navegador que não houve alterações. Então, o navegador\nutiliza a versão do arquivo que está no temporário.</p>\n<h2>Expires</h2>\n<p>A grande desvantagem dos dois métodos acima é que necessitamos consultar\no servidor para verificar a procedência do arquivo. Com o <code class=\"language-text\">Expires</code> e\n<code class=\"language-text\">max-age</code> a “data de validade” vem junto com a requisição, logo, o\nnavegador já sabe quando o arquivo em seu <em>cache</em> irá expirar, e só\nvoltará a consultar o servidor quando este tempo for alcançado.</p>\n<p>Com o <code class=\"language-text\">Expires</code>, o servidor retorna no cabeçalho da resposta uma data\nde validade para um determinado arquivo:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -i -I http://klauslaube.com.br/media/blog/cookies.jpg\n\nHTTP/1.1 200 OK\nDate: Tue, 08 May 2012 01:49:13 GMT\n...\nExpires: Thu, 31 Dec 2037 23:55:55 GMT\n...</code></pre></div>\n<p>Solicitando uma nova requisição para este mesmo arquivo, o navegador\nanalisará a data local e a data de expiração. Se a data atual for maior\nque <code class=\"language-text\">Expires</code>, aí sim o navegador se comunicará com o servidor <em>web</em>,\ne fará um novo <em>download</em> do arquivo.</p>\n<h2>max-age</h2>\n<p>Embora o <code class=\"language-text\">max-age</code> possa parecer um pouco enigmático, ele é (na minha\nopinião) uma solução mais elegante e fácil de implementar que o\n<code class=\"language-text\">Expires</code>.</p>\n<p>Com o <code class=\"language-text\">Expires</code>, temos que informar uma data “absoluta” no cabeçalho,\nou seja, somos obrigados a dizer o dia da semana, mês, ano, hora, minuto\ne até mesmo segundo em que determinado arquivo irá expirar. Logo, temos\no trabalho de interpretar a data da requisição (seja no servidor ou na\naplicação) adicionando o tempo que desejamos de <em>cache</em> e imprimindo\neste valor por extenso.</p>\n<p>Com o <code class=\"language-text\">max-age</code> temos a opção de utilizar datas “relativas”, ou seja,\npodemos dizer ao navegador que o arquivo irá expirar em 1 dia (em\nsegundos):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ curl -i http://localhost/exemplo-cache.html\n\nHTTP/1.1 200 OK\nDate: Mon, 14 May 2012 17:04:29 GMT\n...\nCache-Control: max-age=86400, must-revalidate\n...</code></pre></div>\n<p>Como você já deve ter reparado, não existe um índice de cabeçalho\nespecífico chamado <code class=\"language-text\">max-age</code>. Ele é na verdade um valor do índice\n<code class=\"language-text\">Cache-Control</code>.</p>\n<p>O valor <code class=\"language-text\">must-revalidate</code> solicita aos mecanismos de <em>cache</em> (você\npode estar “atrás” de um <em>proxy</em>) o seguinte: Quando o arquivo\nultrapassar o <code class=\"language-text\">max-age</code>, o <em>user-agent</em> deve revalidar o conteúdo\njunto ao servidor <em>Web</em>. Embora esse seja o comportamento esperado por\nestes mecanismos, tornar esta informação explícita pode garantir que\nferramentas mais “obscuras” sigam este comportamento.</p>\n<h3>Um pouco sobre o Cache-Control</h3>\n<p>O <code class=\"language-text\">Cache-Control</code> foi adicionado na especificação do\n<a href=\"http://www.w3.org/Protocols/rfc2616/rfc2616.html\" title=\"Conheça o protocolo HTTP versão 1.1\"><em>HTTP 1.1</em></a> com a finalidade de contornar\nas limitações do <code class=\"language-text\">Expires</code>, e também de melhorar o controle sobre o\n<em>cache</em> de determinado conteúdo por diferentes tipos de mecanismos.</p>\n<p>Além do uso do <code class=\"language-text\">max-age</code>, é através do <code class=\"language-text\">Cache-Control</code> que podemos\nespecificar o comportamento de <em>cache</em> para o navegador (<code class=\"language-text\">private</code>),\npara algum <em>proxy</em>, servidores intermediários ou requisições <em>HTTPS</em>\n(<code class=\"language-text\">public</code>), ou ainda informarmos que não queremos fazer <em>caching</em> do\nconteúdo (<code class=\"language-text\">no-cache</code>).</p>\n<p><a href=\"http://www.mnot.net/cache_docs/#CACHE-CONTROL\" title=\"Tutorial sobre HTTP caching\">Leia mais sobre <em>Cache-Control</em></a>.</p>\n<p>Vale ressaltar que o <code class=\"language-text\">Cache-Control</code> tem precedência sobre o\n<code class=\"language-text\">Expires</code>.</p>\n<h2>Qual forma utilizar?</h2>\n<p>A resposta é: depende do cenário.</p>\n<p>Para servir arquivos estáticos, a <a href=\"http://www.webfaction.com/\" title=\"Smarter web hosting\"><em>Webfaction</em></a> utiliza os cabeçalhos\n<code class=\"language-text\">Last-Modified</code>, <code class=\"language-text\">Expires</code> e <code class=\"language-text\">max-age</code>, atribuindo aos dois\núltimos valores absurdos de <em>cache</em> (por exemplo, datas de expiração\npara o ano de 2037). Isso garante que o seu navegador, <em>proxy</em> ou\n<em>gateway</em> “nunca esqueça” de uma determina imagem, folha de estilos ou\narquivo <a href=\"/tag/javascript.html\" title=\"Leia mais sobre Javascript\"><em>Javascript</em></a>.</p>\n<p>Mesmo com o uso do <code class=\"language-text\">max-age</code>, é interessante ter o <code class=\"language-text\">Expires</code> como\nalternativa, caso o navegador do internauta não compreenda instruções de\n<code class=\"language-text\">Cache-Control</code>. Já a utilização do <code class=\"language-text\">Last-Modified</code>, segundo o <a href=\"http://www.askapache.com/htaccess/apache-speed-last-modified.html\" title=\"Remove Last-Modified Header\"><em>Ask Apache</em></a>,\nnão é lá muito interessante pois a sua utilização faz com\nque alguns navegadores ignorem o cabeçalho <code class=\"language-text\">Expires</code>. Um argumento\nmais relevante é a eliminação de procedimentos de validação (como o\n<code class=\"language-text\">If-Modified-Since</code> e <code class=\"language-text\">If-None-Match</code>), deixando a cargo apenas do\n<code class=\"language-text\">Expires</code> e <code class=\"language-text\">max-age</code> determinar o tempo de vida do estático em\n<em>cache</em>.</p>\n<p>Em páginas dinâmicas, onde um <em>cache</em> de 5 ou 10 minutos possa ser\naplicado, o <code class=\"language-text\">max-age</code> com <code class=\"language-text\">Expires</code> é fundamental. Já em páginas que\nnecessitam de um conteúdo em tempo real, ou páginas que utilizam\ninformações de <em>cookies</em> ou sessões, a ausência de <em>cache</em> é\njustificável.</p>\n<p>Em documentos <em>HTML</em> onde o conteúdo é atualizado com uma frequência\nindeterminada, o uso de <code class=\"language-text\">Last-Modified</code> ou <code class=\"language-text\">ETag</code> é mais apropriado.\nUma vez que fica difícil determinar quando a atualização irá ocorrer, é\numa boa estratégia fazer com que o navegador atualize o conteúdo do seu\n<em>cache</em> quando necessário.</p>\n<h2>Considerações Finais</h2>\n<p>Embora seja um conteúdo bem introdutório, acho fundamental sabermos as\ndiferentes maneiras de aplicar <em>cache</em> com o protocolo <em>HTTP</em> antes de\npartirmos para soluções específicas. Essas recomendações não são\ninfalíveis, e em um cenário mais “extremo”, necessitam sim de auxílio de\nalgumas ferramentas disponíveis no mercado para tornar o <em>cache</em>\neficiente tanto para a experiência do usuário, quanto para a\nestabilidade dos seus serviços.</p>\n<p>Embora eu tenha utilizado o navegador <em>Web</em> como foco das explicações,\n“robôs”, ferramentas de <em>proxy</em> e <em>gateways</em> também podem fazer controle\nde <em>cache</em>. O comportamento é basicamente o mesmo, variando de acordo\ncom instruções passadas no cabeçalho <code class=\"language-text\">Cache-Control</code>.</p>\n<p>Como não sou nenhum “expert” no assunto, se você possui alguma sugestão\nou correção sobre o uso de <em>cache</em> com <em>HTTP</em>, por favor, conte-nos\natravés dos comentários abaixo.</p>\n<p>Até a próxima…</p>\n<h2>Referências</h2>\n<ul>\n<li><a href=\"http://www.askapache.com/htaccess/apache-speed-compression.html\" title=\"Material bem interessante sobre como melhorar a performance com Cache no Apache\"><em>Ask Apache: Speed tips – Turn on Compressor</em></a></li>\n<li><a href=\"http://betterexplained.com/articles/how-to-optimize-your-site-with-http-caching/\" title=\"Excelente artigo falando sobre HTTP e cache\"><em>Better Explained: How To Optimize Your Site With HTTP Caching</em></a></li>\n<li><a href=\"https://docs.djangoproject.com/en/dev/topics/cache/\" title=\"Leia mais sobre Cache no Django\"><em>Django Documentation: Django’s cache framework</em></a></li>\n<li><a href=\"https://developers.google.com/speed/articles/caching\" title=\"Bom material do Google sobre Caching\"><em>Google Developers: HTTP Caching</em></a></li>\n<li><a href=\"http://condor.depaul.edu/dmumaugh/readings/handouts/SE435/HTTP/http.html\" title=\"Conheça um pouco mais sobre o protocolo HTTP com este artigo científico\"><em>John Yannakopoulos: HyperText Transfer Protocol – A Short Course</em></a></li>\n<li><a href=\"http://www.mnot.net/cache_docs/\" title=\"Excelente conteúdo sobre caching HTTP\"><em>mnot.net: Caching Tutorial</em></a></li>\n<li><a href=\"http://www.webscalingblog.com/performance/caching-http-headers-cache-control-max-age.html\" title=\"Artigo bem objetivo descrevendo o uso do max-age\"><em>Web Scaling Blog: Caching HTTP Headers, Cache-Control: max-age</em></a></li>\n</ul>","excerpt":"Em tempos de alta demanda, o cache pode tornar-se o melhor amigo das\naplicações web.\nAtravés dele temos uma opção prática, acessível e…","frontmatter":{"date":"2012-05-14T23:14:46.000Z","title":"O cache e o HTTP","tags":["desenvolvimento-web","infraestrutura","cache","http"],"thumbnail":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAMCBAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAH3YbydAEwqD//EABoQAAICAwAAAAAAAAAAAAAAAAACATEQESH/2gAIAQEAAQUCmdCP0e3oshFXH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABwQAAEDBQAAAAAAAAAAAAAAABAAASECIlGBsf/aAAgBAQAGPwKVdoU4XDDD/8QAGhABAAIDAQAAAAAAAAAAAAAAARExABBBUf/aAAgBAQABPyE/LFkK3i9XGjgGHV0QENY5MDr/2gAMAwEAAgADAAAAEKPHAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EABwQAQACAwEBAQAAAAAAAAAAAAERIQAQUTFhcf/aAAgBAQABPxAcVBYmMAqKLKd/fmjHpieClYpCtYVDpyMqk7kV/hMuv//Z","width":180,"height":180,"src":"/static/78d27067b6fb8434ee2a0d6d0e67c09a/a8ad2/performance.jpg","srcSet":"/static/78d27067b6fb8434ee2a0d6d0e67c09a/a8ad2/performance.jpg 1x"}},"publicURL":"/static/78d27067b6fb8434ee2a0d6d0e67c09a/performance.jpg"}},"fields":{"readingTime":{"minutes":8.665},"slug":"/2012/05/14/o-cache-e-o-http.html"}},"site":{"siteMetadata":{"author":{"name":"Klaus Peter Laube","gravatar":"https://en.gravatar.com/userimage/12163112/d3ae0c6239980b01ff1f1730b65c2ebe.jpg"},"siteUrl":"https://klauslaube.com.br"}}},"pageContext":{"slug":"/2012/05/14/o-cache-e-o-http.html"}}}