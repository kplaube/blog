<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>Migrations em Django com South | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="Em um mundo ideal, o procedimento de deploy (para entregas contínuas) deve ser automatizado. Com o South, &quot;migrar&quot; a estrutura e os dados da sua base de dados para a versão presente em seu novo deploy, é simples, prático e 100% integrado ao Django."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, ambiente-de-desenvolvimento, python, django, migrations, south"><meta property=og:title content="Migrations em Django com South"><meta property=og:description content="Em um mundo ideal, o procedimento de deploy (para entregas contínuas) deve ser automatizado. Com o South, &quot;migrar&quot; a estrutura e os dados da sua base de dados para a versão presente em seu novo deploy, é simples, prático e 100% integrado ao Django."><meta property=og:url content=https://klauslaube.com.br/2011/11/20/migrations-em-django-south.html><meta property=og:image content><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2011/11/20/migrations-em-django-south.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> Migrations em Django com South </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2011-11-20T21:35:00-02:00 itemprop=datePublished>20 Nov, 2011</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/south-logo.png alt="Logotipo do South" class=representative-image width=180 height=180> <p>E quem nunca precisou adicionar ou remover alguma coluna, nas tabelas do seu banco de dados, depois que a aplicação já estava em produção? Os riscos existem (e são altos), e podem ser diminuidos através de processos automatizados.</p> <!-- PELICAN_END_SUMMARY --> <p>Em um mundo ideal, o procedimento de <em>deploy</em> (para entregas contínuas) <strong>deve ser automatizado</strong>. Com o <em>South</em>, “migrar” a estrutura e os dados da sua base de dados para a versão presente em seu novo deploy, é simples, prático e 100% integrado ao <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre Django"><em>Django</em></a>.</p> <h2>Instalando o South</h2> <p>O <a href=http://south.aeracode.org/ title="Página oficial do projeto South"><em>South</em></a> é muito, mas muito simples de instalar. Utilizando o <em>pip</em>, basta o seguinte comando para termos os <em>eggs</em> em nosso <code>PYTHONPATH</code>:</p> <div class=highlight><pre><span></span>$ pip install south
</pre></div> <p>Não podemos esquecer de adicioná-lo ao <code>INSTALLED_APPS</code> do <code>settings.py</code> (afinal, trata-se de uma <em>app Django</em>):</p> <div class=highlight><pre><span></span><span class=n>INSTALLED_APPS</span> <span class=o>=</span> <span class=p>(</span>
    <span class=s1>&#39;django.contrib.auth&#39;</span><span class=p>,</span>
    <span class=o>...</span>
    <span class=s1>&#39;south&#39;</span><span class=p>,</span>
<span class=p>)</span>
</pre></div> <p>Pronto! Você acabou de ganhar alguns comandos para construir as suas <em>migrations</em>.</p> <h2>Direto para a prática</h2> <p>Sem perder tempo, vamos construir uma <em>app Django</em> para que possamos demonstrar o uso do <em>South</em>:</p> <div class=highlight><pre><span></span>$ python manage.py startapp blog
</pre></div> <p>Lembrando de adicioná-la ao <code>settings.py</code>:</p> <div class=highlight><pre><span></span><span class=c1># settings.py</span>
<span class=n>INSTALLED_APPS</span> <span class=o>=</span> <span class=p>(</span>
    <span class=s1>&#39;django.contrib.auth&#39;</span><span class=p>,</span>
    <span class=o>...</span>
    <span class=s1>&#39;south&#39;</span><span class=p>,</span>
    <span class=s1>&#39;blog&#39;</span><span class=p>,</span>
<span class=p>)</span>
</pre></div> <p>Vamos criar um modelo bem básico, com alguns campos (posteriormente, incrementaremos esta estrutura):</p> <div class=highlight><pre><span></span><span class=c1># blog/models.py</span>
<span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>

<span class=k>class</span> <span class=nc>Blog</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>titulo</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=s1>&#39;Titulo&#39;</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
    <span class=n>texto</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>(</span><span class=s1>&#39;Texto&#39;</span><span class=p>)</span>
</pre></div> <p>Através do comando <code>schemamigration</code>, com parâmetro <code>–-initial</code>, criaremos a nossa primeira migration:</p> <div class=highlight><pre><span></span>$ python manage.py schemamigration blog --initial
</pre></div> <p>Vale notar que o comando acima não cria nenhuma tabela no banco de dados. O que ele faz é criar um conjunto de instruções que representa este modelo. Na medida que são feitas alterações no modelo, é necessário gerar novas <em>migrations</em>, que serão sempre baseados nas estruturas já criadas.</p> <p>Por exemplo, vamos de fato criar a tabela <em>blog</em> no banco de dados:</p> <div class=highlight><pre><span></span>$ python manage.py migrate blog

Running migrations <span class=k>for</span> blog:
- blog:0001_initial
- Loading initial data <span class=k>for</span> blog.
No fixtures found.
</pre></div> <p>Se houvesse alguma <em>fixture</em>, o <em>South</em> faria o <em>insert</em> das informações para você.</p> <p>A primeira <em>migration</em> foi criada. Como mencionado antes, a partir de agora toda migration criada será baseada na <em>migration</em> “anterior” (podemos deduzir a ordem das <em>migrations</em> através do prefixo numérico, no caso acima, o <code>0001</code> indica que esta é a primeira).</p> <p>Vamos adicionar um campo no modelo (que equivale a uma coluna no banco de dados), para ilustrar a criação de novas <em>migrations</em>:</p> <div class=highlight><pre><span></span><span class=c1># blog/models.py</span>

<span class=k>class</span> <span class=nc>Blog</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>titulo</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>CharField</span><span class=p>(</span><span class=s1>&#39;Titulo&#39;</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
    <span class=n>resumo</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>(</span><span class=s1>&#39;Resumo&#39;</span><span class=p>,</span> <span class=n>blank</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span> <span class=n>null</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
    <span class=n>texto</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>TextField</span><span class=p>(</span><span class=s1>&#39;Texto&#39;</span><span class=p>)</span>
</pre></div> <p>Não é mais necessário o uso do parâmetro <code>-–initial</code>, de agora em diante precisaremos do parâmetro <code>–-auto</code> (que construirá a <em>migration</em> automaticamente, de acordo com a primeira já existente):</p> <div class=highlight><pre><span></span>$ python manage.py schemamigration blog --auto

+ Added field resumo on blog.Blog
Created 0002_auto__add_field_blog_resumo.py. You can now apply this migration
with: ./manage.py migrate blog
</pre></div> <p>Pronto! Uma nova <em>migration</em> foi criada… e com um nome bem intuitivo (repare no prefixo numérico). Basta darmos a ordem de replicar estas instruções no banco de dados:</p> <div class=highlight><pre><span></span>$ python manage.py migrate blog

Running migrations <span class=k>for</span> blog:
- Migrating forwards to 0002_auto__add_field_blog_resumo.
- blog:0002_auto__add_field_blog_resumo
- Loading initial data <span class=k>for</span> blog.
No fixtures found.
</pre></div> <p>A nova coluna foi inserida na tabela <em>blog</em>, sem necessitar de nenhuma intervenção manual. Se você ficou curioso para saber como essa “mágica” acontece, basta abrir as <em>migrations</em> e ver que são instruções escritas em <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre Python"><em>Python</em></a>, que interagem com o banco de dados “por trás” do <em>ORM</em> do <em>Django</em>.</p> <p>O <em>South</em> possui mais alguns recursos interessantes (como <em>data migrations</em>), que você pode conferir <a href=http://south.aeracode.org/docs/tutorial/index.html title="Aprenda mais sobre o South">neste tutorial</a>.</p> <h2>Referências</h2> <ul> <li><a href=http://south.aeracode.org/ title="Visite a página oficial do projeto South"><em>South – Intelligent schema and data migrations for Django</em></a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/ambiente-de-desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>ambiente-de-desenvolvimento</a> <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre" class=Article-tagLink>python</a> <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre" class=Article-tagLink>django</a> <a href=https://klauslaube.com.br/tag/migrations.html title="Leia mais sobre" class=Article-tagLink>migrations</a> <a href=https://klauslaube.com.br/tag/south.html title="Leia mais sobre" class=Article-tagLink>south</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2011/11/20/migrations-em-django-south.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>