<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>LSP e o PyLS | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="Uma das virtudes do VS Code é como ele integra-se facilmente com diferentes linguagens. O esforço é pequeno, geralmente resumindo-se à instalação de um..."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, web, editores, ide, vscode, vim, python, pyls, lsp"><meta property=og:title content="LSP e o PyLS"><meta property=og:description content="Uma das virtudes do VS Code é como ele integra-se facilmente com diferentes linguagens. O esforço é pequeno, geralmente resumindo-se à instalação de um..."><meta property=og:url content=https://klauslaube.com.br/2019/05/24/lsp-e-o-pyls.html><meta property=og:image content=https://klauslaube.com.br//images/blog/vim-lsp.jpg><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2019/05/24/lsp-e-o-pyls.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content=https://klauslaube.com.br//images/blog/vim-lsp.jpg> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> LSP e o PyLS </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2019-05-24T10:53:00-03:00 itemprop=datePublished>24 Mai, 2019</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/python-code.jpg alt="Código Python" class=representative-image width=180 height=180> <p>Uma das virtudes do <a href=https://klauslaube.com.br/tag/vscode.html title="Leia mais sobre o editor"><em>VS Code</em></a> é como ele integra-se facilmente com diferentes linguagens. O esforço é pequeno, geralmente resumindo-se à instalação de um único <em>plugin</em>. Essa característica o torna uma ferramenta extremamente produtiva, e que vem conquistando o coração dos desenvolvedores ao redor do mundo.</p> <!-- PELICAN_END_SUMMARY --> <p>O curioso é que o <em>VS Code</em> utiliza um protocolo aberto para ter esse "jeitão" de <em>IDE</em>, chamado <em>Language Server Protocol</em>, que entre outras funcionalidades traz ao editor a possibilidade de <em>autocomplete</em>, <em>go to definition</em>, <em>diagnosis</em> e <em>documentation</em>.</p> <p>É... <em>Microsoft</em> popularizando protocolos abertos. Tempos interessantes esses que vivemos, não?</p> <h2>LSP - Language Server Protocol</h2> <p>Durante o desenvolvimento do <em>VS Code</em>, a <em>Microsoft</em> introduziu o <a href=https://microsoft.github.io/language-server-protocol/ title="Leia na página oficial do projeto"><em>Language Server Protocol</em></a>. O <a href=https://langserver.org/ title="A community-driven source of knowledge for Language Server Protocol implementations">langserver.org</a> o define da seguinte forma:</p> <blockquote> <p>The Language Server protocol is used between a tool (the client) and a language smartness provider (the server) to integrate features like auto complete, go to definition, find all references and alike into the tool.</p> </blockquote> <p>Em outras palavras, é um <a href=https://microsoft.github.io/language-server-protocol/specification title="Leia a especificação completa">protocolo</a> que descreve a comunicação entre um cliente (um editor de textos, por exemplo) e um servidor (ligado à uma determinada linguagem), com a motivação de proporcionar e enriquecer ferramentas de desenvolvimento.</p> <p><img class=align-center-keep-size src=/images/blog/vim-lsp.jpg width=650 height=296 title="Ilustração de como funciona a comunicação entre cliente e servidor (kieranbamforth.me)" alt="Ilustração de como funciona a comunicação entre cliente e servidor (kieranbamforth.me)"></p> <p>Ou seja, podemos ter uma solução única para <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre Python"><em>Python</em></a>, que traga as mesmas funcionalidades para diferentes editores ou <em>IDEs</em>. Em contrapartida, podemos ter um único editor que suporte diferentes linguagens e tais funcionalidades avançadas. O <em>langserver.org</em> chama esse problema de "The Matrix Problem":</p> <p><img class=align-center-keep-size src=/images/blog/lsp-the-matrix-problem.png width=740 height=155 title="Com LSP, temos Go funcionando para diferentes editores, seguindo os mesmos princípios (langserver.org)" alt="Com LSP, temos Go funcionando para diferentes editores, seguindo os mesmos princípios (langserver.org)"></p> <p>Como afirma o site oficial do projeto:</p> <blockquote> <p>LSP is a win for both language providers and tooling vendors!</p> </blockquote> <h2>Como funciona?</h2> <p>Na prática, o que acontece é uma comunicação inter-processos entre o <em>language server</em> e a ferramenta de desenvolvimento. O protocolo utilizado para tal operação é o <em>JSON-RPC</em>, um protocolo simples, e com um formato de dados extremamente popular.</p> <p><img class=align-center-keep-size src=/images/blog/language-server-sequence.png width=740 height=307 title="Exemplo de como funciona a comunicação entre cliente e servidor (microsoft.github.io)" alt="Exemplo de como funciona a comunicação entre cliente e servidor (microsoft.github.io)"></p> <p>Nem toda linguagem pode suportar todas as funcionalidade definidas pelo protocolo (o mesmo vale para as ferramentas de desenvolvimento), mas isso não impede a sua adoção. O protocolo permite que tanto cliente como servidor "anunciem" suas capacidades, portanto, as duas pontas podem ter um comportamento preventivo quando determinada capacidade (como <em>go to definition</em>) não é suportada.</p> <h2>PyLS - Python Language Server</h2> <p>Para <em>Python</em>, além do <em>language server</em> implementado pela própria <em>Microsoft</em> e <a href=https://github.com/microsoft/python-language-server title="Repositório do Microsoft Python Language Server">usado no <em>VS Code</em></a>, temos o <a href=https://github.com/palantir/python-language-server title="Repositório do projeto"><em>Python Language Server</em></a>. Ele conta com as seguintes funcionalidades:</p> <ul> <li><em>Auto completion</em></li> <li><em>Code linting</em></li> <li><em>Signature help</em></li> <li><em>Go to definition</em></li> <li><em>Hover</em></li> <li><em>Find references</em></li> <li><em>Document symbols</em></li> <li><em>Document formatting</em></li> </ul> <p>O que acho mais interessante em relação ao projeto é que ele não reinventa a roda. Por exemplo, ele não implementa uma nova ferramenta de <em>linting</em>, pelo contrário, ele utiliza ferramentas que já são bem conhecidas pela comunidade:</p> <ul> <li><em>Auto completion</em>, <em>definitions</em>, <em>hover</em>, <em>references</em>, <em>signature help</em> e <em>symbols</em> são resolvidos via <a href=https://github.com/davidhalter/jedi title="Awesome completion and static analysis for Python"><em>Jedi</em></a></li> <li><em>Auto completion</em> e <em>renaming</em> é resolvido via <a href=https://github.com/python-rope/rope title="Python refactoring library"><em>Rope</em></a></li> <li><em>Linting</em> é resolvido via <a href=https://github.com/PyCQA/mccabe title="McCabe complexity checker"><em>McCabe</em></a>, <a href=https://github.com/PyCQA/pyflakes title="Checks Python source files for errors"><em>Pyflakes</em></a>, <a href=https://github.com/pycqa/pycodestyle title="Python style checker"><em>pycodestyle</em></a> e <a href=https://github.com/PyCQA/pydocstyle title="Docstring style checker"><em>pydocstyle</em></a></li> <li><em>Formatting</em> é resolvido via <a href=https://github.com/hhatto/autopep8 title="Formats Python code to PEP 8"><em>autopep8</em></a> e <a href=https://github.com/google/yapf title="A formatter for Python files"><em>YAPF</em></a></li> </ul> <p>Há um certo grau de customização, como por exemplo usar o <a href=https://klauslaube.com.br/2019/02/07/deixe-darem-pitaco-no-seu-codigo-com-black.html title="Leia mais sobre Black"><em>Black</em></a> ao invés de <em>YAPF</em>. Discutiremos mais sobre esse tópico a seguir.</p> <h2>Clientes LSP</h2> <p>Segundo o <em>langserver.org</em>, os principais <em>IDEs</em> e editores já possuem alguma forma de cliente implementado. Seja através de extensões (como <em>JetBrains IDE</em>, <a href=https://klauslaube.com.br/tag/vim.html title="Leia mais sobre Vim"><em>Vim</em></a>, <em>Sublime</em>, <em>Atom</em> e <em>Emacs</em>), ou através de suporte <em>built-in</em> (como <em>VS Code</em> e <em>Oni</em>).</p> <p><img class=align-center-keep-size src=/images/blog/lsp-one-ring.jpeg width=740 height=493 title="Sauron faz um anel para juntar a todos. Sem querer comparar Microsoft com Sauron, mas espero que isso não acabe em uma guerra (lego-lord-of-the-rings.wikia.com)" alt="Sauron faz um anel para juntar a todos. Sem querer comparar Microsoft com Sauron, mas espero que isso não acabe em uma guerra (lego-lord-of-the-rings.wikia.com)"></p> <p>Para <em>Vim</em>, uma opção que tenho usado com sucesso é o <a href=https://github.com/autozimu/LanguageClient-neovim title="Repositório oficial do projeto"><em>LanguageClient-neovim</em></a>, que embora possa parecer exclusivo para o <em>Neovim</em>, possui suporte para <em>Vim 8.x</em>.</p> <h2>Na prática</h2> <h3>Configurando o servidor</h3> <p>Vamos para um exemplo prático de como usar <em>LSP</em> e <em>Vim</em> com <em>Python</em>. Mas antes, deixa eu definir algumas <em>constraints</em> do meu ambiente de desenvolvimento:</p> <ul> <li>Quero utilizar <em>flake8</em> ao invés de <em>pycodestyle</em>;</li> <li>Quero utilizar <em>Black</em> ao invés de <em>YAPF</em> ou <em>autopep8</em>;</li> <li>Quero utilizar <em>isort</em> como uma das opções de formatação.</li> </ul> <p>Para começar, vamos instalar o <em>language server</em>. Eu prefiro tê-lo dentro do <a href=https://klauslaube.com.br/tag/virtualenv.html title="Leia mais sobre Virtualenv">ambiente virtual</a> do projeto em que estou trabalhando. É trabalhoso e repetitivo se você estiver trabalhando em diferentes projetos e <em>virtualenvs</em>! Uma alternativa mais prática é tê-lo instalado em uma instância global do <a href=https://klauslaube.com.br/2016/04/26/o-simples-e-poderoso-pyenv.html title="O simples e poderoso Pyenv"><em>pyenv</em></a>. Fica a seu critério o destino da instalação:</p> <div class=highlight><pre><span></span>$ pip install python-language-server
</pre></div> <p>O próprio servidor identificará quais ferramentas você tem instaladas e habilitará determinada capacidade proporcionada por tal ferramenta (por exemplo, se o <em>Rope</em> estiver instalado, será capaz de fazer <em>renaming</em>). Mas dentre elas o <em>Jedi</em> é fundamental, e por isso é instalada automaticamente como dependência do <em>PyLS</em>.</p> <p>Nesse momento temos grande parte das funcionalidades cobertas pelo <em>LSP</em> habilitadas pelo servidor. Uma muito útil, que ainda está faltando, é o <em>renaming</em>. Segundo a lista acima, conseguimos tal capacidade ao instalar o <em>Rope</em>:</p> <div class=highlight><pre><span></span>$ pip install &#39;python-language-server[rope]&#39;
</pre></div> <p>Se você está interessado em utilizar a configuração padrão do <em>python-language-server</em>, uma opção mais prática é instalar todos os <em>providers</em> de uma só vez:</p> <div class=highlight><pre><span></span>$ pip install &#39;python-language-server[all]&#39;
</pre></div> <p>Para fins didáticos estamos resolvendo as dependências manualmente. Há uma outra forma de gerenciar quais <em>providers</em> serão utilizados, que discutiremos a seguir.</p> <p>Para termos o <em>isort</em> e o <em>Black</em> habilitados como ferramentas de formatação, precisaremos recorrer à <em>plugins</em> de terceiros:</p> <div class=highlight><pre><span></span>$ pip install pyls-isort pyls-black
</pre></div> <p>Infelizmente, o <code>pyls-black</code> exige que você não tenha o <code>autopep8</code> instalado para funcionar. Como não há um controle manual para decidir qual será usado, a melhor forma é garantindo que apenas uma das duas extensões esteja instalada.</p> <p>Temos tudo o que é necessário para o lado do servidor.</p> <h3>Configurando o cliente</h3> <p>A melhor forma de instalarmos o <em>LanguageClient-neovim</em> é através do utilitário <code>Plug</code>:</p> <div class=highlight><pre><span></span><span class=c>&quot; ~/.vimrc</span>

Plug <span class=s1>&#39;autozimu/LanguageClient-neovim&#39;</span><span class=p>,</span> {
    \ <span class=s1>&#39;branch&#39;</span>: <span class=s1>&#39;next&#39;</span><span class=p>,</span>
    \ <span class=s1>&#39;do&#39;</span>: <span class=s1>&#39;bash install.sh&#39;</span><span class=p>,</span>
    \ }

Plug <span class=s1>&#39;junegunn/fzf&#39;</span>
</pre></div> <p>Ele funciona muito bem com o <a href=https://github.com/junegunn/fzf.vim title="Veja o repositório oficial do projeto"><em>fzf</em></a>, portanto, é uma boa pedida termos os dois disponíveis.</p> <p>O próximo passo é informar ao cliente como encontrar o servidor da linguagem:</p> <div class=highlight><pre><span></span><span class=c>&quot; ~/.vimrc</span>

<span class=p>(</span>...<span class=p>)</span>

<span class=k>let</span> <span class=k>g</span>:LanguageClient_serverCommands <span class=p>=</span> {
    \ <span class=s1>&#39;python&#39;</span>: [<span class=s1>&#39;pyls&#39;</span>]<span class=p>,</span>
    \ }
</pre></div> <p>Ainda precisamos dizer ao <em>LSP</em> sobre as nossas preferências. O arquivo abaixo está situado na raíz do projeto que estou trabalhando, mais especificamente em <code>./.vim/settings.json</code>:</p> <div class=highlight><pre><span></span><span class=p>{</span>
  <span class=nt>&quot;pyls&quot;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&quot;configurationSources&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;flake8&quot;</span><span class=p>],</span>
    <span class=nt>&quot;plugins&quot;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&quot;yapf&quot;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&quot;enabled&quot;</span><span class=p>:</span> <span class=kc>false</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</pre></div> <p>Para fins didáticos adicionei o <code>yapf</code> à configuração. Alguns <em>plugins</em> possuem a flexibilidade de mesmo que instalados, poderem ser desabilitados.</p> <p>Pronto! O cliente está configurado, e com os seguintes comandos você pode explorar todas as funcionalidades do <em>LSP</em>:</p> <ul> <li><code>Ctrl+x Ctrl+o</code>: <em>Auto completion</em> via <em>Omni completion</em> (o <a href=https://github.com/Shougo/deoplete.nvim title="Dark powered asynchronous completion framework for neovim/Vim8"><em>Deoplete</em></a> é uma boa pedida)</li> <li><code>:call LanguageClient#textDocument_definition()</code>: <em>Go to definition</em></li> <li><code>:call LanguageClient#textDocument_hover()</code>: <em>Hover</em></li> <li><code>:call LanguageClient#textDocument_references()</code>: <em>References</em></li> <li><code>:call LanguageClient#textDocument_documentSymbol()</code>: Lista de <em>Symbols</em></li> <li><code>:call LanguageClient#textDocument_rename()</code>: <em>Renaming</em></li> <li><code>:call LanguageClient#textDocument_formatting()</code>: <em>Formatting</em></li> <li><code>:call :call LanguageClient_contextMenu()</code>: Menu de contexto mostrando todas as opções disponíveis</li> </ul> <p><img class=align-center-keep-size src=/images/blog/vim-lsp-autocomplete.png width=640 height=370 title="Exemplo do LSP funcionando com o Vim" alt="Exemplo do LSP funcionando com o Vim"></p> <p>Agora é só configurar os <em>key bindings</em> e correr para o abraço :)</p> <h2>Referências</h2> <ul> <li><a href=https://www.kieranbamforth.me/blog/vim-lsp.html>kieranbamforth.me - Vim + Language Server Protocol—in 2019</a></li> <li><a href=https://langserver.org/ >Langserver.org - A community-driven source of knowledge</a></li> <li><a href=https://microsoft.github.io/language-server-protocol/ >Language Server Protocol official page</a></li> <li><a href=https://www.thisisvini.com/vim-better-go-to-definition-completion/ >This is Vini - Vim: Better "Go to definition" and completion using ALE</a></li> <li><a href=https://en.wikipedia.org/wiki/JSON-RPC>Wikipedia - JSON-RPC</a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre" class=Article-tagLink>web</a> <a href=https://klauslaube.com.br/tag/editores.html title="Leia mais sobre" class=Article-tagLink>editores</a> <a href=https://klauslaube.com.br/tag/ide.html title="Leia mais sobre" class=Article-tagLink>ide</a> <a href=https://klauslaube.com.br/tag/vscode.html title="Leia mais sobre" class=Article-tagLink>vscode</a> <a href=https://klauslaube.com.br/tag/vim.html title="Leia mais sobre" class=Article-tagLink>vim</a> <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre" class=Article-tagLink>python</a> <a href=https://klauslaube.com.br/tag/pyls.html title="Leia mais sobre" class=Article-tagLink>pyls</a> <a href=https://klauslaube.com.br/tag/lsp.html title="Leia mais sobre" class=Article-tagLink>lsp</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2019/05/24/lsp-e-o-pyls.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>