<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>BDD com Django e Behave | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="Testar o comportamento da aplicação é uma grande prática de TDD. O Behave é uma biblioteca de BDD Python, que casa muito bem com o framework Django."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, testes, bdd, aceitacao, python, django, behave, splinter"><meta property=og:title content="BDD com Django e Behave"><meta property=og:description content="Testar o comportamento da aplicação é uma grande prática de TDD. O Behave é uma biblioteca de BDD Python, que casa muito bem com o framework Django."><meta property=og:url content=https://klauslaube.com.br/2016/02/03/bdd-com-django-e-behave.html><meta property=og:image content=https://klauslaube.com.br//images/blog/oh-behave.jpg><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2016/02/03/bdd-com-django-e-behave.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content=https://klauslaube.com.br//images/blog/oh-behave.jpg> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> BDD com Django e Behave </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2016-02-03T23:50:00-02:00 itemprop=datePublished>03 Fev, 2016</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/bdd-given-when-then.jpg alt="Given, When, Then (opkey.crestechglobal.com)" class=representative-image width=180 height=180> <p>Testar o comportamento da sua aplicação, ao invés de pequenos módulos isolados, é uma grande prática no que diz respeito a escrita de testes que guiem o seu desenvolvimento.</p> <!-- PELICAN_END_SUMMARY --> <p>Deixando a polêmica do "<a href=http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html title="TDD is dead. Long live testing.">TDD is dead</a>" de lado, criar cenários que garantem um determinado fluxo, além de servir como um excelente contrato à sua suite de aceitação, é uma ótima ferramenta para garantir que a integração <em>back-end/front-end</em> está funcionando de acordo com o esperado.</p> <p>Devo ser sincero com você, caro leitor: Fazer <a href=https://klauslaube.com.br/tag/bdd.html title="Leia mais sobre BDD"><em>BDD</em></a> com <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre Django"><em>Django</em></a> (IMO) sempre foi uma dor de cabeça. Já utilizei algumas ferramentas, como <a href=https://klauslaube.com.br/2011/07/18/ferramentas-de-testes-em-django-parte-1.html><em>unittest</em></a> focado em comportamento, <a href=https://klauslaube.com.br/2011/07/18/ferramentas-de-testes-em-django-parte-1.html><em>doctests</em></a>, <a href=https://klauslaube.com.br/2011/07/23/ferramentas-de-testes-em-django-parte-2.html><em>Lettuce</em></a>, <em>Pycurracy</em> e até mesmo <em>Jasmine</em>... Nada pareceu ser "o certo a se fazer".</p> <p>Recentemente esbarrei com um artigo ensinando a usar o <a href=http://pythonhosted.org/behave/ title="BDD for Python"><em>Behave</em></a>, um <em>engine</em> de testes <em>BDD</em> para <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre Python"><em>Python</em></a>... E foi aí que a minha opinião mudou.</p> <h2>Oh, behave!</h2> <p>O <em>Behave</em> é uma biblioteca <em>Python</em> que permite a escrita de <em>specs</em> em linguagem humana, e a execução dos cenários através de <em>asserts</em> em "linguagem de programação". Agnóstico de <em>framework</em>, é um <em>engine</em> promissor, <a href=http://pythonhosted.org/behave/tutorial.html title="Conheça o tutorial do Behave">fácil de usar</a>, e que possui uma boa comunidade dando suporte.</p> <p><img class=align-center src=/images/blog/oh-behave.jpg width=480 height=415 title="Austin Powers: Oh behave (flickr.com)" alt="Austin Powers: Oh behave (flickr.com)"></p> <p>Você pode escrever a integração do <em>lib</em> com o <em>Django</em>, como demonstrado na <a href=http://pythonhosted.org/behave/django.html title="Exemplo de integração entre Behave e Django">documentação oficial</a>. Como eu sou preguiçoso, prefiro utilizar o módulo <code>behave-django</code>, criado por <a href=https://github.com/mixxorz title="Perfil do mixxorz no GitHub">Mitchel Cabuloy</a>:</p> <div class=highlight><pre><span></span>$ pip install behave-django
</pre></div> <p>Não podemos esquecer de colocá-lo no <code>INSTALLED_APPS</code>:</p> <div class=highlight><pre><span></span><span class=n>INSTALLED_APPS</span> <span class=o>=</span> <span class=p>(</span>
    <span class=o>...</span>
    <span class=s1>&#39;behave_django&#39;</span><span class=p>,</span>
    <span class=o>...</span>
<span class=p>)</span>
</pre></div> <p>Agora basta criar uma estrutura na raíz do seu projeto (no mesmo nível do <code>manage.py</code>), com a seguinte formação:</p> <div class=highlight><pre><span></span><span class=n>features</span><span class=o>/</span>
    <span class=n>steps</span><span class=o>/</span>
        <span class=n>steps</span><span class=p>.</span><span class=n>py</span>
    <span class=n>environment</span><span class=p>.</span><span class=n>py</span>
    <span class=n>funcionalidade</span><span class=p>.</span><span class=n>feature</span>
</pre></div> <p>Vamos para um exemplo mais prático: <em>Eu quero que minha home exiba meu nome de usuário, caso eu esteja logado</em>.</p> <p>Começaremos pelo arquivo <code>.feature</code>. Vou chamá-lo de <code>features/home-logada.feature</code>:</p> <div class=highlight><pre><span></span><span class=nv>Feature</span>: <span class=nv>Logged</span> <span class=nv>in</span> <span class=nv>page</span>

    <span class=nv>Scenario</span>: <span class=nv>Access</span> <span class=nv>index</span> <span class=nv>page</span>

        <span class=nv>Given</span> <span class=nv>an</span> <span class=nv>authenticated</span> <span class=nv>user</span>
        <span class=nv>When</span> <span class=nv>I</span> <span class=nv>access</span> <span class=nv>the</span> <span class=nv>home</span> <span class=nv>page</span>
        <span class=k>Then</span> <span class=nv>I</span> <span class=nv>see</span> <span class=nv>my</span> <span class=nv>username</span> <span class=nv>printed</span>
</pre></div> <p>Já podemos executar o <code>behave</code> através do <code>manage.py</code>:</p> <div class=highlight><pre><span></span>$ python manage.py behave
</pre></div> <p>Você verá uma saída sinalizando que nosso cenário está montado, mas que ainda não há testes executando de fato.</p> <p>O arquivo de teste pode ter o nome que você desejar, o <em>Behave</em> olhará para cada ocorrência dentro de <code>steps/</code> e coletará os passos que serão usados para a execução das especificações.</p> <p>Mas antes de escrevermos os testes, vamos falar de uma ferramenta essencial quando estamos fazendo testes de interface <em>web</em> com <em>Python</em>.</p> <h2>Splinter</h2> <p>Diretamente da <a href=https://splinter.readthedocs.org/en/latest/ title="Documentação do Splinter">documentação oficial</a> do <em>Splinter</em>:</p> <blockquote> <p>Splinter is an open source tool for testing web applications using Python. It lets you automate browser actions, such as visiting URLs and interacting with their items.</p> </blockquote> <p>A ferramenta fornece uma <em>API</em> única para diferentes ferramentas de testes de interface <em>web</em>, como <em>Selenium</em>, <em>PhantomJS</em> e <em>zope.testbrowser</em>.</p> <p>Conseguimos instalá-la de forma muito fácil, através do comando <code>pip</code>:</p> <div class=highlight><pre><span></span>$ pip install splinter
</pre></div> <p>É ele que nos permite, através de sua interface, escrever testes utilizando o driver do <em>Firefox</em> (por exemplo), e deixar as <em>tasks</em> executando em nosso servidor de integração contínua com um driver <em>headless</em>, como o <em>PhantomJS</em>.</p> <h3>Django + Behave + Splinter == Epic Win</h3> <p>Podemos utilizar o <em>Splinter</em> juntamente com a mecânica de teste do <em>Behave</em>. A maneira mais fácil é através do esquema de configuração da suite, criando o arquivo <code>features/environment.py</code>, com o seguinte conteúdo:</p> <div class=highlight><pre><span></span><span class=kn>from</span> <span class=nn>splinter</span> <span class=kn>import</span> <span class=n>Browser</span>


<span class=k>def</span> <span class=nf>before_all</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
    <span class=n>context</span><span class=o>.</span><span class=n>browser</span> <span class=o>=</span> <span class=n>Browser</span><span class=p>()</span>
    <span class=n>context</span><span class=o>.</span><span class=n>server_url</span> <span class=o>=</span> <span class=s1>&#39;http://localhost:8000&#39;</span>


<span class=k>def</span> <span class=nf>after_all</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
    <span class=n>context</span><span class=o>.</span><span class=n>browser</span><span class=o>.</span><span class=n>quit</span><span class=p>()</span>
</pre></div> <p>Pronto! O contexto dos nossos testes tem a propriedade <code>browser</code>, que é a instância do <em>Splinter</em> para execução dos testes de interface.</p> <p>As <em>specs</em> executarão com o <em>Firefox</em>, por padrão. Caso queira alterar o navegador, basta especificá-lo na instância de <code>Browser</code>:</p> <div class=highlight><pre><span></span><span class=n>context</span><span class=o>.</span><span class=n>browser</span> <span class=o>=</span> <span class=n>Browser</span><span class=p>(</span><span class=s1>&#39;chrome&#39;</span><span class=p>)</span>
</pre></div> <h2>Dado um determinado cenário</h2> <p>Vamos escrever o código <em>Python</em> necessário para atender a seguinte condição:</p> <div class=highlight><pre><span></span><span class=n>Given</span> <span class=n>an</span> <span class=n>authenticated</span> <span class=k>user</span>
</pre></div> <p>Para isso, criaremos um <em>step</em> específico para autenticação:</p> <div class=highlight><pre><span></span><span class=c1># features/steps/auth.py</span>

<span class=kn>from</span> <span class=nn>behave</span> <span class=kn>import</span> <span class=n>given</span>
<span class=kn>from</span> <span class=nn>django.contrib.auth.models</span> <span class=kn>import</span> <span class=n>User</span>


<span class=nd>@given</span><span class=p>(</span><span class=s1>&#39;an authenticated user&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>given_auth_user</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
    <span class=n>User</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>create_superuser</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;foo@bar&#39;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=s1>&#39;test&#39;</span><span class=p>)</span>

    <span class=n>br</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>browser</span>
    <span class=n>br</span><span class=o>.</span><span class=n>visit</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>base_url</span> <span class=o>+</span> <span class=s1>&#39;/admin/&#39;</span><span class=p>)</span>
    <span class=n>br</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;test&#39;</span><span class=p>)</span>
    <span class=n>br</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=s1>&#39;test&#39;</span><span class=p>)</span>
    <span class=n>br</span><span class=o>.</span><span class=n>find_by_css</span><span class=p>(</span><span class=s1>&#39;.submit-row input&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=o>.</span><span class=n>click</span><span class=p>()</span>
</pre></div> <p>O código acima é simples e objetivo. Através do <em>decorator</em> <code>@given</code> associamos um determinado pedaço de código <em>Python</em> a um trecho das histórias escritas em <code>.feature</code>.</p> <p>Rodando o <code>behave</code>, teremos uma saída similar a essa:</p> <div class=highlight><pre><span></span>$ python manage.py behave

Creating <span class=nb>test</span> database <span class=k>for</span> <span class=nb>alias</span> <span class=s1>&#39;default&#39;</span>...
Feature: Logged in page <span class=c1># features/home-logada.feature:1</span>

  Scenario: Access index page      <span class=c1># features/home-logada.feature:3</span>
    Given an authenticated user    <span class=c1># features/steps/auth.py:5 0.646s</span>
    When I access the home page    <span class=c1># None</span>
    Then I see my username printed <span class=c1># None</span>
</pre></div> <p>O motor de testes, além de identificar e executar o trecho de código necessário para contemplar uma expressão, exibe o tempo de execução da mesma.</p> <h2>Quando alguma coisa acontece</h2> <p>Vamos para a parte onde o usuário interage com a aplicação.</p> <div class=highlight><pre><span></span><span class=c1># features/steps/actions.py</span>

<span class=kn>from</span> <span class=nn>behave</span> <span class=kn>import</span> <span class=n>when</span>


<span class=nd>@when</span><span class=p>(</span><span class=s1>&#39;I access the home page&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>access_the_home_page</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
    <span class=n>br</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>browser</span>
    <span class=n>br</span><span class=o>.</span><span class=n>visit</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>base_url</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span><span class=p>)</span>
</pre></div> <p>Aqui começa a ficar mais evidente o funcionamento de <em>steps</em>. Se amanhã eu precisar de um novo cenário onde é necessário acessar a página inicial, eu posso aproveitar o <code>when</code> criado acima. O <em>Behave</em> fará isso automaticamente para você... Portanto, organizar os <em>steps</em> de uma forma que eles agrupem um determinado grupo de ações é uma sugestão interessante.</p> <h2>Então eu espero algum resultado</h2> <p>E para finalizar o nosso exemplo, vamos para o <em>decorator</em> de <code>@then</code>, que é o passo onde validamos o resultado dos acontecimentos disparados por <code>@when</code>:</p> <div class=highlight><pre><span></span><span class=c1># features/steps/results.py</span>

<span class=kn>from</span> <span class=nn>behave</span> <span class=kn>import</span> <span class=n>then</span>


<span class=nd>@then</span><span class=p>(</span><span class=s1>&#39;I see my username printed&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>see_my_username</span><span class=p>(</span><span class=n>context</span><span class=p>):</span>
    <span class=n>br</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>browser</span>
    <span class=n>body</span> <span class=o>=</span> <span class=n>br</span><span class=o>.</span><span class=n>find_by_css</span><span class=p>(</span><span class=s1>&#39;body&#39;</span><span class=p>)</span>

    <span class=k>assert</span> <span class=s1>&#39;Hello test!&#39;</span> <span class=ow>in</span> <span class=n>body</span><span class=o>.</span><span class=n>text</span>
</pre></div> <p>Pronto! Executamos nossas <em>specs</em> e temos o seguinte resultado:</p> <div class=highlight><pre><span></span>$ python manage.py behave

Creating <span class=nb>test</span> database <span class=k>for</span> <span class=nb>alias</span> <span class=s1>&#39;default&#39;</span>...
Feature: Logged in page <span class=c1># features/home-logada.feature:1</span>

  Scenario: Access index page      <span class=c1># features/home-logada.feature:3</span>
    Given an authenticated user    <span class=c1># features/steps/auth.py:5 0.654s</span>
    When I access the home page    <span class=c1># features/steps/actions.py:4 0.888s</span>
    Then I see my username printed <span class=c1># features/steps/results.py:4 0.075s</span>

<span class=m>1</span> feature passed, <span class=m>0</span> failed, <span class=m>0</span> skipped
<span class=m>1</span> scenario passed, <span class=m>0</span> failed, <span class=m>0</span> skipped
<span class=m>3</span> steps passed, <span class=m>0</span> failed, <span class=m>0</span> skipped, <span class=m>0</span> undefined
Took 0m1.617s
Destroying <span class=nb>test</span> database <span class=k>for</span> <span class=nb>alias</span> <span class=s1>&#39;default&#39;</span>...
</pre></div> <p>Garantimos através dos cenários acima que, dado um usuário logado, imprimiremos o seu <em>username</em> na rota <code>http://localhost:8000/</code>.</p> <h2>Considerações finais</h2> <p>O <em>Behave</em> é uma ótima ferramenta de <em>BDD</em> para <em>Python</em>. Sua integração com o <em>Django</em> e demais <em>frameworks</em> é relativamente simples, o que só aumenta a simpatia pela ferramenta.</p> <p>Já sofri muito com escrita de testes de aceitação com <em>Django</em>. Não é um veredicto, mas até o momento o sentimento é extremamente positivo em relação ao casamento entre <em>Behave</em> e <em>Django</em>.</p> <p>Até a próxima!</p> <h2>Referências</h2> <ul> <li><a href=http://pythonhosted.org/behave/ ><em>Behave: Behavior-Driven Development, Python style</em></a></li> <li><a href=https://github.com/mixxorz/behave-django><em>GitHub: behave-django</em></a></li> <li><a href=https://splinter.readthedocs.org/en/latest/ ><em>Splinter: Tool for testing web applications using Python</em></a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/testes.html title="Leia mais sobre" class=Article-tagLink>testes</a> <a href=https://klauslaube.com.br/tag/bdd.html title="Leia mais sobre" class=Article-tagLink>bdd</a> <a href=https://klauslaube.com.br/tag/aceitacao.html title="Leia mais sobre" class=Article-tagLink>aceitação</a> <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre" class=Article-tagLink>python</a> <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre" class=Article-tagLink>django</a> <a href=https://klauslaube.com.br/tag/behave.html title="Leia mais sobre" class=Article-tagLink>behave</a> <a href=https://klauslaube.com.br/tag/splinter.html title="Leia mais sobre" class=Article-tagLink>splinter</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2016/02/03/bdd-com-django-e-behave.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>