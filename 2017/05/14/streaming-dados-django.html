<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>"Streamando" dados no Django | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="Embora o Django não seja a opção ideal para retornar grandes volumes de dados, ele proporciona algumas alternativas interessantes. Nesse artigo falaremos do StreamingHttpResponse, que vem embutido com o framework."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="desenvolvimento, web, python, django, streaming, generators, wsgi, csv"><meta property=og:title content streamando&quot; dados no django&quot;><meta property=og:description content="Embora o Django não seja a opção ideal para retornar grandes volumes de dados, ele proporciona algumas alternativas interessantes. Nesse artigo falaremos do StreamingHttpResponse, que vem embutido com o framework."><meta property=og:url content=https://klauslaube.com.br/2017/05/14/streaming-dados-django.html><meta property=og:image content=https://klauslaube.com.br//images/blog/biznis-cat.png><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2017/05/14/streaming-dados-django.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content=https://klauslaube.com.br//images/blog/biznis-cat.png> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> "Streamando" dados no Django </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2017-05-14T15:45:00-03:00 itemprop=datePublished>14 Mai, 2017</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/django-pony.png alt="Django Pony" class=representative-image width=180 height=180> <p>Recentemente na <a href=http://loadsmart.com/ title="Book a truck with Loadsmart"><em>Loadsmart</em></a>, houve a necessidade de lidar com um cenário onde se faz necessário acessar uma <em>view</em> que retorna um <em>CSV</em> de tamanho considerável, gerado a partir de parâmetros dinâmicos, no melhor esquema "imprima um relatório".</p> <!-- PELICAN_END_SUMMARY --> <p>Embora o <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre Django"><em>Django</em></a> seja desenhado para requisições curtas, existe a possibilidade de fazer <em>streaming</em> de grandes arquivos <em>CSVs</em> através da classe <code>StreamingHttpResponse</code>.</p> <p>Vale a nota: Esse artigo é sobre <em>CSVs</em>, mas você também pode <a href=http://stackoverflow.com/questions/30791228/serving-a-django-static-text-file title="Serving a django static text file">"streamar" outros tipos de dados</a> através desse método supimpa.</p> <h2>Motivação</h2> <p>Em determinados cenários, precisamos retornar arquivos relativamente grandes para o usuário. O exemplo acima, uma requisição com parâmetros que irão gerar um relatório em <em>CSV</em>, é um caso bem comum.</p> <p>O comportamento de resposta padrão do <em>Django</em> é retornar uma instância de <code>HttpResponse</code>. O problema é que nesse modo carregaremos o arquivo inteiro para a memória do servidor, e só depois enviamos o arquivo para o cliente. Além de prejudicarmos o <em>Time To First Byte</em> (TTBT), podemos gerar picos de memória na máquina hospedeira (que podem afetar demais requisições sendo processadas) e <em>timeouts</em> de conexão.</p> <p>Um exemplo de como faríamos esse retorno através do <code>HttpResponse</code>:</p> <div class=highlight><pre><span></span><span class=kn>import</span> <span class=nn>csv</span>
<span class=kn>from</span> <span class=nn>django.http</span> <span class=kn>import</span> <span class=n>HttpResponse</span>
<span class=kn>from</span> <span class=nn>django.view</span> <span class=kn>import</span> <span class=n>View</span>


<span class=k>class</span> <span class=nc>CsvReportView</span><span class=p>(</span><span class=n>View</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=c1># Abstraindo a logica de filtro por parametros do request</span>
        <span class=n>cargoes</span> <span class=o>=</span> <span class=n>Cargoes</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter_by_request_parms</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>

        <span class=n>response</span> <span class=o>=</span> <span class=n>HttpResponse</span><span class=p>(</span><span class=n>content_type</span><span class=o>=</span><span class=s1>&#39;text/csv&#39;</span><span class=p>)</span>
        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Content-Disposition&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;attachment; filename=&quot;filtered_cargoes.csv&quot;&#39;</span>

        <span class=n>writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cargoes</span><span class=o>.</span><span class=n>values_list</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;commodity&#39;</span><span class=p>,</span> <span class=s1>&#39;weight&#39;</span><span class=p>):</span>
            <span class=n>writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>(</span><span class=n>row</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>response</span>
</pre></div> <p>Se você tem certa intimidade com geradores, deve estar supondo que essa pode ser uma maneira de solucionar esse problema... e você está certo!</p> <h2>Como funciona o StreamingHttpResponse?</h2> <p>O <code>StreamingHttpResponse</code> funciona com a ajuda do conceito de <em>generators</em>. Achei uma excelente definição no <a href=http://stackoverflow.com/questions/1756096/understanding-generators-in-python title="Understanding Generators in Python"><em>Stackoverflow</em></a>:</p> <blockquote> <p>(...) is simply a function which returns an object on which you can call next, such that for every call it returns some value, until it raises a StopIteration exception, signaling that all values have been generated. Such an object is called an iterator.</p> </blockquote> <p><a href=https://www.slideshare.net/ramalho/iteraveis-e-geradores-em-python title="Iteraveis e geradores em Python">Leia mais sobre iteráveis e geradores</a>.</p> <p>Para tanto, o uso da palavra reservada <code>yield</code> se faz necessário. Logo, ao invés de termos o exemplo abaixo:</p> <div class=highlight><pre><span></span><span class=k>def</span> <span class=nf>my_view</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
    <span class=n>message</span> <span class=o>=</span> <span class=s1>&#39;Hello, there!&#39;</span>
    <span class=n>response</span> <span class=o>=</span>  <span class=n>HttpResponse</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
    <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Content-Length&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>response</span>
</pre></div> <p>Teremos:</p> <div class=highlight><pre><span></span><span class=k>def</span> <span class=nf>hello</span><span class=p>():</span>
    <span class=k>yield</span> <span class=s1>&#39;Hello,&#39;</span>
    <span class=k>yield</span> <span class=s1>&#39;there!&#39;</span>

<span class=k>def</span> <span class=nf>my_view</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
    <span class=k>return</span> <span class=n>StreamingHttpResponse</span><span class=p>(</span><span class=n>hello</span><span class=p>)</span>
</pre></div> <p><a href=https://andrewbrookins.com/django/how-does-djangos-streaminghttpresponse-work-exactly/ title="How does Django’s StreamingHttpResponse work, exactly">Leia mais no excelente "How does Django's StreamingHttpResponse work, exactly?"</a>.</p> <p>Voltando ao exemplo do <em>CSV</em>, teremos:</p> <div class=highlight><pre><span></span><span class=kn>import</span> <span class=nn>csv</span>
<span class=kn>from</span> <span class=nn>django.db</span> <span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span> <span class=nn>django.http</span> <span class=kn>import</span> <span class=n>StreamingHttpResponse</span>
<span class=kn>from</span> <span class=nn>django.views.generic</span> <span class=kn>import</span> <span class=n>View</span>

<span class=k>class</span> <span class=nc>Echo</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Interface parecida com a que usamos para escrever arquivos.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span> <span class=nf>write</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>value</span>


<span class=k>class</span> <span class=nc>CsvReportView</span><span class=p>(</span><span class=n>View</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
        <span class=c1># Abstraindo a logica de filtro por parametros do request</span>
        <span class=n>cargoes</span> <span class=o>=</span> <span class=n>Cargoes</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter_by_request_parms</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>

        <span class=c1># Usamos a mesma interface de buffer utilizada para escrever</span>
        <span class=c1># um arquivo. No entanto, apenas damos um `return value`</span>
        <span class=c1># aos inves de persistirmos o valor</span>
        <span class=n>pseudo_buffer</span> <span class=o>=</span> <span class=n>Echo</span><span class=p>()</span>
        <span class=n>writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>pseudo_buffer</span><span class=p>)</span>

        <span class=c1># Construimos o nosso gerador</span>
        <span class=n>gen_func</span> <span class=o>=</span> <span class=p>(</span><span class=n>writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>(</span><span class=n>row</span><span class=p>)</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cargos</span><span class=o>.</span><span class=n>values_list</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;commodity&#39;</span><span class=p>,</span> <span class=s1>&#39;weight&#39;</span><span class=p>))</span>

        <span class=n>response</span> <span class=o>=</span> <span class=n>StreamingHttpResponse</span><span class=p>(</span><span class=n>gen_func</span><span class=p>,</span> <span class=n>content_type</span><span class=o>=</span><span class=s1>&#39;text/csv&#39;</span><span class=p>)</span>
        <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Content-Disposition&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;attachment;filename=&quot;filtered_cargoes.csv&quot;&#39;</span>

        <span class=k>return</span> <span class=n>response</span>
</pre></div> <p>Antes mesmo de termos todo o <em>CSV</em> montado, já estamos retornando dados ao usuário.</p> <p><a href=https://docs.djangoproject.com/en/1.11/howto/outputting-csv/#streaming-large-csv-files title="Leia mais na documentação do Django">Veja o exemplo da documentação ofical do <em>Django</em></a>.</p> <h2>É a melhor maneira de resolver esse problema?</h2> <p>Caso a sua única opção seja retornar o dado através de uma <em>view</em> <em>Django</em>, sim. Além de um uso mais eficiente de memória, o retorno do <code>StreamingHttpResponse</code> vai impedir que, por exemplo, um <em>load balancer</em> feche a conexão do seu usuário pelo fato de o serviço <em>Django</em> estar levando muito tempo para montar a resposta.</p> <p><img class=align-center-keep-size src=/images/blog/biznis-cat.png width=610 height=259 title="O Django com StreamingHttpResponse fica mais biznis (thelegomovie.wikia.com)" alt="O Django com StreamingHttpResponse fica mais biznis (thelegomovie.wikia.com)"></p> <p>Mas segundo a recomendação da <a href=https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.StreamingHttpResponse title="Veja mais na documentação do Django">própria documentação</a> do <code>StreamingHttpResponse</code>, já que essa é uma "operação bloqueante", o ideal seria realizá-la em um <em>background job</em> (por exemplo) e deixar com que o usuário acesse essa informação quando ela já estiver pronta.</p> <p>O <code>django-report-builder</code> entrega essa <a href=https://django-report-builder.readthedocs.io/en/latest/quickstart/#asynchronous-report-generation title="Leia mais na documentação da biblioteca">modalidade de "asynchronous reports"</a> através do <a href=http://www.celeryproject.org/ title="Celery: Distributed Task Queue"><em>Celery</em></a>.</p> <h2>Considerações finais</h2> <p>É fato que a "mágica pesada" fica no lado do <a href=https://klauslaube.com.br/tag/wsgi.html title="Leia mais sobre WSGI"><em>WSGI</em></a>, como você pode ver <a href=https://andrewbrookins.com/django/how-does-djangos-streaminghttpresponse-work-exactly/#the-wsgi-server title="How does Django’s StreamingHttpResponse work, exactly?">aqui</a>. O <em>Django</em> "faz o que pode" quando o assunto é lidar com grandes volumes de dados. Mas o ideal é sempre deixar essa carga de processamento fora do ciclo de vida da requisição do usuário.</p> <p>Mesmo assim, o <code>StreamingHttpResponse</code> vem como uma boa alternativa para resolver alguns problemas de <em>views</em> com tempos de resposta e consumo de recursos muito altos, podendo ser a solução ideal para alguns relatórios que você emite em sua aplicação.</p> <p>Até a próxima.</p> <h2>Referências</h2> <ul> <li><a href=http://blog.aeguana.com/2015/12/12/csv-export-data-for-django-model/ ><em>Aeguana - How to export data as a CSV – Django model</em></a></li> <li><a href=https://andrewbrookins.com/django/how-does-djangos-streaminghttpresponse-work-exactly/ ><em>Andrew Brookins - How does Django's StreamingHttpResponse work, exactly?</em></a></li> <li><a href=https://docs.djangoproject.com/en/1.11/ref/request-response/#streaminghttpresponse-objects><em>Django Documentation - StreamingHttpResponse</em></a></li> <li><a href=http://www.ericcarmichael.com/streaming-django-responses-on-heroku.html><em>nerdery - Streaming Django responses on Heroku</em></a></li> <li><a href=http://www.rodvdka.co.za/heroku/long-polling/h12/h18/django/2016/10/13/long-polling-heroku.html><em>rodvdka - Django long running report on Django</em></a></li> <li><a href=http://stackoverflow.com/questions/33208849/python-django-streaming-video-mp4-file-using-httpresponse><em>Stackoverflow - Streaming video/mp4 file using HttpResponse</em></a></li> <li><a href=http://stackoverflow.com/questions/1756096/understanding-generators-in-python><em>Stackoverflow - Understanding Generators in Python</em></a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/desenvolvimento.html title="Leia mais sobre" class=Article-tagLink>desenvolvimento</a> <a href=https://klauslaube.com.br/tag/web.html title="Leia mais sobre" class=Article-tagLink>web</a> <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre" class=Article-tagLink>python</a> <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre" class=Article-tagLink>django</a> <a href=https://klauslaube.com.br/tag/streaming.html title="Leia mais sobre" class=Article-tagLink>streaming</a> <a href=https://klauslaube.com.br/tag/generators.html title="Leia mais sobre" class=Article-tagLink>generators</a> <a href=https://klauslaube.com.br/tag/wsgi.html title="Leia mais sobre" class=Article-tagLink>wsgi</a> <a href=https://klauslaube.com.br/tag/csv.html title="Leia mais sobre" class=Article-tagLink>csv</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2017/05/14/streaming-dados-django.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>