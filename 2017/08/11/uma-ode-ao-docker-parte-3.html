<!DOCTYPE html><html lang=pt-br> <head><meta charset=utf-8><title>Uma ode ao Docker - Parte 3 | Klaus Laube</title><meta name=author content="Klaus Peter Laube"><meta name=description content="Na última parte da série, vamos falar sobre o Dockerfile e ver como empacotar uma aplicação Django de forma simples e rápida."><meta name=robots content=index,follow><meta property=og:site_name content="Klaus Laube"><meta property=og:type content=website><meta name=keywords content="infraestrutura, virtualizacao, containerizacao, docker, nginx, python, django"><meta property=og:title content="Uma ode ao Docker - Parte 3"><meta property=og:description content="Na última parte da série, vamos falar sobre o Dockerfile e ver como empacotar uma aplicação Django de forma simples e rápida."><meta property=og:url content=https://klauslaube.com.br/2017/08/11/uma-ode-ao-docker-parte-3.html><meta property=og:image content=https://klauslaube.com.br//images/blog/django-it-worked.png><meta property=fb:app_id content=262757647133878><meta name=google-site-verification content=xCq0H3B3JhkPcAdZ03J0vayijvH_g1rQVMZ_DVcMsQY><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=icon type=image/x-icon href=https://klauslaube.com.br/favicon.ico><link rel=alternate type=application/rss+xml title="Klaus Laube » Feed" href=https://klauslaube.com.br/feed/rss.xml><link rel=canonical href=https://klauslaube.com.br/2017/08/11/uma-ode-ao-docker-parte-3.html><link rel=stylesheet href=https://unpkg.com/purecss@1.0.0/build/pure-min.css integrity=sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w crossorigin=anonymous><link rel=stylesheet href=https://klauslaube.com.br/theme/css/styles.min.css?0830b1e2></head> <body> <div class="Page pure-g is-fullEntry"> <div class="PageHeader pure-u-1"> <nav class="pure-menu pure-menu-open pure-menu-horizontal"> <a href=https://klauslaube.com.br/index.html title="Home page" class="PageHeader-link pure-menu-heading pure-menu-link">Klaus<span class=u-highlighted>Laube</a> <ul class="PageHeader-menu pure-menu-list"> <li class=pure-menu-item> <a href=https://about.me/klauslaube class="PageHeader-menu-link pure-menu-link">Contato</a> </li> </ul> </nav> </div> <div class="PageContent pure-u-1"> <article class="Article u-box" itemscope itemtype=http://schema.org/BlogPosting> <div itemprop=image itemscope itemtype=http://schema.org/ImageObject> <meta itemprop=url content=https://klauslaube.com.br//images/blog/django-it-worked.png> </div> <span itemprop=mainEntityOfPage> <header> <h1 class=Article-title itemprop="headline name"> Uma ode ao Docker - Parte 3 </h1> <p class=Article-meta> Por <span class=Article-author itemprop=author>Klaus Peter Laube</span>. <span class=Article-pubDate> Publicado em <time datetime=2017-08-11T18:00:00-03:00 itemprop=datePublished>11 Ago, 2017</time> </span> </p> </header> <div class=Article-content itemprop=articleBody> <img src=/images/blog/docker-logo-3.jpg alt="Logotipo do Docker" class=representative-image width=180 height=180> <p>Nos <a href=https://klauslaube.com.br/2017/01/14/uma-ode-ao-docker-parte-1.html title="Uma ode ao Docker - Parte 1"><em>posts</em></a> <a href=https://klauslaube.com.br/2017/05/01/uma-ode-ao-docker-parte-2.html title="Uma ode ao Docker - Parte 2">anteriores</a> arranhamos um pouco o conceito por trás do <a href=https://klauslaube.com.br/tag/docker.html title="Leia mais sobre Docker"><em>Docker</em></a>, bem como introduzimos o utilitário de linha de comando <code>docker</code>. Nesse último artigo da série, vamos explorar como usar o <em>Dockerfile</em> no empacotamento de uma aplicação <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre Django"><em>Django</em></a>.</p> <!-- PELICAN_END_SUMMARY --> <p>Se você ainda tem dúvidas em como "encaixar" o <em>Docker</em> no seu fluxo de desenvolvimento, o artigo <a href=http://www.patricksoftwareblog.com/why-i-switched-from-a-traditional-deployment-to-using-docker/ title="Leia na íntegra">"Why I Switched from a Traditional Deployment to Using Docker"</a> pode ser uma boa leitura.</p> <h2>Configurando a aplicação Django</h2> <p>Vamos configurar uma aplicação de exemplo para sermos capazes de dar os passos necessários na criação do <code>Dockerfile</code>. Primeiramente, vamos criar <em><a href=https://klauslaube.com.br/tag/virtualenv.html title="Leia mais sobre virtualenv">virtualenv</a> Python</em> com <a href=https://klauslaube.com.br/tag/pyenv.html title="Leia mais sobre Pyenv"><em>pyenv</em></a>:</p> <div class=highlight><pre><span></span>$ pyenv virtualenv <span class=m>3</span>.6.1 helloworld-django-docker
</pre></div> <p>Criamos o diretório para o projeto:</p> <div class=highlight><pre><span></span>$ mkdir ~/Workspace/helloworld
$ <span class=nb>cd</span> ~/Workspace/helloworld/
</pre></div> <p>Ativamos o <em>virtualenv</em>:</p> <div class=highlight><pre><span></span>$ pyenv activate helloworld-django-docker
</pre></div> <p>Instalamos as dependências <em>Django</em> e iniciamos o projeto:</p> <div class=highlight><pre><span></span>$ pip install django gunicorn
<span class=o>(</span>...<span class=o>)</span>

$ pip freeze &gt; requirements.txt
$ django-admin startproject helloworld ~/Workspace/helloworld
</pre></div> <p>Rodamos o <code>python manage.py runserver</code> só para termos certeza que está tudo ok:</p> <p><img class=align-center-keep-size src=/images/blog/django-it-worked.png width=680 height=131 title="It worked" alt="It worked"></p> <p>Além disso, garantimos que o <code>gunicorn</code> rodará sem maiores problemas:</p> <div class=highlight><pre><span></span>$ gunicorn helloworld.wsgi:application <span class=se>\</span>
    --bind <span class=m>0</span>.0.0.0:8000 <span class=se>\</span>
    --workers <span class=m>3</span>
</pre></div> <p>Para saber mais sobre o <em>Gunicorn</em>, leia a <a href=http://docs.gunicorn.org/en/stable/design.html title="Documentação do Gunicorn">documentação oficial</a> do projeto.</p> <h2>Entra o Dockerfile</h2> <p>Com o <a href=https://docs.docker.com/engine/installation/ title="Instalando o Docker"><em>Docker</em> instalado</a>, vamos começar a escrever o <code>Dockerfile</code>. O <a href=http://www.mundodocker.com.br/o-que-e-dockerfile/ title="O que é o Dockerfile"><em>Mundo Docker</em></a> define o arquivo como:</p> <blockquote> <p>(...) um arquivo de definição onde é possível realizar ou preparar todo ambiente a partir de um script de execução. Em resumo, o Dockerfile é um arquivo texto com instruções, comandos e passos que você executaria manualmente, basicamente o Docker executa uma receita de bolo.</p> </blockquote> <p>É nesse arquivo que escreveremos todos os procedimentos que o <em>Docker</em> executará para criar a imagem da nossa aplicação.</p> <h3>Por partes, como diria Jack</h3> <p>Começamos especificando qual será a "imagem base" da nossa imagem/<em>container</em>. Faremos isso através da expressão <code>FROM</code>. Poderíamos dizer aqui que queremos estender a imagem <a href=https://hub.docker.com/_/debian/ title="Imagem Debian no Dockerhub">_/debian</a> e realizar toda a instalação do <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre Python"><em>Python</em></a>. Mas felizmente já existem imagens prontas com a linguagem no <em>Docker Hub</em>. Vamos com a <a href=https://hub.docker.com/_/python/ title="Imagem Python no Docker Hub">imagem oficial</a> como base:</p> <div class=highlight><pre><span></span><span class=c># Dockerfile</span>

<span class=k>FROM</span><span class=s> python:3</span>
</pre></div> <p>Quando "buildarmos", o <em>Docker</em> baixará a imagem do <em>Python</em> do repositório (se ela já não existir localmente em sua máquina), e dará sequência às instruções encontradas no <code>Dockerfile</code>.</p> <p>Uma boa prática é "fecharmos o escopo" de trabalho ao setar explicitamente qual será o diretório no qual iremos realizar demais operações como cópia de arquivos ou execução de binários. Para isso temos o comando <code>WORKDIR</code>:</p> <div class=highlight><pre><span></span><span class=k>FROM</span><span class=s> python:3</span>

<span class=k>WORKDIR</span><span class=s> /usr/src/app</span>
</pre></div> <p>Agora podemos instalar o <em>Django</em> e o <em>Gunicorn</em>, assim como fizemos no início desse artigo:</p> <div class=highlight><pre><span></span><span class=k>FROM</span><span class=s> python:3</span>

<span class=k>WORKDIR</span><span class=s> /usr/src/app</span>

<span class=k>COPY</span> requirements.txt ./
<span class=k>RUN</span> pip install -r requirements.txt
</pre></div> <p>Você já deve ter reparado um padrão na escrita do <code>Dockerfile</code>, certo? Os comandos (em maiúsculo) determinam qual operação será realizada. Os parâmetros (em minúsculo) determinam como isso irá ocorrer.</p> <p><img class=align-center-keep-size src=/images/blog/docker-dory-whale.jpg width=640 height=320 title="Escrever Dockerfile é tipo falar baleiês (insidethemagic.net)" alt="Escrever Dockerfile é tipo falar baleiês (insidethemagic.net)"></p> <p>No caso do comando <code>COPY</code>, passamos o arquivo <code>requirements.txt</code> da nossa "máquina local" para o <em>container</em>, assim o <em>Docker</em> será capaz de encontrar o arquivo e realizar a instalação das dependências através do comando <code>pip</code>.</p> <p>Para finalizar, podemos copiar o resto do projeto e executar o servidor <em>WSGI</em>:</p> <div class=highlight><pre><span></span><span class=k>FROM</span><span class=s> python:3</span>

<span class=k>WORKDIR</span><span class=s> /usr/src/app</span>

<span class=k>COPY</span> requirements.txt ./
<span class=k>RUN</span> pip install -r requirements.txt

<span class=k>COPY</span> . .

<span class=k>CMD</span> <span class=p>[</span><span class=s2>&quot;gunicorn&quot;</span><span class=p>,</span> <span class=s2>&quot;helloworld.wsgi:application&quot;</span><span class=p>,</span> <span class=s2>&quot;--bind=0.0.0.0:8000&quot;</span><span class=p>,</span> <span class=s2>&quot;--workers=3&quot;</span><span class=p>]</span>
</pre></div> <p>Comandos <code>RUN</code> serão executados em tempo de <em>build</em>. São essenciais para a construção do ambiente, e são responsáveis pelos "layers" discutidos nos <em>posts</em> anteriores. Portanto é bem comum vermos comandos como <code>RUN apt-get dist-upgrade -y</code>. Já o <code>CMD</code> será executado no momento que a sua imagem for executada.</p> <p><a href=http://goinbigdata.com/docker-run-vs-cmd-vs-entrypoint/ title="Docker RUN vs CMD vs ENTRYPOINT">Diferença entre <code>RUN</code>, <code>CMD</code> e <code>ENTRYPONT</code></a>.</p> <p>E se você está se perguntando o motivo de termos dois <code>COPY</code>, essa prática é útil para o mecanismo de <em>caching</em> do <em>Docker</em> e invalidação do mesmo, como pode ser visto no <a href=https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#add-or-copy title="Dockerfile best practices">guia de boas práticas</a>.</p> <h3>"Build" é quase BIRL!</h3> <p>Hora de "buildar"! Execute o seguinte comando:</p> <div class=highlight><pre><span></span>$ docker build -t &lt;docker-hub-user&gt;/helloworld-django-docker .
</pre></div> <p>Onde:</p> <ul> <li><code>build</code>: É o comando para criar uma imagem <em>Docker</em> a partir de um <em>Dockerfile</em>;</li> <li><code>-t</code>: O parâmetro <code>-t</code> é utilizado para nomear e tagear a imagem em questão. É interessante usar o padrão <code>&lt;usuario-ou-repositorio&gt;/nome-da-imagem</code>;</li> <li><code>.</code>: O caminho onde encontra-se o <em>Dockerfile</em>.</li> </ul> <p>Se tudo der certo, será possível listar a imagem recém criada:</p> <div class=highlight><pre><span></span>$ docker images

REPOSITORY                         TAG    IMAGE ID
kplaube/helloworld-django-docker   latest b8d3b0c234a9
</pre></div> <p>Agora sim seremos capazes de executar a aplicação <em>Django</em> através de um <em>container</em>:</p> <div class=highlight><pre><span></span>$ docker run -it -p <span class=m>8000</span>:8000 &lt;docker-hub-user&gt;/helloworld-django-docker
</pre></div> <p>E mais uma vez seremos capazes de ver o "It worked!" em <code>http://localhost:8000</code>.</p> <p>Belezura! Uma vez que a imagem esteja ok, podemos publicá-la no <em>Docker Hub</em> (afinal, propaganda é a alma do negócio):</p> <div class=highlight><pre><span></span>$ docker push &lt;docker-hub-user&gt;/helloworld-django-docker
</pre></div> <p>E... <em>voilá</em>! A imagem foi publicada no <a href=https://hub.docker.com/r/kplaube/helloworld-django-docker/ ><em>Docker Hub</em></a>.</p> <h3>Antes de ir: Efêmero</h3> <p>Nos <em>posts</em> anteriores demos uma pincelada numa das características dos <em>containers</em> que é a sua "efemeridade". Isso significa que, a cada nova versão da sua <em>app Django</em> você terá que "buildar" uma nova versão da imagem <em>Docker</em>. A boa notícia é que com o mecanismo de <em>caching</em> do <em>Docker</em> essa operação deverá ser ligeiramente mais rápida do que da primeira vez.</p> <p>Além disso, mesmo que você tenha uma leve camada de escrita ao executar um <em>container</em>, a informação será perdida ao parar/reiniciar o mesmo. Portanto, o uso de <a href=https://docs.docker.com/engine/admin/volumes/volumes/ title="Use volumes"><em>Docker Volumes</em></a> é essencial quando se faz necessária a persistência de dados.</p> <h2>Considerações finais</h2> <p>Com esse <em>post</em> fechamos essa pequena ode ao <em>Docker</em>. Sem dúvida, uma ferramenta que vem mudando paradigmas (o mais recente deles com o <a href=https://www.opencontainers.org/announcement/2017/07/19/open-container-initiative-oci-releases-v1-0-of-container-standards title="Open Container Initiative (OCI) Releases v1.0 of Container Standards">lançamento da versão 1.0</a> do <em>Container Standards</em>).</p> <p>Pretendo abordar mais sobre <em>Docker</em> aqui no <em>blog</em>, principalmente detalhando melhor o uso do mesmo no <a href=https://klauslaube.com.br/tag/deploy.html title="Leia mais sobre deploy"><em>deploy</em></a> de aplicações <em>Django</em>. Com a adoção de conteinerização por serviços <em>PaaS</em> como <em>Heroku</em> e <em>Openshift</em>, há muito assunto a ser explorado nessa seara.</p> <p>Até a próxima!</p> <h2>Referências</h2> <ul> <li><a href=https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/ >Docker Docs - Best practices for writing Dockerfiles</a></li> <li><a href=http://flaviosilveira.com/2017/criando-seu-container-com-dockerfile/ >Flavio Silveira - Criando Seu Container Com Dockerfile</a></li> <li><a href=http://www.mundodocker.com.br/o-que-e-dockerfile/ >Mundo Docker - O que é Dockerfile</a></li> <li><a href=http://www.patricksoftwareblog.com/how-to-use-docker-and-docker-compose-to-create-a-flask-application/ >Patrick's Software Blog - How to use Docker and Docker Compose to Create a Flask Application</a></li> <li><a href=https://semaphoreci.com/community/tutorials/dockerizing-a-python-django-web-application>Semaphore - Dockerizing a Python Django web Application</a></li> </ul> </div> </span> <div class=Article-tags> <span class=Article-tagLabel>Tags:</span> <span itemprop=keywords> <a href=https://klauslaube.com.br/tag/infraestrutura.html title="Leia mais sobre" class=Article-tagLink>infraestrutura</a> <a href=https://klauslaube.com.br/tag/virtualizacao.html title="Leia mais sobre" class=Article-tagLink>virtualizacao</a> <a href=https://klauslaube.com.br/tag/containerizacao.html title="Leia mais sobre" class=Article-tagLink>containerizacao</a> <a href=https://klauslaube.com.br/tag/docker.html title="Leia mais sobre" class=Article-tagLink>docker</a> <a href=https://klauslaube.com.br/tag/nginx.html title="Leia mais sobre" class=Article-tagLink>nginx</a> <a href=https://klauslaube.com.br/tag/python.html title="Leia mais sobre" class=Article-tagLink>python</a> <a href=https://klauslaube.com.br/tag/django.html title="Leia mais sobre" class=Article-tagLink>django</a> </span> </div> <div class=Article-comments> <div id=disqus_thread></div> <script type=text/javascript>
        var disqus_shortname = "klauslaube";
        var disqus_identifier = "2017/08/11/uma-ode-ao-docker-parte-3.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript> </div> </article> </div> <footer class="PageFooter pure-u-1"> <div class=u-box> <p>O conteúdo deste blog está sob a licença <a class=PageFooter-link href=http://creativecommons.org/licenses/by/3.0/deed.pt_BR title="Distribua, adapte, use. Mas mencione o autor." rel=nofollow>Creative Commons Attribution 3.0</a>.</p> <p>O código está disponível em <a class=PageFooter-link href=https://github.com/kplaube/blog/ title=Contribute! rel=nofollow>GitHub</a>.</p> </div> </footer> </div> <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-19657400-1');ga('send','pageview');
    </script> </body> </html>